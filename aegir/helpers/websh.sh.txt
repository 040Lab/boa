#!/bin/bash

PATH=/usr/local/bin:/usr/bin:/bin
SHELL=/bin/bash
_ALL="$@"
_LTD_GID=$(id -nG $USER)
_INTERNAL=NO
_X_USR=".*"
_Y_USR=${USER%${_X_USR}}

# Check PHP CLI version defined.
check_php_cli_version () {
  if [ -e "/data/disk/$_Y_USR/static/control/cli.info" ] ; then
    _PHP_CLI_VERSION=`cat /data/disk/$_Y_USR/static/control/cli.info`
    _PHP_CLI_VERSION=`echo -n $_PHP_CLI_VERSION | tr -d "\n"`
    if [ "$_PHP_CLI_VERSION" = "5.5" ] || [ "$_PHP_CLI_VERSION" = "5.4" ] || [ "$_PHP_CLI_VERSION" = "5.3" ] || [ "$_PHP_CLI_VERSION" = "5.2" ]; then
      _PHP_CLI=$_PHP_CLI_VERSION
    fi
  else
    if [ -e "/data/disk/$_Y_USR/log/cli.txt" ] ; then
      _PHP_CLI_VERSION=`cat /data/disk/$_Y_USR/log/cli.txt`
      _PHP_CLI_VERSION=`echo -n $_PHP_CLI_VERSION | tr -d "\n"`
      if [ "$_PHP_CLI_VERSION" = "5.5" ] || [ "$_PHP_CLI_VERSION" = "5.4" ] || [ "$_PHP_CLI_VERSION" = "5.3" ] || [ "$_PHP_CLI_VERSION" = "5.2" ]; then
        _PHP_CLI=$_PHP_CLI_VERSION
      fi
    fi
  fi
  if [ "$_PHP_CLI" = "5.5" ] ; then
    DRUSH_PHP="/opt/php55/bin/php"
  elif [ "$_PHP_CLI" = "5.4" ] ; then
    DRUSH_PHP="/opt/php54/bin/php"
  elif [ "$_PHP_CLI" = "5.3" ] ; then
    DRUSH_PHP="/opt/php53/bin/php"
  elif [ "$_PHP_CLI" = "5.2" ] ; then
    DRUSH_PHP="/opt/php52/bin/php"
  else
    DRUSH_PHP=""
  fi
}

if [[ "$_LTD_GID" =~ "lshellg"($) ]] || [[ "$_LTD_GID" =~ "ltd-shell"($) ]] ; then
  if [ "$1" = "-c" ] ; then
    if [[ "$2" =~ "set -m;" ]] && [ "$0" = "/bin/sh" ] ; then
      _IN_PATH=YES
      _INTERNAL=YES
      _PWD=$(pwd)
      check_php_cli_version
      if [[ "$2" =~ "drush make" ]] || [[ "$2" =~ "drush6 make" ]] || [[ "$2" =~ "drush7 make" ]] ; then
        if [[ "$_PWD" =~ "/static" ]] ; then
          _CORRECT=YES
        else
          if [[ "$2" =~ "make-generate" ]] && [ -f "$_PWD/settings.php" ] ; then
            _CORRECT=YES
          else
            echo
            echo " This drush command can not be run in $_PWD"
            if [[ "$2" =~ "make-generate" ]] ; then
              echo " Please cd to the valid sites/foo.com directory first"
            else
              echo " Please cd ~/static first"
            fi
            echo
            exit 0
          fi
        fi
      else
        if [[ "$2" =~ "drush" ]] && [ ! -f "$_PWD/settings.php" ] ; then
          echo
          echo " This drush command can not be run in $_PWD"
          echo " Please cd to the valid sites/foo.com directory first"
          echo
          exit 0
        elif [[ "$2" =~ "drush" ]] && [ -f "$_PWD/settings.php" ] ; then
          _CORRECT=YES
        fi
      fi
    else
      if [[ "$2" =~ (^)"/usr/" ]] || [[ "$2" =~ (^)"/bin/" ]] ; then
        _IN_PATH=YES
      else
        _WHICH_TEST=$(which $2)
        if [[ "$_WHICH_TEST" =~ (^)"/usr/" ]] || [[ "$_WHICH_TEST" =~ (^)"/bin/" ]] ; then
          _IN_PATH=YES
        else
          _IN_PATH=NO
        fi
      fi
    fi
  else
    if [[ "$1" =~ (^)"/usr/" ]] || [[ "$1" =~ (^)"/bin/" ]] ; then
      _IN_PATH=YES
    else
      _WHICH_TEST=$(which $1)
      if [[ "$_WHICH_TEST" =~ (^)"/usr/" ]] || [[ "$_WHICH_TEST" =~ (^)"/bin/" ]] ; then
        _IN_PATH=YES
      else
        _IN_PATH=NO
      fi
    fi
  fi
  if [ "$_IN_PATH" = "YES" ] ; then
    if [ "$0" = "/bin/sh" ] || [ "$0" = "/bin/websh" ] ; then
      export DRUSH_PHP;exec /bin/bash "$@"
    else
      export DRUSH_PHP;exec $0 "$@"
    fi
    exit 0
  else
    exit 1
  fi
else
  if [ "$0" = "/bin/sh" ] || [ "$0" = "/bin/websh" ] ; then
    exec /bin/bash "$@"
  else
    exec $0 "$@"
  fi
  exit 0
fi
