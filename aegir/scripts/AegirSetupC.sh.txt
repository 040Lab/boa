#!/bin/bash


###----------------------------------------###
###
###  Octopus Aegir Installer
###
###  Copyright (C) 2010-2012 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: http://code.aegir.cc/aegir
###
###----------------------------------------###


###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###

_INSTALLER_VERSION=EDIT_INSTALLER_VERSION


###---### distro config
#
_CIVICRM_M6=EDIT_CIVICRM_M6
_CIVICRM_M7=EDIT_CIVICRM_M7
_CIVICRM6=EDIT_CIVICRM6
_CIVICRM7=EDIT_CIVICRM7
_COD=EDIT_COD
_COMMERCE=EDIT_COMMERCE
_COMMONS=EDIT_COMMONS
_DRUPAL5=EDIT_DRUPAL5
_DRUPAL7=EDIT_DRUPAL7
_DRUPAL7D="EDIT_DRUPAL7-dev"
_DRUPAL7P="EDIT_DRUPAL7-prod"
_DRUPAL7S="EDIT_DRUPAL7-stage"
_DRUPAL8=EDIT_DRUPAL8
_ELMS=EDIT_ELMS
_MANAGINGNEWS=EDIT_MANAGINGNEWS
_MARTPLUG=EDIT_MARTPLUG
_NODESTREAM6=EDIT_NODESTREAM6
_NODESTREAM7=EDIT_NODESTREAM7
_OCTOPUS_VIDEO=EDIT_OCTOPUS_VIDEO
_OPENATRIUM=EDIT_OPENATRIUM
_OPENCHURCH=EDIT_OPENCHURCH
_OPENDEALS=EDIT_OPENDEALS
_OPENENTERPRISE=EDIT_OPENENTERPRISE
_OPENOUTREACH=EDIT_OPENOUTREACH
_OPENPUBLIC=EDIT_OPENPUBLIC
_OPENPUBLISH=EDIT_OPENPUBLISH
_OPENSCHOLAR=EDIT_OPENSCHOLAR
_PANOPOLY=EDIT_PANOPOLY
_PROSEPOINT=EDIT_PROSEPOINT
_SMALLCORE_6_LANG=EDIT_SMALLCORE_6_LANG
_SMALLCORE6=EDIT_SMALLCORE6
_SMALLCORE7=EDIT_SMALLCORE7
_SMALLCORE8=EDIT_SMALLCORE8
_UBER_CART_SEVEN=EDIT_UBER_CART_SEVEN
_UBERCART=EDIT_UBERCART
_VIDEOLA=EDIT_VIDEOLA


###---### main config
#
_AEGIR_VERSION=EDIT_AEGIR_VERSION
_ALL_DISTRO=EDIT_ALL_DISTRO
_AUTOPILOT=EDIT_AUTOPILOT
_BOA_REPO_GIT_URL=EDIT_BOA_REPO_GIT_URL
_BOA_REPO_NAME=EDIT_BOA_REPO_NAME
_CLIENT_CORES=EDIT_CLIENT_CORES
_CLIENT_OPTION=EDIT_CLIENT_OPTION
_DEBUG_MODE=EDIT_DEBUG_MODE
_DISTRO=EDIT_DISTRO
_DOMAIN=EDIT_DOMAIN
_DRUSH_FAMILY=EDIT_DRUSH_FAMILY
_DRUSH_VERSION=EDIT_DRUSH_VERSION
_HM_DISTRO=EDIT_HM_DISTRO
_HM_ONLY=EDIT_HM_ONLY
_HOT_SAUCE=EDIT_HOT_SAUCE
_LAST_ALL=EDIT_LAST_ALL
_LAST_HMR=EDIT_LAST_HMR
_LASTNUM=EDIT_LASTNUM
_NOW=EDIT_NOW
_O_CONTRIB_UP=EDIT_O_CONTRIB_UP
_PHP_CLI_VERSION=EDIT_PHP_CLI_VERSION
_PHP_FPM_VERSION=EDIT_PHP_FPM_VERSION
_PHP_MODERN_ONLY=EDIT_PHP_MODERN_ONLY
_PLATFORMS_LIST="EDIT_PLATFORMS_LIST"
_PURGE_FOR_SEVEN=EDIT_PURGE_FOR_SEVEN
_PURGE_MODE=EDIT_PURGE_MODE
_SRCDIR=/opt/tmp/files
_SPINNER=EDIT_SPINNER
_STATUS=INIT
_THIS_DB_HOST=EDIT_THIS_DB_HOST
_TODAY=`date +%y%m%d`
_USE_CURRENT=EDIT_USE_CURRENT
_WEBG=EDIT_WEBG
#
_USER=EDIT_USER
_ROOT="/data/disk/$_USER"
_AEGIR_ROOT="$_ROOT/aegir/distro/$_HM_DISTRO"
_PREV_AEGIR_ROOT="$_ROOT/aegir/distro/$_LAST_HMR"
_LOG=/var/backups/octopus-$_USER-$_NOW.log
#
if [ "$_PHP_CLI_VERSION" = "5.3" ] && [ -x "/opt/local/bin/php" ] ; then
  _L_PHP_CLI=/opt/local/bin
else
  _L_PHP_CLI=/usr/local/bin
fi
if [ "$_PHP_FPM_VERSION" = "5.3" ] || [ "$_PHP_CLI_VERSION" = "5.3" ] ; then
  _D_5_ALLOW=NO
else
  _D_5_ALLOW=YES
fi
if [ "$_PHP_FPM_VERSION" = "5.3" ] && [ "$_PHP_CLI_VERSION" = "5.3" ] ; then
  _D_8_ALLOW=YES
else
  _D_8_ALLOW=NO
fi
_DRUSHCMD="$_L_PHP_CLI/php $_ROOT/tools/drush/drush.php"
#
SHELL=/bin/bash
PATH=$_L_PHP_CLI:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin


###---### Functions
#
# noticeable messages
msg () {
  echo "Octopus [`date`] ==> $*"
}
#
# Simple prompt
prompt_yes_no () {
if [ "$_AUTOPILOT" = "YES" ]; then
  return 0
else
  while true ; do
    printf "$* [Y/n] "
    read answer
    if [ -z "$answer" ] ; then
      return 0
    fi
    case $answer in
      [Yy]|[Yy][Ee][Ss])
        return 0
        ;;
      [Nn]|[Nn][Oo])
        return 1
        ;;
      *)
        echo "Please answer yes or no"
        ;;
    esac
 done
fi
}
#
# Success msg
success () {
	msg "$1 Succeeded"
}
#
# Error msg
fatal () {
	echo " "
	msg "Fatal Error Occurred: $1"
	msg "Cannot continue installation"
	touch /opt/tmp/status-AegirSetupC-FAIL
	exit 1
}
#
# Perform an action, log it, and run the spinner throughout
runner () {
	CMD="$1"
	touch busy
	if [ "$_SPINNER" = "YES" ] ; then
	  bash $_SRCDIR/spinner busy &
	fi
	if $CMD >> $_LOG; then
		rm busy
		sleep 1
		success "$CMD:"
		return 0
	else
		rm busy
		sleep 1
		echo "$CMD failed.  Error (if any): $?"
		echo " "
		echo "Displaying the last 15 lines of $_LOG to help troubleshoot this problem:"
		tail -15 $_LOG
		return 1
	fi
}
#
# Small spinner
mrun () {
	CMD="$1"
	touch busy
	if [ "$_SPINNER" = "YES" ] ; then
	  bash $_SRCDIR/spinner busy &
	fi
	if $CMD >> $_LOG; then
		rm busy
		sleep 1
		return 0
	fi
}
#
# stop on error
# set -e ### disabled for debugging
#
# create standard directories
create_dirs () {
  cd $_CORE_DISTRO
  mkdir -p ./sites/default/files
  mkdir -p ./cache/{normal,perm,mobile-tablet,mobile-smart,mobile-other}
  chmod -R 777 ./cache &> /dev/null
  if [ -e "./sites/default/default.settings.php" ] ; then
    cp -af ./sites/default/default.settings.php ./sites/default/settings.php &> /dev/null
  fi
  chmod a+rw ./sites/default/settings.php &> /dev/null
  chmod a+rwx ./sites/default/files &> /dev/null
  mkdir -p ./sites/all/modules
  mkdir -p ./sites/all/libraries
  mkdir -p ./sites/all/themes
  rm -f ./modules/*.txt
  rm -f ./themes/*.txt
  rm -f ./sites/all/*.txt
  echo empty > ./sites/all/EMPTY.txt
  echo empty > ./sites/all/modules/EMPTY.txt
  echo empty > ./sites/all/libraries/EMPTY.txt
  echo empty > ./sites/all/themes/EMPTY.txt
  chmod 0751 ./sites &> /dev/null
  chmod 0751 ./sites/all &> /dev/null
  chmod 02775 ./sites/all/{modules,libraries,themes} &> /dev/null
  rm -f .htaccess
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/get.htaccess.txt ./
  mv -f get.htaccess.txt .htaccess &> /dev/null
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/crossdomain.xml ./
}
#
# create standard symlinks
create_symlinks () {
if [ ! -L "includes" ] ; then
  ln -s $_CORE_DISTRO/boost_stats.php boost_stats.php &> /dev/null
  ln -s $_CORE_DISTRO/cron.php cron.php &> /dev/null
  ln -s $_CORE_DISTRO/crossdomain.xml crossdomain.xml &> /dev/null
  ln -s $_CORE_DISTRO/.htaccess .htaccess &> /dev/null
  ln -s $_CORE_DISTRO/includes includes &> /dev/null
  ln -s $_CORE_DISTRO/index.php index.php &> /dev/null
  ln -s $_CORE_DISTRO/install.php install.php &> /dev/null
  ln -s $_CORE_DISTRO/misc misc &> /dev/null
  ln -s $_CORE_DISTRO/modules modules &> /dev/null
  ln -s $_CORE_DISTRO/profiles profiles &> /dev/null
  ln -s $_CORE_DISTRO/themes themes &> /dev/null
  ln -s $_CORE_DISTRO/update.php update.php &> /dev/null
  ln -s $_CORE_DISTRO/xmlrpc.php xmlrpc.php &> /dev/null
  cp -af $_CORE_DISTRO/cache ./
  cp -af $_CORE_DISTRO/sites ./
fi
}
#
# create d7 symlinks
create_d7_symlinks () {
if [ ! -L "web.config" ] ; then
  ln -s $_CORE_DISTRO/authorize.php authorize.php &> /dev/null
  ln -s $_CORE_DISTRO/web.config web.config &> /dev/null
fi
}
#
# patch d7 core
patch_d7_core () {
if [ ! -e "taxonomy-7.7.patch" ] ; then
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/taxonomy-7.7.patch ./
  patch -p1 < taxonomy-7.7.patch &> /dev/null
  rm -f taxonomy-7.7.patch
  rm -f boost_stats.php
fi
}
#
# themes_for_d6
themes_for_d6 () {
cd /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/themes
wget -q -U iCab http://ftp.drupal.org/files/projects/rubik-6.x-3.0-beta3.tar.gz
wget -q -U iCab http://ftp.drupal.org/files/projects/tao-6.x-3.3.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
cd /data/src/$_THIS_CORE
}
#
# themes_for_d7
themes_for_d7 () {
cd $_CORE_DISTRO/themes
wget -q -U iCab http://ftp.drupal.org/files/projects/rubik-7.x-4.0-beta8.tar.gz
wget -q -U iCab http://ftp.drupal.org/files/projects/tao-7.x-3.0-beta4.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
cd $_CORE_DISTRO
}
#
# prepare_pressflow_core
prepare_pressflow_core () {
  mkdir -p /data/src/$_THIS_CORE
  chmod 0700 /data/src/$_THIS_CORE &> /dev/null
  cd /data/src/$_THIS_CORE
  rm -f -r /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6
  wget -q -U iCab http://files.aegir.cc/dev/pressflow-$_SMALLCORE6.tar.gz
  tar -xzf pressflow-$_SMALLCORE6.tar.gz
  rm -f pressflow-$_SMALLCORE6.tar.gz
  cd /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/
  rm -f /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/*.txt
  rm -f /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/modules/*.txt
  rm -f -r /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/modules/cookie_cache_bypass
  rm -f /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/themes/*.txt
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/taxonomy-6.20.patch ./
  patch -p1 < taxonomy-6.20.patch &> /dev/null
  rm -f taxonomy-6.20.patch
  rm -f /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/modules/taxonomy/taxonomy.module.orig
  themes_for_d6
  rm -f /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/sites/all/*.txt
  echo abc > $_THIS_CTRL
  cd /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/
  cp -af $_CORE/o_contrib/boost/stats/boost_stats.php ./ &> /dev/null
  ln -s $_CORE/o_contrib modules/o_contrib
  cp -a $_CORE/o_contrib/image/image.imagemagick.inc includes/
}
#
# create standard D8 directories
create_d8_dirs () {
  mkdir -p ./sites/default/files
  mkdir -p ./cache/{normal,perm,mobile-tablet,mobile-smart,mobile-other}
  chmod -R 777 ./cache &> /dev/null
  if [ -e "./sites/default/default.settings.php" ] ; then
    cp -af ./sites/default/default.settings.php ./sites/default/settings.php &> /dev/null
  fi
  chmod a+rw ./sites/default/settings.php &> /dev/null
  chmod a+rwx ./sites/default/files &> /dev/null
  mkdir -p ./sites/all/modules
  mkdir -p ./sites/all/libraries
  mkdir -p ./sites/all/themes
  rm -f ./core/modules/*.txt
  rm -f ./core/themes/*.txt
  rm -f ./sites/all/*.txt
  echo empty > ./sites/all/EMPTY.txt
  echo empty > ./sites/all/modules/EMPTY.txt
  echo empty > ./sites/all/libraries/EMPTY.txt
  echo empty > ./sites/all/themes/EMPTY.txt
  chmod 0751 ./sites &> /dev/null
  chmod 0751 ./sites/all &> /dev/null
  chmod 02775 ./sites/all/{modules,libraries,themes} &> /dev/null
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/get.htaccess.txt ./.htaccess
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/crossdomain.xml ./
}
#
# create standard D8 symlinks
create_d8_symlinks () {
if [ ! -L "core" ] ; then
  ln -s $_CORE_DISTRO/core core &> /dev/null
  ln -s $_CORE_DISTRO/crossdomain.xml crossdomain.xml &> /dev/null
  ln -s $_CORE_DISTRO/.htaccess .htaccess &> /dev/null
  ln -s $_CORE_DISTRO/index.php index.php &> /dev/null
  ln -s $_CORE_DISTRO/profiles profiles &> /dev/null
  ln -s $_CORE_DISTRO/web.config web.config &> /dev/null
  cp -af $_CORE_DISTRO/cache ./
  cp -af $_CORE_DISTRO/sites ./
fi
}
#
# replace drupal 6 core
replace_drupal6_core () {
  cp -af /data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/* $_CORE_DISTRO/ &> /dev/null
  rm -f -r $_CORE_DISTRO/modules/cookie_cache_bypass
  rm -f $_CORE_DISTRO/*.txt
  cd $_CORE_DISTRO
}
#
# enable drupal 6 contrib
enable_drupal6_contrib () {
  sed -i "s/'dblog',/'robotstxt', 'path_alias_cache',/g" $_THIS_PRPATH/$_THIS_PRNAME.profile
}
#
# enable drupal 6 admin
enable_drupal6_admin () {
  sed -i "s/'path_alias_cache',/'path_alias_cache', 'admin',/g" $_THIS_PRPATH/$_THIS_PRNAME.profile
}
#
# add drupal 6 translations
add_drupal6_translations () {
  rm -f -r $_THIS_PRPATH/translations &> /dev/null
  ln -s /data/all/000/translations $_THIS_PRPATH/translations &> /dev/null
}
#
# init this distro root
init_this_distro_root () {
  mkdir -p $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
  cd $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
  create_symlinks
}
#
# add old short name acquia
add_old_short_name_acquia () {
  sed -i "s/=> 'Pressflow',/=> 'Pressflow',\n    'old_short_name' => 'acquia',/g" $_THIS_PRPATH/$_THIS_PRNAME.profile
}
#
# init distro seven root
init_core_distro_seven_root () {
  cd $_CORE_DISTRO
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/patch_commit_6fabd31b0f81.patch ./
  patch -p1 < patch_commit_6fabd31b0f81.patch &> /dev/null
  rm -f patch_commit_6fabd31b0f81.patch
  rm -f $_CORE_DISTRO/*.txt
  ln -s $_CORE/o_contrib_seven modules/o_contrib_seven
}
#
# upgrade ctools
upgrade_ctools () {
  rm -f -r ctools
  wget -q -U iCab http://ftp.drupal.org/files/projects/ctools-7.x-1.0.tar.gz
  tar -xzf ctools-7.x-1.0.tar.gz
  rm -f ctools-7.x-1.0.tar.gz
}
#
# remove default core seven profiles
remove_default_core_seven_profiles () {
  rm -f -r $_CORE_DISTRO/profiles/minimal
  rm -f -r $_CORE_DISTRO/profiles/standard
  rm -f -r $_CORE_DISTRO/profiles/testing
}
#
# replace drupal7 core
replace_drupal7_core () {
  if [ ! -d "$_CORE/$_DRUPAL7" ] ; then
    cd $_CORE
    wget -q -U iCab http://files.aegir.cc/dev/$_DRUPAL7.tar.gz
    tar -xzf $_CORE/$_DRUPAL7.tar.gz
    rm -f $_CORE/$_DRUPAL7.tar.gz
  fi
  cp -af $_CORE/$_DRUPAL7/* $_CORE_DISTRO/ &> /dev/null
}
#
# rename drupal7 profiles
rename_drupal7_profiles () {
  for Files in `find $_CORE_DISTRO/profiles -type f`
  do
    sed -i "s/name = Minimal/name = Vanilla Minimal/g"   $Files
    sed -i "s/name = Standard/name = Vanilla Standard/g" $Files
    sed -i "s/name = Testing/name = Vanilla Testing/g"   $Files
  done
}
#
# rename drupal7 distro directory
rename_drupal7_distro_directory () {
  _REVISIONS="10 11 12 13 14 15 16 17 18 19"
  for i in $_REVISIONS; do
    if [ -d "$_CORE/drupal-7.$i" ] && [ ! -e "$_CORE_DISTRO" ] ; then
      mv $_CORE/drupal-7.$i $_CORE_DISTRO
    fi
  done
}
#
# add old short name seven
add_old_short_name_seven () {
  sed -i "s/Drupal Minimal/Drupal Minimal\nold_short_name = testing/g" $_CORE_DISTRO/profiles/minimal/minimal.info &> /dev/null
  sed -i "s/Drupal Standard/Drupal Standard\nold_short_name = minimal/g" $_CORE_DISTRO/profiles/standard/standard.info &> /dev/null
}
#
# create drupal7 basic platform
create_drupal7_basic () {
  if [ ! -d "$_CORE_DISTRO" ] ; then
    mkdir -p $_CORE_DISTRO
    replace_drupal7_core
    init_core_distro_seven_root
    rename_drupal7_profiles
    add_old_short_name_seven
    create_dirs
    themes_for_d7
  fi
  init_this_distro_root
  create_d7_symlinks
  patch_d7_core
}


###---### User check
#
msg "$_STATUS C: Aegir automated install script part C"
if [ `whoami` = "root" ] ; then
  msg "$_STATUS C: FATAL ERROR: This script should be ran as a non-root user"
  msg "$_STATUS C: FATAL ERROR: Aborting AegirSetupC installer NOW!"
  touch /opt/tmp/status-AegirSetupC-FAIL
  exit 1
fi


###---### Checking status..
#
if [ -e "$_ROOT/log/setupmail.txt" ] ; then
  _STATUS=UPGRADE
  cd $_ROOT
fi


###---### Hot Sauce check..
#
if [ "$_HOT_SAUCE" = "NO" ] ; then
  _CORE="/data/all/$_LAST_ALL"
  _THIS_CORE="$_LAST_ALL"
  if [ "$_USE_CURRENT" = "YES" ] && [ -e "/data/all/000/translations/drupal-$_SMALLCORE_6_LANG.pl.po" ]; then
    msg "$_STATUS C: Shared platforms code v.$_LAST_ALL (latest available) will be used for this install"
  elif [ "$_USE_CURRENT" = "NO" ] || [ ! -e "/data/all/000/translations/drupal-$_SMALLCORE_6_LANG.pl.po" ] ; then
    _CORE="/data/all/$_ALL_DISTRO"
    _THIS_CORE="$_ALL_DISTRO"
    msg "$_STATUS C: Shared platforms code v.$_ALL_DISTRO (hot new) will be created"
  else
    msg "$_STATUS C: Shared platforms code v.$_LAST_ALL (latest available) will be used for this install"
  fi
else
  _CORE="/data/all/$_ALL_DISTRO"
  _THIS_CORE="$_ALL_DISTRO"
  msg "$_STATUS C: Shared platforms code v.$_ALL_DISTRO (hot new) will be created"
fi
_THIS_CTRL="/data/src/$_THIS_CORE/pressflow-$_SMALLCORE6/misc/ctrl-$_INSTALLER_VERSION"


###---### Distributions full names
#
_F_ACQUIA="Acquia $_SMALLCORE6 P.$_THIS_CORE"
_F_CIVICRM_M6="CiviCRM $_CIVICRM_M6 $_SMALLCORE6 P.$_THIS_CORE"
_F_CIVICRM_M7="CiviCRM $_CIVICRM_M7 $_SMALLCORE7 P.$_THIS_CORE"
_F_CIVICRM6="CiviCRM $_CIVICRM6 $_SMALLCORE6 P.$_THIS_CORE"
_F_CIVICRM7="CiviCRM $_CIVICRM7 $_SMALLCORE7 P.$_THIS_CORE"
_F_COD="Conference 1.0-b2 $_SMALLCORE6 P.$_THIS_CORE"
_F_COMMERCE="Commerce 1.7 $_SMALLCORE7 P.$_THIS_CORE"
_F_COMMONS="Commons 2.6 $_SMALLCORE6 P.$_THIS_CORE"
_F_DRUPAL5="Drupal $_DRUPAL5 P.$_THIS_CORE"
_F_DRUPAL6="Drupal $_SMALLCORE6 P.$_THIS_CORE"
_F_DRUPAL7="Drupal $_SMALLCORE7 P.$_THIS_CORE"
_F_DRUPAL8="Drupal $_DRUPAL8"
_F_ELMS="ELMS 1.0-a6 $_SMALLCORE6 P.$_THIS_CORE"
_F_FSERVER="Feature Server 1.1 $_SMALLCORE6 P.$_THIS_CORE"
_F_MANAGINGNEWS="MNews $_MANAGINGNEWS $_SMALLCORE6 P.$_THIS_CORE"
_F_MARTPLUG="MartPlug 1.0-a1 $_SMALLCORE7 P.$_THIS_CORE"
_F_NODESTREAM6="NodeStream 1.5 $_SMALLCORE6 P.$_THIS_CORE"
_F_NODESTREAM7="NodeStream 2.0-b1 $_SMALLCORE7 P.$_THIS_CORE"
_F_OCTOPUS_VIDEO="Octopus Video 1.0-a6 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENATRIUM="Open Atrium 1.4.1 $_SMALLCORE6 P.$_THIS_CORE"
_F_OPENCHURCH="OpenChurch 1.10-a1 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENDEALS="Open Deals 1.0-b7 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENENTERPRISE="Open Enterprise 1.0-b3 $_SMALLCORE6 P.$_THIS_CORE"
_F_OPENOUTREACH="Open Outreach 1.0-b8 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENPUBLIC="OpenPublic 1.0-b3 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENPUBLISH="OpenPublish 3.0-a8 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENSCHOLAR="OpenScholar 2.0-b13 $_SMALLCORE6 P.$_THIS_CORE"
_F_PANOPOLY="Panopoly 1.0-b3 $_SMALLCORE7 P.$_THIS_CORE"
_F_PROSEPOINT="Prosepoint $_PROSEPOINT $_SMALLCORE6 P.$_THIS_CORE"
_F_UBER_CART_SEVEN="Ubercart $_UBER_CART_SEVEN $_SMALLCORE7 P.$_THIS_CORE"
_F_UBERCART="Ubercart $_UBERCART $_SMALLCORE6 P.$_THIS_CORE"
_F_VIDEOLA="Videola 1.0-a3 $_SMALLCORE6 P.$_THIS_CORE"
#
_F_DRUPAL6_D="Drupal $_SMALLCORE6 D.$_THIS_CORE"
_F_DRUPAL6_S="Drupal $_SMALLCORE6 S.$_THIS_CORE"
_F_DRUPAL6_P="Drupal $_SMALLCORE6 P.$_THIS_CORE"
_F_DRUPAL7_D="Drupal $_SMALLCORE7 D.$_THIS_CORE"
_F_DRUPAL7_S="Drupal $_SMALLCORE7 S.$_THIS_CORE"
_F_DRUPAL7_P="Drupal $_SMALLCORE7 P.$_THIS_CORE"


###---### Create directories
#
mkdir -p $_ROOT/distro/$_THIS_CORE
chmod 0711 $_ROOT/distro &> /dev/null
chmod 0711 $_ROOT/distro/$_THIS_CORE &> /dev/null


###---### Prepare Pressflow core
#
if [ $_STATUS = "INIT" ] && [ ! -e "$_THIS_CTRL" ] ; then
  msg "$_STATUS C: Preparing Pressflow +Extra $_SMALLCORE6 core, please wait..."
  mrun "sleep 1"
  prepare_pressflow_core
fi


###---###
if [ "$_CLIENT_CORES" -ge "2" ] && [ "$_CLIENT_OPTION" = "SSD" ] && [[ "$_DOMAIN" =~ ".host8." ]] ; then
  _ALLOW_FOUR=YES
  _ALLOW_CIVICRM=YES
  _ALLOW_VIDEO=NO
elif [ "$_CLIENT_CORES" -ge "4" ] && [ "$_CLIENT_OPTION" != "SSD" ] ; then
  if [[ "$_DOMAIN" =~ ".host8." ]] ; then
    _ALLOW_FOUR=YES
    _ALLOW_CIVICRM=NO
    _ALLOW_VIDEO=NO
  else
    _ALLOW_FOUR=YES
    _ALLOW_CIVICRM=YES
    _ALLOW_VIDEO=YES
  fi
else
  _ALLOW_FOUR=NO
  _ALLOW_CIVICRM=NO
  _ALLOW_VIDEO=NO
fi


acquia_install () {
###---### Acquia
#
_THIS_PRNAME="acquia"
_THIS_DISTRO="$_THIS_PRNAME-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ AQ6 ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_ACQUIA - http://bit.ly/acquiadrupal" ; then
true
msg "DISTRO: $_F_ACQUIA installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  git clone git://git.acquia.com/drupal/branches/1.x-6.x.git $_CORE_DISTRO &> /dev/null
  rm -f -r $_CORE_DISTRO/.git
  replace_drupal6_core
  enable_drupal6_contrib
  sed -i "s/=> 'Acquia Drupal',/=> 'Acquia Drupal',\n    'old_short_name' => 'default',/g" $_THIS_PRPATH/$_THIS_PRNAME.profile
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
  add_drupal6_translations
fi
init_this_distro_root
msg "DISTRO: $_F_ACQUIA installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_ACQUIA installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


civicrm_m6_install () {
###---### CiviCRM Modern D6
#
_THIS_PRNAME="default"
_THIS_DISTRO="civicrm-$_CIVICRM_M6-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_CIVICRM" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CM6 ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_CIVICRM_M6 - http://civicrm.org" ; then
true
msg "DISTRO: $_F_CIVICRM_M6 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/civicrm-4.1-d6.make ./
  $_ROOT/tools/drush/drush make civicrm-4.1-d6.make $_THIS_DISTRO &> /dev/null
  rm -f civicrm-4.1-d6.make
  replace_drupal6_core
  enable_drupal6_contrib
  add_old_short_name_acquia
  create_dirs
fi
init_this_distro_root
msg "DISTRO: $_F_CIVICRM_M6 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_CIVICRM_M6 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


civicrm_m7_install () {
###---### CiviCRM Modern D7
#
_THIS_PRNAME="standard"
_THIS_DISTRO="civicrm-$_CIVICRM_M7-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_CIVICRM" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CM7 ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_CIVICRM_M7 - http://civicrm.org" ; then
true
msg "DISTRO: $_F_CIVICRM_M7 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/civicrm-4.1-d7.make ./
  $_ROOT/tools/drush/drush make civicrm-4.1-d7.make $_THIS_DISTRO &> /dev/null
  rm -f civicrm-4.1-d7.make
  init_core_distro_seven_root
  rename_drupal7_profiles
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_CIVICRM_M7 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_CIVICRM_M7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


civicrm3_install () {
###---### CiviCRM 3 D6
#
_THIS_PRNAME="default"
_THIS_DISTRO="civicrm-$_CIVICRM6-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_CIVICRM" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CC3 ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_CIVICRM6 - http://civicrm.org" ; then
true
msg "DISTRO: $_F_CIVICRM6 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/civicrm3.make ./
  $_ROOT/tools/drush/drush make civicrm3.make $_THIS_DISTRO &> /dev/null
  rm -f civicrm3.make
  replace_drupal6_core
  enable_drupal6_contrib
  add_old_short_name_acquia
  create_dirs
fi
init_this_distro_root
msg "DISTRO: $_F_CIVICRM6 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_CIVICRM6 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


civicrm4_install () {
###---### CiviCRM 4 D7
#
_THIS_PRNAME="standard"
_THIS_DISTRO="civicrm-$_CIVICRM7-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_CIVICRM" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CC4 ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_CIVICRM7 - http://civicrm.org" ; then
true
msg "DISTRO: $_F_CIVICRM7 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/civicrm4.make ./
  $_ROOT/tools/drush/drush make civicrm4.make $_THIS_DISTRO &> /dev/null
  rm -f civicrm4.make
  init_core_distro_seven_root
  rename_drupal7_profiles
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_CIVICRM7 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_CIVICRM7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


cod_install () {
###---### Conference Organizing Distribution
#
_THIS_PRNAME="cod"
_THIS_DISTRO="$_THIS_PRNAME-$_COD-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ COD ]] ; then
if [ ! -L "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/jquery.ui" ] ; then
echo " "
if prompt_yes_no "$_F_COD - http://usecod.com" ; then
true
msg "DISTRO: $_F_COD installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  if [ -d "$_CORE/$_THIS_PRNAME-$_COD" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_COD $_CORE/$_THIS_PRNAME-$_COD-old
  fi
  wget -q -U iCab http://files.aegir.cc/dev/distro/$_THIS_PRNAME-$_COD.tar.gz
  tar -xzf $_THIS_PRNAME-$_COD.tar.gz
  rm -f $_THIS_PRNAME-$_COD.tar.gz
  if [ -d "$_CORE/$_THIS_PRNAME" ] ; then
    mv $_CORE/$_THIS_PRNAME $_CORE_DISTRO
  else
    mv $_CORE/$_THIS_PRNAME-$_COD $_CORE_DISTRO
  fi
  if [ -d "$_CORE/$_THIS_PRNAME-$_COD-old" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_COD-old $_CORE/$_THIS_PRNAME-$_COD
  fi
  replace_drupal6_core
  enable_drupal6_contrib
  sed -i "s/Conference Organizing Distribution/Conference/g" $_THIS_PRPATH/$_THIS_PRNAME.profile
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
  add_drupal6_translations
fi
init_this_distro_root
if [ ! -L "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/jquery.ui" ] ; then
  mkdir -p $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries
  ln -s $_CORE_DISTRO/profiles/$_THIS_PRNAME/modules/contrib/jquery_ui/jquery.ui $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/jquery.ui
fi
msg "DISTRO: $_F_COD installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_COD installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


commerce_install () {
###---### Commerce 7.x
#
_THIS_PRNAME="commerce_kickstart"
_THIS_DISTRO="commerce-$_COMMERCE-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ DCE ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_COMMERCE - http://drupalcommerce.org" ; then
true
msg "DISTRO: $_F_COMMERCE installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_COMMERCE-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_COMMERCE-core.tar.gz
  rm -f $_THIS_PRNAME-$_COMMERCE-core.tar.gz
  rename_drupal7_distro_directory
  if [ -d "$_CORE/commerce-$_COMMERCE" ] ; then
    mv commerce-$_COMMERCE $_THIS_DISTRO
  elif [ -d "$_CORE/$_THIS_PRNAME-$_COMMERCE" ] ; then
    mv $_THIS_PRNAME-$_COMMERCE $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  cd $_THIS_PRPATH
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_THIS_PRNAME.patch ./
  patch -p1 < $_THIS_PRNAME.patch &> /dev/null
  cd $_THIS_PRPATH/modules
  upgrade_ctools
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_COMMERCE installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_COMMERCE installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


commons_install () {
###---### Commons
#
_THIS_PRNAME="drupal_commons"
_THIS_DISTRO="commons-$_COMMONS-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ DCS ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_COMMONS - http://acquia.com/drupalcommons" ; then
true
msg "DISTRO: $_F_COMMONS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  wget -q -U iCab http://network.acquia.com/files/marketing/commons/commons-$_COMMONS.tar.gz
  tar -xzf commons-$_COMMONS.tar.gz
  rm -f commons-$_COMMONS.tar.gz
  if [ -d "$_CORE/acquia_commons" ] ; then
    mv $_CORE/acquia_commons $_CORE_DISTRO
  elif [ -d "$_CORE/commons-$_COMMONS" ] ; then
    mv $_CORE/commons-$_COMMONS $_CORE_DISTRO
  else
    mv $_CORE/commons $_CORE_DISTRO
  fi
  replace_drupal6_core
  if [ $_COMMONS = "6.x-1.3" ] ; then
    cd $_THIS_PRPATH
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/commons-1045778-fix-aegir-installs.patch ./
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/commons-1060250-aegir-infinite-loop.patch ./
    patch -p1 < commons-1045778-fix-aegir-installs.patch &> /dev/null
    mrun "sleep 1"
    patch -p1 < commons-1060250-aegir-infinite-loop.patch &> /dev/null
    cd $_CORE_DISTRO
  fi
  cd $_THIS_PRPATH/modules/contrib/og
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/og_update_6205_commons_fix.patch ./
  patch -p1 < og_update_6205_commons_fix.patch &> /dev/null
  rm -f -r $_CORE_DISTRO/profiles/default
  enable_drupal6_contrib
  create_dirs
fi
init_this_distro_root
if [ ! -L "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/getid3" ] ; then
  mkdir -p $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries
  ln -s $_THIS_PRPATH/libraries/getid3 $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/getid3
fi
msg "DISTRO: $_F_COMMONS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_COMMONS installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


drupal5_install () {
###---### Drupal 5 Pressflow
#
_THIS_PRNAME="default"
_THIS_DISTRO="pressflow-$_DRUPAL5"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_D_5_ALLOW" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D5P ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL5 - http://pressflow.org" ; then
true
msg "DISTRO: $_F_DRUPAL5 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://launchpad.net/pressflow/5.x/$_DRUPAL5/+download/$_THIS_DISTRO.tar.gz
  tar -xzf $_THIS_DISTRO.tar.gz
  rm -f $_THIS_DISTRO.tar.gz
  rm -f $_CORE_DISTRO/*.txt
  create_dirs
fi
init_this_distro_root
rm -f boost_stats.php
msg "DISTRO: $_F_DRUPAL5 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_DRUPAL5 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


drupal6_install () {
###---### Drupal 6 Pressflow
#
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6D ]] || [[ $_PLATFORMS_LIST =~ D6S ]] || [[ $_PLATFORMS_LIST =~ D6P ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL6 - http://pressflow.org" ; then
true

###---### Drupal 6 Pressflow Development
#
_THIS_PRNAME="default"
_THIS_DISTRO="pressflow-$_SMALLCORE6-dev"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6D ]] ; then
msg "DISTRO: $_F_DRUPAL6_D installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  mkdir -p $_CORE_DISTRO
  replace_drupal6_core
  enable_drupal6_contrib
  enable_drupal6_admin
  add_old_short_name_acquia
  create_dirs
  add_drupal6_translations
fi
init_this_distro_root
msg "DISTRO: $_F_DRUPAL6_D installation completed"
mrun "sleep 1"
echo " "
fi

###---### Drupal 6 Pressflow Staging
#
_THIS_PRNAME="default"
_THIS_DISTRO="pressflow-$_SMALLCORE6-stage"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6S ]] ; then
msg "DISTRO: $_F_DRUPAL6_S installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  mkdir -p $_CORE_DISTRO
  replace_drupal6_core
  enable_drupal6_contrib
  enable_drupal6_admin
  add_old_short_name_acquia
  create_dirs
  add_drupal6_translations
fi
init_this_distro_root
msg "DISTRO: $_F_DRUPAL6_S installation completed"
mrun "sleep 1"
echo " "
fi

###---### Drupal 6 Pressflow Production
#
_THIS_PRNAME="default"
_THIS_DISTRO="pressflow-$_SMALLCORE6-prod"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6P ]] ; then
if [ ! -d "$_CORE/pressflow" ] ; then
  msg "DISTRO: $_F_DRUPAL6 installation in progress..."
  mrun "sleep 1"
  if [ ! -d "$_CORE_DISTRO" ] ; then
    if [ ! -e "$_THIS_CTRL" ] ; then
      prepare_pressflow_core
    fi
    cd $_CORE
    mkdir -p $_CORE_DISTRO
    replace_drupal6_core
    enable_drupal6_contrib
    enable_drupal6_admin
    add_old_short_name_acquia
    create_dirs
    add_drupal6_translations
  fi
  mkdir -p $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
  cd $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
  create_symlinks
  msg "DISTRO: $_F_DRUPAL6 installation completed"
  mrun "sleep 1"
elif [ -d "$_CORE/pressflow" ] ; then
  echo " "
  msg "DISTRO: $_F_DRUPAL6 installation in progress..."
  mrun "sleep 1"
  _CORE_DISTRO="$_CORE/pressflow"
  mkdir -p $_ROOT/distro/$_THIS_CORE/pressflow
  cd $_ROOT/distro/$_THIS_CORE/pressflow
  create_symlinks
  msg "DISTRO: $_F_DRUPAL6 installation completed"
  mrun "sleep 1"
fi
fi

else
  msg "DISTRO: $_F_DRUPAL6 installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


drupal7_install () {
###---### Drupal 7
#
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7D ]] || [[ $_PLATFORMS_LIST =~ D7S ]] || [[ $_PLATFORMS_LIST =~ D7P ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL7 - http://drupal.org/drupal-7.14" ; then
true

###---### Drupal 7 Development
#
_THIS_PRNAME="standard"
_THIS_DISTRO="$_DRUPAL7D"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7D ]] ; then
msg "DISTRO: $_F_DRUPAL7_D installation in progress..."
mrun "sleep 1"
create_drupal7_basic
msg "DISTRO: $_F_DRUPAL7_D installation completed"
mrun "sleep 1"
echo " "
fi

###---### Drupal 7 Staging
#
_THIS_PRNAME="standard"
_THIS_DISTRO="$_DRUPAL7S"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7S ]] ; then
msg "DISTRO: $_F_DRUPAL7_S installation in progress..."
mrun "sleep 1"
create_drupal7_basic
msg "DISTRO: $_F_DRUPAL7_S installation completed"
mrun "sleep 1"
echo " "
fi

###---### Drupal 7 Production
#
_THIS_PRNAME="standard"
_THIS_DISTRO="$_DRUPAL7P"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7P ]] ; then
msg "DISTRO: $_F_DRUPAL7_P installation in progress..."
mrun "sleep 1"
create_drupal7_basic
msg "DISTRO: $_F_DRUPAL7_P installation completed"
mrun "sleep 1"
fi

else
  msg "DISTRO: $_F_DRUPAL7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


drupal8_install () {
###---### Drupal 8
#
#_DRUPAL8="8.0-dev-$_TODAY"
#
_THIS_PRNAME="standard"
_THIS_DISTRO="drupal-$_DRUPAL8"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_D_8_ALLOW" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D8D ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL8 - http://drupal.org" ; then
true
msg "DISTRO: $_F_DRUPAL8 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  git clone --branch 8.x http://git.drupal.org/project/drupal.git $_THIS_DISTRO &> /dev/null
  rm -f -r $_CORE_DISTRO/.git
  rm -f $_CORE_DISTRO/*.txt
  rm -f $_CORE_DISTRO/core/*.txt
  cd $_CORE_DISTRO
  rename_drupal7_profiles
  create_d8_dirs
fi
mkdir -p $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
cd $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
create_d8_symlinks
rm -f boost_stats.php
msg "DISTRO: $_F_DRUPAL8 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_DRUPAL8 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


elms_install () {
###---### ELMS
#
_THIS_PRNAME="elms"
_THIS_DISTRO="$_THIS_PRNAME-$_ELMS-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ ELS ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_ELMS - http://elms.psu.edu" ; then
true
msg "DISTRO: $_F_ELMS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  if [ -d "$_CORE/$_THIS_PRNAME-$_ELMS" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_ELMS $_CORE/$_THIS_PRNAME-$_ELMS-old
  fi
  wget -q -U iCab http://files.aegir.cc/dev/distro/$_THIS_PRNAME-$_ELMS.tar.gz
  tar -xzf $_THIS_PRNAME-$_ELMS.tar.gz
  rm -f $_THIS_PRNAME-$_ELMS.tar.gz
  if [ -d "$_CORE/$_THIS_PRNAME" ] ; then
    mv $_CORE/$_THIS_PRNAME $_CORE_DISTRO
  else
    mv $_CORE/$_THIS_PRNAME-$_ELMS $_CORE_DISTRO
  fi
  if [ -d "$_CORE/$_THIS_PRNAME-$_ELMS-old" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_ELMS-old $_CORE/$_THIS_PRNAME-$_ELMS
  fi
  replace_drupal6_core
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
fi
init_this_distro_root
msg "DISTRO: $_F_ELMS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_ELMS installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


fserver_install () {
###---### Feature Server Make
#
_THIS_PRNAME="feature_server"
_THIS_DISTRO="fserver-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ FSR ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_FSERVER - http://bit.ly/fservermore" ; then
true
msg "DISTRO: $_F_FSERVER installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [[ $_BOA_REPO_GIT_URL =~ drupal ]] ; then
    _BOA_REPO_GIT_URL_LOCAL="git://github.com/omega8cc"
  else
    _BOA_REPO_GIT_URL_LOCAL="$_BOA_REPO_GIT_URL"
  fi
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  echo "api = 2" > fserver.make
  echo "core = 6.x" >> fserver.make
  echo "projects[drupal][type] = \"core\"" >> fserver.make
  echo "projects[$_THIS_PRNAME][type] = \"profile\"" >> fserver.make
  echo "projects[$_THIS_PRNAME][download][type] = \"git\"" >> fserver.make
  echo "projects[$_THIS_PRNAME][download][url] = \"$_BOA_REPO_GIT_URL_LOCAL/$_THIS_PRNAME.git\"" >> fserver.make
  $_ROOT/tools/drush/drush make fserver.make $_THIS_DISTRO &> /dev/null
  rm -f fserver.make
  replace_drupal6_core
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
  cd $_CORE_DISTRO/profiles/$_THIS_PRNAME/themes
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/singular.patch ./
  patch -p0 <./singular.patch &> /dev/null
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/singular.mft.patch ./
  patch -p0 <./singular.mft.patch &> /dev/null
fi
init_this_distro_root
msg "DISTRO: $_F_FSERVER installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_FSERVER installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


managingnews_install () {
###---### ManagingNews
#
_THIS_PRNAME="managingnews"
_THIS_DISTRO="$_THIS_PRNAME-$_MANAGINGNEWS-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ MNS ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_MANAGINGNEWS - http://managingnews.com" ; then
true
msg "DISTRO: $_F_MANAGINGNEWS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  _MANAGINGNEWS_DL=1.2
  wget -q -U iCab http://managingnews.com/files/$_THIS_PRNAME-$_MANAGINGNEWS_DL.zip
  if [ -d "$_CORE/$_THIS_PRNAME-$_MANAGINGNEWS_DL" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_MANAGINGNEWS_DL $_CORE/$_THIS_PRNAME-$_MANAGINGNEWS_DL-old
  fi
  unzip -qq $_THIS_PRNAME-$_MANAGINGNEWS_DL.zip
  rm -f $_THIS_PRNAME-$_MANAGINGNEWS_DL.zip
  mv $_THIS_PRNAME-$_MANAGINGNEWS_DL $_THIS_DISTRO
  if [ -d "$_CORE/$_THIS_PRNAME-$_MANAGINGNEWS_DL-old" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_MANAGINGNEWS_DL-old $_CORE/$_THIS_PRNAME-$_MANAGINGNEWS_DL
  fi
  replace_drupal6_core
  cd $_THIS_PRPATH/modules/contrib
  rm -f -r data ctools features feeds imageapi imagecache libraries mapbox openlayers spaces views
  drush dl --destination=$_THIS_PRPATH/modules/contrib data-6.x-1.1 ctools-6.x-1.8 features-6.x-1.2 feeds-6.x-1.0-beta11 imageapi-6.x-1.10 imagecache-6.x-2.0-beta12 libraries-6.x-1.0 mapbox-6.x-2.0-alpha1 openlayers-6.x-2.0-beta1 spaces-6.x-3.4 views-6.x-2.13 -y &> /dev/null
  cd views
  # http://drupal.org/node/853864#comment-3898996
  wget -q -U iCab http://drupal.org/files/issues/views-853864_2.patch
  patch -p0 < views-853864_2.patch &> /dev/null
  # http://drupal.org/node/402944#comment-5370400
  wget -q -U iCab http://drupal.org/files/views-unpack_options-cache-6.2-51.patch
  patch -p1 < views-unpack_options-cache-6.2-51.patch &> /dev/null
  cd ../imagecache
  # http://drupal.org/node/1243258#comment-4850634
  wget -q -U iCab http://drupal.org/files/issues/imagecache-1243258-5.patch
  patch -p1 < imagecache-1243258-5.patch &> /dev/null
  enable_drupal6_contrib
  enable_drupal6_admin
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
fi
init_this_distro_root
msg "DISTRO: $_F_MANAGINGNEWS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_MANAGINGNEWS installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


martplug_install () {
###---### MartPlug
#
_THIS_PRNAME="martplug"
_THIS_DISTRO="$_THIS_PRNAME-$_MARTPLUG-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ MPG ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_MARTPLUG - http://drupal.org/project/$_THIS_PRNAME" ; then
true
msg "DISTRO: $_F_MARTPLUG installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://files.aegir.cc/dev/distro/$_THIS_PRNAME-$_MARTPLUG-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_MARTPLUG-core.tar.gz
  rm -f $_THIS_PRNAME-$_MARTPLUG-core.tar.gz
  rename_drupal7_distro_directory
  if [ -d "$_CORE/$_THIS_PRNAME-$_MARTPLUG" ] ; then
    mv $_THIS_PRNAME-$_MARTPLUG $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  cd $_THIS_PRPATH/modules/contrib/features
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/features-1265168-19-roles.patch ./
  patch -p1 < features-1265168-19-roles.patch &> /dev/null
  cd $_THIS_PRPATH/modules/contrib
  upgrade_ctools
  sed -i "s/^dependencies.*martplug_sample_content.*//g" $_THIS_PRPATH/$_THIS_PRNAME.info &> /dev/null
  sed -i "s/name = MartPlug/name = MartPlug\nold_short_name = commerce_kickstart/g" $_THIS_PRPATH/$_THIS_PRNAME.info &> /dev/null
  find $_THIS_PRPATH -type d -exec chmod 0755 {} \; &> /dev/null
  find $_THIS_PRPATH -type f -exec chmod 0644 {} \; &> /dev/null
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_MARTPLUG installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_MARTPLUG installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


nodestream6_install () {
###---### NodeStream Make
#
_THIS_PRNAME="nodestream"
_THIS_DISTRO="$_THIS_PRNAME-$_NODESTREAM6-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ NSM ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_NODESTREAM6 - http://nodestream.org" ; then
true
msg "DISTRO: $_F_NODESTREAM6 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_NODESTREAM6-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_NODESTREAM6-core.tar.gz
  rm -f $_THIS_PRNAME-$_NODESTREAM6-core.tar.gz
  if [ -d "$_CORE/drupal-6.24" ] ; then
    mv drupal-6.24 $_THIS_DISTRO
  elif [ -d "$_CORE/drupal-6.25" ] ; then
    mv drupal-6.25 $_THIS_DISTRO
  elif [ -d "$_CORE/drupal-6.26" ] ; then
    mv drupal-6.26 $_THIS_DISTRO
  elif [ -d "$_CORE/$_THIS_PRNAME-$_NODESTREAM6" ] ; then
    mv $_THIS_PRNAME-$_NODESTREAM6 $_THIS_DISTRO
  fi
  replace_drupal6_core
  rm -f -r $_CORE_DISTRO/profiles/default
  if [ $_NODESTREAM6 = "6.x-1.5" ] ; then
    sed -i "s/libraries\/profiler/modules\/profiler/g" $_THIS_PRPATH/$_THIS_PRNAME.profile
  fi
  create_dirs
fi
init_this_distro_root
msg "DISTRO: $_F_NODESTREAM6 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_NODESTREAM6 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


nodestream7_install () {
###---### NodeStream7 Make
#
_THIS_PRNAME="nodestream"
_THIS_DISTRO="$_THIS_PRNAME-$_NODESTREAM7-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ NS7 ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_NODESTREAM7 - http://nodestream.org" ; then
true
msg "DISTRO: $_F_NODESTREAM7 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_NODESTREAM7-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_NODESTREAM7-core.tar.gz
  rm -f $_THIS_PRNAME-$_NODESTREAM7-core.tar.gz
  rename_drupal7_distro_directory
  if [ -d "$_CORE/$_THIS_PRNAME-$_NODESTREAM7" ] ; then
    mv $_THIS_PRNAME-$_NODESTREAM7 $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_NODESTREAM7 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_NODESTREAM7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


octopus_video_install () {
###---### Octopus Video
#
_THIS_PRNAME="octopus_video"
_THIS_DISTRO="$_THIS_PRNAME-$_OCTOPUS_VIDEO-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_VIDEO" = "YES" ] || [[ "$_DOMAIN" =~ "node.us.host8.biz" ]] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OVO ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_OCTOPUS_VIDEO - http://octopusvideo.org" ; then
true
msg "DISTRO: $_F_OCTOPUS_VIDEO installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://files.aegir.cc/dev/distro/$_THIS_PRNAME-$_OCTOPUS_VIDEO.tar.gz
  tar -xzf $_THIS_PRNAME-$_OCTOPUS_VIDEO.tar.gz &> /dev/null
  rm -f $_THIS_PRNAME-$_OCTOPUS_VIDEO.tar.gz
  mv $_THIS_PRNAME-$_OCTOPUS_VIDEO $_THIS_DISTRO
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  if [ $_OCTOPUS_VIDEO = "1.0-alpha5" ] || [ $_OCTOPUS_VIDEO = "1.0-alpha6" ] ; then
    cd $_CORE_DISTRO/profiles
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_THIS_PRNAME.patch ./
    patch -p1 < $_THIS_PRNAME.patch &> /dev/null
    cd $_CORE_DISTRO
  fi
  cd $_THIS_PRPATH/libraries
  git clone git://github.com/zencoder/zencoder-php.git zencoder &> /dev/null
  rm -f -r zencoder/.git
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_OCTOPUS_VIDEO installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OCTOPUS_VIDEO installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openatrium_install () {
###---### Open Atrium
#
_THIS_PRNAME="openatrium"
_THIS_DISTRO="$_THIS_PRNAME-$_OPENATRIUM-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OAM ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_OPENATRIUM - http://openatrium.com" ; then
true
msg "DISTRO: $_F_OPENATRIUM installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_OPENATRIUM-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_OPENATRIUM-core.tar.gz
  rm -f $_THIS_PRNAME-$_OPENATRIUM-core.tar.gz
  if [ -d "$_CORE/$_THIS_PRNAME-$_OPENATRIUM" ] ; then
    mv $_THIS_PRNAME-$_OPENATRIUM $_THIS_DISTRO
  fi
  cd $_THIS_PRPATH/modules/contrib/imagecache
  # http://drupal.org/node/1243258#comment-4850634
  wget -q -U iCab http://drupal.org/files/issues/imagecache-1243258-5.patch
  patch -p1 < imagecache-1243258-5.patch &> /dev/null
  replace_drupal6_core
  enable_drupal6_contrib
  rm -f -r $_CORE_DISTRO/profiles/default
  cd $_THIS_PRPATH/modules/atrium_features/
  git clone git://github.com/nuvoleweb/atrium_folders.git &> /dev/null
  rm -f -r atrium_folders/.git
  $_DRUSHCMD dl --destination=$_THIS_PRPATH/modules/atrium_features ideation-6.x-1.0-rc1 -y &> /dev/null
  $_DRUSHCMD dl --destination=$_THIS_PRPATH/modules/contrib better_exposed_filters-6.x-1.0 fivestar-6.x-1.19 -y &> /dev/null
  $_DRUSHCMD dl --destination=$_THIS_PRPATH/modules/contrib votingapi-6.x-2.3 data-6.x-1.0 -y &> /dev/null
  create_dirs
  add_drupal6_translations
fi
init_this_distro_root
msg "DISTRO: $_F_OPENATRIUM installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENATRIUM installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


openchurch_install () {
###---### Open Church
#
_THIS_PRNAME="openchurch"
_THIS_DISTRO="$_THIS_PRNAME-$_OPENCHURCH-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OCH ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_OPENCHURCH - http://openchurchsite.com" ; then
true
msg "DISTRO: $_F_OPENCHURCH installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_OPENCHURCH-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_OPENCHURCH-core.tar.gz &> /dev/null
  rm -f $_THIS_PRNAME-$_OPENCHURCH-core.tar.gz
  rename_drupal7_distro_directory
  if [ -d "$_CORE/$_THIS_PRNAME-$_OPENCHURCH" ] ; then
    mv $_THIS_PRNAME-$_OPENCHURCH $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_OPENCHURCH installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENCHURCH installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


opendeals_install () {
###---### Open Deals
#
_THIS_PRNAME="opendeals"
_THIS_DISTRO="$_THIS_PRNAME-$_OPENDEALS-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ ODS ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_OPENDEALS - http://opendealsapp.com" ; then
true
msg "DISTRO: $_F_OPENDEALS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_OPENDEALS-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_OPENDEALS-core.tar.gz
  rm -f $_THIS_PRNAME-$_OPENDEALS-core.tar.gz
  rename_drupal7_distro_directory
  if [ -d "$_CORE/$_THIS_PRNAME-$_OPENDEALS" ] ; then
    mv $_THIS_PRNAME-$_OPENDEALS $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  cd $_CORE_DISTRO/profiles/$_THIS_PRNAME/modules
  upgrade_ctools
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_OPENDEALS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENDEALS installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openoutreach_install () {
###---### Open Outreach
#
_THIS_PRNAME="openoutreach"
_THIS_DISTRO="$_THIS_PRNAME-$_OPENOUTREACH-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OOH ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_OPENOUTREACH - http://openoutreach.org" ; then
true
msg "DISTRO: $_F_OPENOUTREACH installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://files.aegir.cc/dev/distro/$_THIS_PRNAME-$_OPENOUTREACH.tar.gz
  tar -xzf $_THIS_PRNAME-$_OPENOUTREACH.tar.gz &> /dev/null
  rm -f $_THIS_PRNAME-$_OPENOUTREACH.tar.gz
  mv $_THIS_PRNAME-$_OPENOUTREACH $_THIS_DISTRO
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  cd $_CORE_DISTRO/profiles/$_THIS_PRNAME/modules/contrib
  upgrade_ctools
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_OPENOUTREACH installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENOUTREACH installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


###---### Open Public
#
build_openpublic () {
  wget -q -U iCab http://www.openpublicapp.com/sites/default/files/releases/openpublic.$_OPENPUBLIC.tar.gz
  tar -xzf $_THIS_PRNAME.$_OPENPUBLIC.tar.gz
  rm -f $_THIS_PRNAME.$_OPENPUBLIC.tar.gz
  mv $_THIS_PRNAME $_THIS_DISTRO
  rename_drupal7_distro_directory
  if [ -d "$_CORE/$_THIS_PRNAME-$_OPENPUBLIC" ] ; then
    mv $_THIS_PRNAME-$_OPENPUBLIC $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  cd $_THIS_PRPATH/modules/contrib
  upgrade_ctools
  create_dirs
  cd $_THIS_PRPATH/themes
  wget -q -U iCab http://ftp.drupal.org/files/projects/openpublic_eu-7.x-1.0.tar.gz
  tar -xzf openpublic_eu-7.x-1.0.tar.gz &> /dev/null
  rm -f openpublic_eu-7.x-1.0.tar.gz
  if [ -d "$_THIS_PRPATH/libraries" ] ; then
    rm -f -r $_THIS_PRPATH/libraries/colorbox
    cd $_THIS_PRPATH/libraries
    wget -q -U iCab http://jacklmoore.com/colorbox/colorbox.zip
    unzip -qq colorbox.zip &> /dev/null
    rm -f colorbox.zip
  fi
  if [ $_OPENPUBLIC = "beta1-build100" ] ; then
    cd $_THIS_PRPATH
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_THIS_PRNAME.patch ./
    patch -p1 < $_THIS_PRNAME.patch &> /dev/null
    cd $_CORE_DISTRO
  fi
  touch $_CORE_DISTRO/core_$_SMALLCORE7.log
}

openpublic_install () {
_THIS_PRNAME="openpublic"
_THIS_DISTRO="$_THIS_PRNAME-$_OPENPUBLIC-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OPC ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_OPENPUBLIC - http://openpublicapp.com" ; then
true
msg "DISTRO: $_F_OPENPUBLIC installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  build_openpublic
fi
mkdir -p $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
cd $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO
if [ ! -L "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/colorbox" ] ; then
  mkdir -p $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries
  ln -s $_THIS_PRPATH/libraries/colorbox $_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/colorbox
fi
create_symlinks
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_OPENPUBLIC installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENPUBLIC installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openpublish_install () {
###---### OpenPublish
#
_THIS_PRNAME="openpublish"
_THIS_DISTRO="$_THIS_PRNAME-$_OPENPUBLISH-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OPH ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_OPENPUBLISH - http://openpublishapp.com" ; then
true
msg "DISTRO: $_F_OPENPUBLISH installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_OPENPUBLISH-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_OPENPUBLISH-core.tar.gz &> /dev/null
  rm -f $_THIS_PRNAME-$_OPENPUBLISH-core.tar.gz
  rename_drupal7_distro_directory
  if [ -d "$_CORE/$_THIS_PRNAME-$_OPENPUBLISH" ] ; then
    mv $_THIS_PRNAME-$_OPENPUBLISH $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  cd $_CORE_DISTRO/profiles/$_THIS_PRNAME/modules/contrib
  upgrade_ctools
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_OPENPUBLISH installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENPUBLISH installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openscholar_install () {
###---### OpenScholar
#
_THIS_PRNAME="openscholar"
_THIS_DISTRO="$_THIS_PRNAME-$_OPENSCHOLAR-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OSR ]] ; then
if [ ! -L "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/sites/all/libraries/shadowbox" ] ; then
echo " "
if prompt_yes_no "$_F_OPENSCHOLAR - http://openscholar.harvard.edu" ; then
true
msg "DISTRO: $_F_OPENSCHOLAR installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  if [ -d "$_CORE/$_THIS_PRNAME-$_OPENSCHOLAR" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_OPENSCHOLAR $_CORE/$_THIS_PRNAME-$_OPENSCHOLAR-old
  fi
  wget -q -U iCab http://files.aegir.cc/dev/distro/scholar/$_THIS_PRNAME-$_OPENSCHOLAR.tar.gz
  tar -xzf $_THIS_PRNAME-$_OPENSCHOLAR.tar.gz
  rm -f $_THIS_PRNAME-$_OPENSCHOLAR.tar.gz
  mv $_THIS_PRNAME-$_OPENSCHOLAR $_THIS_DISTRO
  if [ -d "$_CORE/$_THIS_PRNAME-$_OPENSCHOLAR-old" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_OPENSCHOLAR-old $_CORE/$_THIS_PRNAME-$_OPENSCHOLAR
  fi
  replace_drupal6_core
  rm -f -r $_THIS_PRPATH/modules/contrib/memcache &> /dev/null
  sed -i "s/'features',/'features', 'robotstxt', 'path_alias_cache',/g" $_THIS_PRPATH/$_THIS_PRNAME.profile
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
fi
init_this_distro_root
if [ ! -L "./sites/all/libraries/shadowbox" ] ; then
  ln -s $_THIS_PRPATH/libraries/shadowbox ./sites/all/libraries/shadowbox
fi
if [ ! -L "./sites/all/libraries/tinymce" ] ; then
  ln -s $_THIS_PRPATH/libraries/tinymce ./sites/all/libraries/tinymce
fi
msg "DISTRO: $_F_OPENSCHOLAR installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENSCHOLAR installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


panopoly_install () {
###---### Panopoly
#
_THIS_PRNAME="panopoly"
_THIS_DISTRO="$_THIS_PRNAME-$_PANOPOLY-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
_THIS_PLPATH="$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OCH ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_PANOPOLY - http://drupal.org/project/panopoly" ; then
true
msg "DISTRO: $_F_PANOPOLY installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  wget -q -U iCab http://ftp.drupal.org/files/projects/$_THIS_PRNAME-$_PANOPOLY-core.tar.gz
  tar -xzf $_THIS_PRNAME-$_PANOPOLY-core.tar.gz &> /dev/null
  rm -f $_THIS_PRNAME-$_PANOPOLY-core.tar.gz
  rename_drupal7_distro_directory
  if [ -d "$_CORE/$_THIS_PRNAME-$_PANOPOLY" ] ; then
    mv $_THIS_PRNAME-$_PANOPOLY $_THIS_DISTRO
  fi
  replace_drupal7_core
  init_core_distro_seven_root
  remove_default_core_seven_profiles
  create_dirs
  themes_for_d7
  rm -f -r $_THIS_PRPATH/modules/contrib/redis &> /dev/null
  sed -i "s/^dependencies.*search_api_solr.*//g" $_THIS_PRPATH/$_THIS_PRNAME.info &> /dev/null
  sed -i "s/^dependencies.*redis.*//g" $_THIS_PRPATH/$_THIS_PRNAME.info &> /dev/null
  cd $_THIS_PRPATH/modules
  wget -q -U iCab http://files.aegir.cc/dev/distro/panopoly_apps.tar.gz
  tar -xzf panopoly_apps.tar.gz
  rm -f panopoly_apps.tar.gz
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_PANOPOLY installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_PANOPOLY installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


prosepoint_install () {
###---### Prosepoint
#
_THIS_PRNAME="prosepoint"
_THIS_DISTRO="$_THIS_PRNAME-$_PROSEPOINT-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_CLIENT_CORES" -ge "1" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ PPT ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_PROSEPOINT - http://prosepoint.org" ; then
true
msg "DISTRO: $_F_PROSEPOINT installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  if [ -d "$_CORE/$_THIS_PRNAME-$_PROSEPOINT" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_PROSEPOINT $_CORE/$_THIS_PRNAME-$_PROSEPOINT-old
  fi
  wget -q -U iCab http://launchpad.net/$_THIS_PRNAME/trunk/$_PROSEPOINT/+download/$_THIS_PRNAME-$_PROSEPOINT.tar.gz
  tar -xzf $_THIS_PRNAME-$_PROSEPOINT.tar.gz
  rm -f $_THIS_PRNAME-$_PROSEPOINT.tar.gz
  mv $_CORE/$_THIS_PRNAME-$_PROSEPOINT $_CORE_DISTRO
  if [ -d "$_CORE/$_THIS_PRNAME-$_PROSEPOINT-old" ] ; then
    mv $_CORE/$_THIS_PRNAME-$_PROSEPOINT-old $_CORE/$_THIS_PRNAME-$_PROSEPOINT
  fi
  replace_drupal6_core
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
  add_drupal6_translations
fi
init_this_distro_root
msg "DISTRO: $_F_PROSEPOINT installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_PROSEPOINT installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


ubercart6_install () {
###---### Ubercart
#
_THIS_PRNAME="uberdrupal"
_THIS_DINAME="ubercart"
_THIS_DISTRO="$_THIS_DINAME-$_UBERCART-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ UCT ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_UBERCART - http://ubercart.org" ; then
true
msg "DISTRO: $_F_UBERCART installation in progress..."
mrun "sleep 1"
if [ -d "$_CORE_DISTRO" ] && [ ! -e "$_CORE_DISTRO/fixed_1.log" ] ; then
  rm -f -r $_CORE_DISTRO
fi
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  if [ -d "$_CORE/$_THIS_DINAME-$_UBERCART" ] ; then
    mv $_CORE/$_THIS_DINAME-$_UBERCART $_CORE/$_THIS_DINAME-$_UBERCART-old
  fi
  wget -q -U iCab http://files.aegir.cc/dev/distro/$_THIS_DINAME-$_UBERCART.tar.gz
  tar -xzf $_THIS_DINAME-$_UBERCART.tar.gz
  rm -f $_THIS_DINAME-$_UBERCART.tar.gz
  mv $_THIS_DINAME-$_UBERCART $_THIS_DISTRO
  if [ -d "$_CORE/$_THIS_DINAME-$_UBERCART-old" ] ; then
    mv $_CORE/$_THIS_DINAME-$_UBERCART-old $_CORE/$_THIS_DINAME-$_UBERCART
  fi
  replace_drupal6_core
  enable_drupal6_contrib
  rm -f -r $_CORE_DISTRO/profiles/default
  mkdir -p $_THIS_PRPATH/libraries
  cd $_THIS_PRPATH/libraries
  wget -q -U iCab http://jacklmoore.com/colorbox/colorbox.zip
  unzip -qq colorbox.zip &> /dev/null
  rm -f colorbox.zip
  cd $_THIS_PRPATH/modules
  wget -q -U iCab http://ftp.drupal.org/files/projects/admin_menu-6.x-3.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/cck-6.x-2.9.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/colorbox-6.x-1.2.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/filefield-6.x-3.10.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/google_analytics-6.x-3.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/imageapi-6.x-1.10.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/imagecache-6.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/imagefield-6.x-3.10.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/libraries-6.x-1.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/lightbox2-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/rules-6.x-1.4.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/skinr-6.x-1.6.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/token-6.x-1.18.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/ubercart-6.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/views-6.x-3.0.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  ### http://drupal.org/node/1167276#comment-5138248
  cd $_THIS_PRPATH/modules/$_THIS_DINAME
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_THIS_DINAME-1167276-reroll.patch ./
  patch -p1 < $_THIS_DINAME-1167276-reroll.patch &> /dev/null
  cd $_THIS_PRPATH/modules/imagecache
  # http://drupal.org/node/1243258#comment-4850634
  wget -q -U iCab http://drupal.org/files/issues/imagecache-1243258-5.patch
  patch -p1 < imagecache-1243258-5.patch &> /dev/null
  cd $_THIS_PRPATH/themes
  wget -q -U iCab http://ftp.drupal.org/files/projects/fusion-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/acquia_prosper-6.x-1.1.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  create_dirs
  add_drupal6_translations
  touch $_CORE_DISTRO/fixed_1.log
fi
init_this_distro_root
msg "DISTRO: $_F_UBERCART installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_UBERCART installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


ubercart7_install () {
###---### Ubercart 3.1.1
#
_THIS_PRNAME="acquia"
_THIS_DISTRO="ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ UC7 ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO" ] ; then
echo " "
if prompt_yes_no "$_F_UBER_CART_SEVEN - http://ubercart.org" ; then
true
msg "DISTRO: $_F_UBER_CART_SEVEN installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  cd $_CORE
  git clone git://git.acquia.com/drupal/branches/7.x.git $_CORE_DISTRO &> /dev/null
  rm -f -r $_CORE_DISTRO/.git
  replace_drupal7_core
  init_core_distro_seven_root
  sed -i "s/Acquia Drupal/UberCart 3 Acquia\nold_short_name = uberdrupal/g" $_THIS_PRPATH/acquia.info &> /dev/null
  sed -i "s/Acquia enchanced Drupal/Acquia with UberCart 3/g" $_THIS_PRPATH/acquia.info &> /dev/null
  rm -f -r $_CORE_DISTRO/profiles/minimal
  rm -f -r $_CORE_DISTRO/profiles/testing
  sed -i "s/name = Standard/name = Vanilla Standard/g" $_CORE_DISTRO/profiles/standard/standard.info &> /dev/null
  sed -i "s/Vanilla Standard/Vanilla Standard\nold_short_name = minimal/g" $_CORE_DISTRO/profiles/standard/standard.info &> /dev/null
  rm -f -r $_THIS_PRPATH/modules/sqlsrv
  rm -f -r $_THIS_PRPATH/modules/token
  mkdir -p $_THIS_PRPATH/libraries
  cd $_THIS_PRPATH/libraries
  wget -q -U iCab http://jacklmoore.com/colorbox/colorbox.zip
  unzip -qq colorbox.zip &> /dev/null
  rm -f colorbox.zip
  cd $_THIS_PRPATH/modules
  rm -f -r ctools
  wget -q -U iCab http://ftp.drupal.org/files/projects/colorbox-7.x-1.3.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/ctools-7.x-1.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/entity-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/google_analytics-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/libraries-7.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/rules-7.x-2.1.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/token-7.x-1.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/ubercart-7.x-3.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/views-7.x-3.3.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  create_dirs
  themes_for_d7
fi
init_this_distro_root
create_d7_symlinks
patch_d7_core
msg "DISTRO: $_F_UBER_CART_SEVEN installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_UBER_CART_SEVEN installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


videola_install () {
###---### Videola Make
#
_THIS_PRNAME="videola"
_THIS_DISTRO="$_THIS_PRNAME-$_VIDEOLA-$_SMALLCORE6"
_CORE_DISTRO="$_CORE/$_THIS_DISTRO"
_THIS_PRPATH="$_CORE_DISTRO/profiles/$_THIS_PRNAME"
if [ "$_ALLOW_FOUR" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ VOA ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_THIS_DISTRO/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_VIDEOLA - http://videola.tv" ; then
true
msg "DISTRO: $_F_VIDEOLA installation in progress..."
mrun "sleep 1"
if [ ! -d "$_CORE_DISTRO" ] ; then
  if [ ! -e "$_THIS_CTRL" ] ; then
    prepare_pressflow_core
  fi
  cd $_CORE
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/$_THIS_PRNAME.make ./
  $_ROOT/tools/drush/drush make $_THIS_PRNAME.make $_THIS_DISTRO &> /dev/null
  rm -f $_THIS_PRNAME.make
  replace_drupal6_core
  if [ $_VIDEOLA = "6.x-1.0-alpha2" ] ; then
    cd $_THIS_PRPATH
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_THIS_PRNAME.patch ./
    patch -p1 < $_THIS_PRNAME.patch &> /dev/null
  fi
  rm -f -r $_CORE_DISTRO/profiles/default
  create_dirs
fi
init_this_distro_root
msg "DISTRO: $_F_VIDEOLA installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_VIDEOLA installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


acquia_install
civicrm_m6_install
civicrm_m7_install
civicrm3_install
civicrm4_install
cod_install
commerce_install
commons_install
drupal5_install
drupal6_install
drupal7_install
drupal8_install
elms_install
fserver_install
managingnews_install
martplug_install
nodestream6_install
nodestream7_install
octopus_video_install
openatrium_install
openchurch_install
opendeals_install
openoutreach_install
openpublic_install
openpublish_install
openscholar_install
panopoly_install
prosepoint_install
ubercart6_install
ubercart7_install
videola_install


###---### remove some module and themes for all
#
echo " "
msg "$_STATUS C: Removing some old core themes, please wait..."
rm -f -r $_CORE/*/themes/bluemarine
rm -f -r $_CORE/*/themes/chameleon
rm -f -r $_CORE/*/themes/pushbutton
rm -f -r $_CORE/*/scripts
rm -f $_CORE/*/themes/README.txt
rm -f $_CORE/*.make
rm -f $_CORE/*.tar.gz
cd $_CORE


###---### Save & verify platforms
#
msg "$_STATUS C: Running Platforms Save & Verify tasks, please wait..."
_LOCAL_STATUS="NOT_SET"
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _LOCAL_STATUS=INIT
fi
if [ "$_LOCAL_STATUS" = "INIT" ] ; then
  _THIS_HOSTMASTER="$_AEGIR_ROOT/sites/$_DOMAIN"
  #msg "_THIS_HOSTMASTER is read static $_THIS_HOSTMASTER because _LOCAL_STATUS is $_LOCAL_STATUS"
else
  if [ -e "$_ROOT/.drush/hostmaster.alias.drushrc.php" ] ; then
    _THIS_HOSTMASTER=`cat $_ROOT/.drush/hostmaster.alias.drushrc.php | grep 'site_path' | cut -d: -f2 | awk '{ print $3}'`
    _THIS_HOSTMASTER=`echo $_THIS_HOSTMASTER | sed "s/[\,']//g"`
    #msg "_THIS_HOSTMASTER is $_THIS_HOSTMASTER - read from $_ROOT/.drush/hostmaster.alias.drushrc.php"
  else
    _THIS_HOSTMASTER="$_AEGIR_ROOT/sites/$_DOMAIN"
    #msg "_THIS_HOSTMASTER is read static $_THIS_HOSTMASTER"
  fi
fi
if [ -d "$_THIS_HOSTMASTER" ] ; then
  #msg "_THIS_HOSTMASTER is $_THIS_HOSTMASTER (1)"
  cd $_THIS_HOSTMASTER
else
  _THIS_HOSTMASTER="$_PREV_AEGIR_ROOT/sites/$_DOMAIN"
  #msg "_THIS_HOSTMASTER is $_THIS_HOSTMASTER (2)"
  cd $_THIS_HOSTMASTER
fi
if [ $_DRUSH_FAMILY = "3" ] ; then
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/helpers/make_platform_3.php.txt ./
  mv -f make_platform_3.php.txt make_platform.php &> /dev/null
else
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/helpers/make_platform.php.txt ./
  mv -f make_platform.php.txt make_platform.php &> /dev/null
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_ACQUIA" acquia $_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_CIVICRM_M6" default $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_CIVICRM_M7" default $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM6-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM6-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_CIVICRM6" default $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM6-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM7-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM7-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_CIVICRM7" default $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM7-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_COD" cod $_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_COMMERCE" commerce $_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/commons-$_COMMONS-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/commons-$_COMMONS-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_COMMONS" drupal_commons $_ROOT/distro/$_THIS_CORE/commons-$_COMMONS-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_DRUPAL5" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow-$_DRUPAL5/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL5" default $_ROOT/distro/$_THIS_CORE/pressflow-$_DRUPAL5 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_D" default $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_S" default $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_P" default $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod &> /dev/null
      mrun "sleep 5"
    fi
  fi
elif [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_P" default $_ROOT/distro/$_THIS_CORE/pressflow &> /dev/null
      mrun "sleep 5"
    fi
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7D" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7D/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_D" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7D &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7S" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7S/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_S" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7S &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_P" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7P &> /dev/null
      mrun "sleep 5"
    fi
  fi
elif [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_P" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7 &> /dev/null
      mrun "sleep 5"
    fi
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL8" standard $_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/elms-$_ELMS-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/elms-$_ELMS-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_ELMS" elms $_ROOT/distro/$_THIS_CORE/elms-$_ELMS-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_FSERVER" feature_server $_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_MANAGINGNEWS" managingnews $_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/martplug-$_MARTPLUG-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/martplug-$_MARTPLUG-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_MARTPLUG" martplug $_ROOT/distro/$_THIS_CORE/martplug-$_MARTPLUG-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM6-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM6-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_NODESTREAM6" nodestream $_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM6-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_NODESTREAM7" nodestream $_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/octopus_video-$_OCTOPUS_VIDEO-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/octopus_video-$_OCTOPUS_VIDEO-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OCTOPUS_VIDEO" octopus_video $_ROOT/distro/$_THIS_CORE/octopus_video-$_OCTOPUS_VIDEO-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENATRIUM" openatrium $_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENCHURCH" openchurch $_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/opendeals-$_OPENDEALS-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/opendeals-$_OPENDEALS-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENDEALS" opendeals $_ROOT/distro/$_THIS_CORE/opendeals-$_OPENDEALS-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENOUTREACH" openoutreach $_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openpublic-$_OPENPUBLIC-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openpublic-$_OPENPUBLIC-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENPUBLIC" openpublic $_ROOT/distro/$_THIS_CORE/openpublic-$_OPENPUBLIC-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENPUBLISH" openpublish $_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENSCHOLAR" openscholar $_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_PANOPOLY" panopoly $_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_PROSEPOINT" prosepoint $_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_UBERCART" uberdrupal $_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_UBER_CART_SEVEN" acquia $_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/videola-$_VIDEOLA-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/videola-$_VIDEOLA-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_VIDEOLA" videola $_ROOT/distro/$_THIS_CORE/videola-$_VIDEOLA-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openenterprise-$_OPENENTERPRISE-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openenterprise-$_OPENENTERPRISE-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENENTERPRISE" openenterprise $_ROOT/distro/$_THIS_CORE/openenterprise-$_OPENENTERPRISE-$_SMALLCORE6 &> /dev/null
    mrun "sleep 5"
  fi
fi
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _PLATF_IMP=$(ls -la /data/u | grep $_USER | cut -d'>' -f2 | sort | uniq | awk '{ print $1}')
  for _PLATF in $_PLATF_IMP ; do
    if [[ $_PLATF =~ aegir ]] ; then
	  _FOUND_HM=YES
    else
      _PLATF_NAME=${_PLATF##*/}
      $_DRUSHCMD php-script make_platform "$_PLATF_NAME ($RANDOM)" default $_PLATF
      mrun "sleep 1"
    fi
  done
fi
rm -f make_platform.php

touch /opt/tmp/status-AegirSetupC-OK

###----------------------------------------###
###
###  Octopus Aegir Installer
###  Copyright (C) 2010-2012 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###----------------------------------------###
