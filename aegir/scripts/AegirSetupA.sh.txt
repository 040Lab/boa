#!/bin/bash


###----------------------------------------###
###
###  Octopus Aegir Installer
###
###  Copyright (C) 2010-2012 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: http://code.aegir.cc/aegir
###
###----------------------------------------###


###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###

_INSTALLER_VERSION=EDIT_INSTALLER_VERSION


###---### distro config
#
_CIVICRM_M6=EDIT_CIVICRM_M6
_CIVICRM_M7=EDIT_CIVICRM_M7
_CIVICRM6=EDIT_CIVICRM6
_CIVICRM7=EDIT_CIVICRM7
_COD=EDIT_COD
_COMMERCE=EDIT_COMMERCE
_COMMONS=EDIT_COMMONS
_DRUPAL5=EDIT_DRUPAL5
_DRUPAL7=EDIT_DRUPAL7
_DRUPAL7D="EDIT_DRUPAL7-dev"
_DRUPAL7P="EDIT_DRUPAL7-prod"
_DRUPAL7S="EDIT_DRUPAL7-stage"
_DRUPAL8=EDIT_DRUPAL8
_ELMS=EDIT_ELMS
_MANAGINGNEWS=EDIT_MANAGINGNEWS
_MART_PLUG=EDIT_MART_PLUG
_MARTPLUG=EDIT_MARTPLUG
_NODESTREAM6=EDIT_NODESTREAM6
_NODESTREAM7=EDIT_NODESTREAM7
_OCTOPUS_VIDEO=EDIT_OCTOPUS_VIDEO
_OPEN_DEALS=EDIT_OPEN_DEALS
_OPENACADEMY=EDIT_OPENACADEMY
_OPENATRIUM=EDIT_OPENATRIUM
_OPENCHURCH=EDIT_OPENCHURCH
_OPENDEALS=EDIT_OPENDEALS
_OPENENTERPRISE=EDIT_OPENENTERPRISE
_OPENOUTREACH=EDIT_OPENOUTREACH
_OPENPUBLIC=EDIT_OPENPUBLIC
_OPENPUBLISH=EDIT_OPENPUBLISH
_OPENSCHOLAR=EDIT_OPENSCHOLAR
_PANOPOLY=EDIT_PANOPOLY
_PROSEPOINT=EDIT_PROSEPOINT
_SMALLCORE_6_LANG=EDIT_SMALLCORE_6_LANG
_SMALLCORE6=EDIT_SMALLCORE6
_SMALLCORE7=EDIT_SMALLCORE7
_SMALLCORE8=EDIT_SMALLCORE8
_UBER_CART_SEVEN=EDIT_UBER_CART_SEVEN
_UBERCART=EDIT_UBERCART
_VIDEOLA=EDIT_VIDEOLA


###---### main config
#
_ADM_EMAIL="EDIT_MY_EMAIL"
_AEGIR_VERSION=EDIT_AEGIR_VERSION
_ALL_DISTRO=EDIT_ALL_DISTRO
_AUTOPILOT=EDIT_AUTOPILOT
_BOA_REPO_GIT_URL=EDIT_BOA_REPO_GIT_URL
_BOA_REPO_NAME=EDIT_BOA_REPO_NAME
_CLIENT_CORES=EDIT_CLIENT_CORES
_CLIENT_EMAIL="EDIT_CLIENT_EMAIL"
_CLIENT_OPTION=EDIT_CLIENT_OPTION
_DEBUG_MODE=EDIT_DEBUG_MODE
_DIST_INSTALL=NO
_DISTRO=EDIT_DISTRO
_DOMAIN=EDIT_DOMAIN
_DRUSH_FAMILY=EDIT_DRUSH_FAMILY
_DRUSH_VERSION=EDIT_DRUSH_VERSION
_HM_DISTRO=EDIT_HM_DISTRO
_HM_ONLY=EDIT_HM_ONLY
_HOT_SAUCE=EDIT_HOT_SAUCE
_LAST_ALL=EDIT_LAST_ALL
_LAST_HMR=EDIT_LAST_HMR
_LASTNUM=EDIT_LASTNUM
_NOW=EDIT_NOW
_O_CONTRIB_UP=EDIT_O_CONTRIB_UP
_PHP_CLI_VERSION=EDIT_PHP_CLI_VERSION
_PHP_FPM_VERSION=EDIT_PHP_FPM_VERSION
_PHP_MODERN_ONLY=EDIT_PHP_MODERN_ONLY
_PLATFORMS_LIST="EDIT_PLATFORMS_LIST"
_PLATFORMS_ONLY=EDIT_PLATFORMS_ONLY
_PURGE_FOR_SEVEN=EDIT_PURGE_FOR_SEVEN
_PURGE_MODE=EDIT_PURGE_MODE
_REL_VERSION=`lsb_release -sc`
_REMOTE_CACHE_IP=EDIT_REMOTE_CACHE_IP
_SPINNER=EDIT_SPINNER
_STATUS=INIT
_THIS_DB_HOST=EDIT_THIS_DB_HOST
_THIS_OS=`lsb_release -si`
_THISHTIP=EDIT_THISHTIP
_USE_CURRENT=EDIT_USE_CURRENT
_USRG=EDIT_USRG
_WEBG=EDIT_WEBG
#
_USER=EDIT_USER
_ROOT="/data/disk/$_USER"
_AEGIR_ROOT="$_ROOT/aegir/distro/$_HM_DISTRO"
_DISTRO_ROOT="$_ROOT/distro/$_DISTRO"
#
if [ "$_PHP_CLI_VERSION" = "5.3" ] && [ -x "/opt/local/bin/php" ] ; then
  _L_PHP_CLI=/opt/local/bin
else
  _L_PHP_CLI=/usr/local/bin
fi
SHELL=/bin/bash
PATH=$_L_PHP_CLI:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin


###---### Functions
# noticeable messages
msg() {
  echo "Octopus [`date`] ==> $*"
}
#
# Success msg
success () {
	msg "$1 Succeeded"
}
#
# Error msg
fatal () {
	echo " "
	msg "Fatal Error Occurred: $1"
	msg "Cannot continue installation"
	touch /opt/tmp/status-AegirSetupA-FAIL
	exit 1
}
#
# Silent runner.
st_runner () {
  CMD="$1"
  touch busy
  if [ "$_SPINNER" = "YES" ] ; then
    bash $_SRCDIR/spinner busy &
  fi
  if $CMD >> $_LOG; then
    rm busy
    sleep 1
    return 0
  else
    rm busy
    sleep 1
    echo "$CMD failed.  Error (if any): $?"
    echo " "
    echo "Displaying the last 15 lines of $_LOG to help troubleshoot this problem"
    echo " "
    tail -15 $_LOG
    return 1
  fi
}
#
# Small spinner
mrun () {
	CMD="$1"
	touch busy
	if [ "$_SPINNER" = "YES" ] ; then
	  bash $_SRCDIR/spinner busy &
	fi
	if $CMD >> $_LOG; then
		rm busy
		sleep 1
		return 0
	fi
}
#
# Simple prompt
prompt_yes_no () {
if [ "$_AUTOPILOT" = "YES" ] ; then
  return 0
else
  while true ; do
    printf "$* [Y/n] "
    read answer
    if [ -z "$answer" ] ; then
      return 0
    fi
    case $answer in
      [Yy]|[Yy][Ee][Ss])
        return 0
        ;;
      [Nn]|[Nn][Oo])
        return 1
        ;;
      *)
        echo "Please answer yes or no"
        ;;
    esac
 done
fi
}
#
# Escape borrowed from mysql_secure_installation.
basic_single_escape () {
  # The quoting on this sed command is a bit complex.  Single-quoted strings
  # don't allow *any* escape mechanism, so they cannot contain a single
  # quote.  The string sed gets (as argv[1]) is:  s/\(['\]\)/\\\1/g
  #
  # Inside a character class, \ and ' are not special, so the ['\] character
  # class is balanced and contains two characters.
  echo "$1" | sed 's/\(['"'"'\]\)/\\\1/g'
}
#
# Set or update Redis password..
update_redis_password () {
  if [ ! -e "/root/.redis.pass.txt" ] && [ -e "/etc/redis/redis.conf" ] ; then
    msg "INIT A: Generate random password for Redis server"
    touch /root/.redis.pass.txt
    chmod 0600 /root/.redis.pass.txt &> /dev/null
    _ESC_RPASS=`pwgen -v -s -1`
    _ESC_RPASS=`basic_single_escape "$_ESC_RPASS"`
    echo "$_ESC_RPASS" > /root/.redis.pass.txt
  fi
  if [ -e "/root/.redis.pass.txt" ] && [ -e "/etc/redis/redis.conf" ] ; then
    RPASS=`cat /root/.redis.pass.txt`
    RPASS=`echo -n $RPASS | tr -d "\n"`
    sed -i "s/^requirepass.*/requirepass $RPASS/g" /etc/redis/redis.conf &> /dev/null
    sed -i "s/isfoobared/$RPASS/g" /data/conf/global.inc                 &> /dev/null
    sed -i "s/isfoobared/$RPASS/g" /var/aegir/config/includes/global.inc &> /dev/null
  fi
}
#
# stop on error
# set -e ### disabled for debugging
#
_SRCDIR=/opt/tmp/files
_LOG=/var/backups/octopus-$_USER-$_NOW.log
#
# Create shared dirs
create_shared_dirs () {
  msg "$_STATUS A: Creating shared directories, please wait..."
  if [ ! -d "$_CORE" ] ; then
    mkdir -p $_CORE
    mkdir -p /data/src
  fi
  chown $_USER:$_USRG /data/all &> /dev/null
  chown $_USER:$_USRG $_CORE &> /dev/null
  if [ ! -e "$_CORE/o_contrib/ctrl-$_INSTALLER_VERSION" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
    chown -R $_USER:$_USRG $_CORE/o_contrib &> /dev/null
  fi
  if [ ! -e "$_CORE/o_contrib_seven/ctrl-$_INSTALLER_VERSION" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
    chown -R $_USER:$_USRG $_CORE/o_contrib_seven &> /dev/null
  fi
  if [ ! -e "/data/all/$_LAST_ALL/o_contrib/ctrl-$_INSTALLER_VERSION" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
    chown -R $_USER:$_USRG /data/all/$_LAST_ALL/o_contrib &> /dev/null
  fi
  if [ ! -e "/data/all/$_LAST_ALL/o_contrib_seven/ctrl-$_INSTALLER_VERSION" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
    chown -R $_USER:$_USRG /data/all/$_LAST_ALL/o_contrib_seven &> /dev/null
  fi
  chown -R $_USER:$_USRG /data/src &> /dev/null
  chown -R $_USER:$_USRG /opt/tmp &> /dev/null
  chown -R $_USER:$_USRG /data/conf &> /dev/null
  chown -R $_USER:$_USRG /data/all/000 &> /dev/null
  chmod 777 $_CORE /data/all /data/src /data /data/disk /data/conf &> /dev/null
}
#
# fix for FServer broken due to required now strongarm
#
feature_server_fix_002 () {
if [ ! -e "/var/log/feature-server-fixed-002.log" ] ; then
msg "UPGRADE A: Adding missing strongarm module to old fserver platforms"
REVISIONS="001 002 003 004 005 006 007 008 009 010 011 012 013 014"
for i in $REVISIONS; do
  if [ -d "/data/all/$i/fserver" ] ; then
    if [ ! -d "/data/all/$i/fserver/profiles/feature_server/modules/strongarm" ] ; then
      cd; /var/aegir/drush/drush dl strongarm-6.x-2.1 --destination=/data/all/$i/fserver/profiles/feature_server/modules &> /dev/null
      cd /data/all/$i/fserver/profiles/feature_server
      rm -f feature_server.make
      rm -f feature_server.profile
      cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/feature_server.make ./
      cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/feature_server.profile ./
      if [ -e "$_ROOT/.drush/hostmaster.alias.drushrc.php" ] ; then
        _THIS_HOSTMASTER=`cat $_ROOT/.drush/hostmaster.alias.drushrc.php | grep 'site_path' | cut -d: -f2 | awk '{ print $3}' | sed "s/[\,']//g"`
        cd _THIS_HOSTMASTER &> /dev/null
        su -s /bin/bash $_USER -c "drush --root=/data/disk/$_USER/distro/$i/fserver provision-save @platform_FeatureServerPF$i &> /dev/null"
      fi
      msg "UPGRADE A: Missing strongarm added to /data/all/$i/fserver"
    fi
  fi
done
touch /var/log/feature-server-fixed-002.log
cd
fi
}
#
# update o_contrib
#
o_contrib_update_global () {
REVISIONS="001 002 003 004 005 006 007 008 009 010 011 012 013 014 015 016 017 018 019 020 021 022 023 024 025 026 027"
RMMODULES="drupal-nginx-fast-x-accel-redirect varnish bakery session443 cookie_cache_bypass_adv module_supports backup_migrate purge expire imageinfo_cache"
for i in $REVISIONS; do
  if [ -d "/data/all/$i/o_contrib" ] && [ ! -e "/data/all/$i/o_contrib/update-010.info" ] ; then
    for m in $RMMODULES; do
      if [ -d "/data/all/$i/o_contrib/$m" ] ; then
        rm -f -r /data/all/$i/o_contrib/$m
        msg "UPGRADE A: Removed /data/all/$i/o_contrib/$m"
      fi
    done
    cd /data/all/$i/o_contrib
    if [ -d "/data/all/$i/o_contrib/boost" ] ; then
      sed -i "s/is_dir(\$cache_directory/\!is_dir(\$cache_directory/g" /data/all/$i/o_contrib/boost/boost.install &> /dev/null
      sed -i "s/\!\!is_dir/\!is_dir/g" /data/all/$i/o_contrib/boost/boost.install &> /dev/null
    fi
    wget -q -U iCab http://ftp.drupal.org/files/projects/backup_migrate-6.x-2.6.tar.gz
    if [ "$_PURGE_MODE" = "ON" ] ; then
      git clone --branch 6.x-1.x-revert git://github.com/omega8cc/purge.git /data/all/$i/o_contrib/purge &> /dev/null
      git clone --branch 6.x-1.x http://git.drupal.org/project/expire.git /data/all/$i/o_contrib/expire &> /dev/null
      rm -f -r /data/all/$i/o_contrib/purge/.git
      rm -f -r /data/all/$i/o_contrib/expire/.git
    fi
    for archive in ./*.tar.gz; do
      tar -xzf "$archive" &> /dev/null
    done
    rm -f *.tar.gz
    if [ -d "/data/all/$i/o_contrib/cache_backport" ] ; then
      rm -f -r /data/all/$i/o_contrib/cache_backport
    fi
    if [ -d "/data/all/$i/o_contrib/redis" ] ; then
      rm -f -r /data/all/$i/o_contrib/redis
    fi
    if [ -e "/data/all/000/modules/cache_backport" ] && [ ! -L "/data/all/$i/o_contrib/cache_backport" ] ; then
      ln -s /data/all/000/modules/cache_backport /data/all/$i/o_contrib/cache_backport
    fi
    if [ -e "/data/all/000/modules/redis" ] && [ ! -L "/data/all/$i/o_contrib/redis" ] ; then
      ln -s /data/all/000/modules/redis /data/all/$i/o_contrib/redis
    fi
    touch /data/all/$i/o_contrib/update-010.info
    msg "UPGRADE A: New modules in /data/all/$i/o_contrib: purge expire backup_migrate"
  fi
  if [ -d "/data/all/$i" ] ; then
    for p in `find /data/all/$i/ -maxdepth 1 -mindepth 1 -type d | sort`; do
      if [ -d "$p/modules/cookie_cache_bypass" ] ; then
        rm -f -r $p/modules/cookie_cache_bypass
      fi
    done
  fi
done
cd
}
#
# update o_contrib_seven
#
o_contrib_seven_update_global () {
REVISIONS="001 002 003 004 005 006 007 008 009 010 011 012 013 014 015 016 017 018 019 020 021 022 023 024 025 026 027"
RMMODULES="session443 cookie_cache_bypass_adv purge expire agrcache"
for i in $REVISIONS; do
  if [ -d "/data/all/$i/o_contrib_seven" ] && [ ! -e "/data/all/$i/o_contrib_seven/update-010.info" ] ; then
    for m in $RMMODULES; do
      if [ -d "/data/all/$i/o_contrib_seven/$m" ] ; then
        rm -f -r /data/all/$i/o_contrib_seven/$m
        msg "UPGRADE A: Removed /data/all/$i/o_contrib_seven/$m"
      fi
    done
    if [ "$_PURGE_MODE" = "ON" ] && [ "$_PURGE_FOR_SEVEN" = "YES" ] ; then
      git clone --branch 7.x-1.x http://git.drupal.org/project/purge.git /data/all/$i/o_contrib_seven/purge &> /dev/null
      git clone --branch 7.x-1.x http://git.drupal.org/project/expire.git /data/all/$i/o_contrib_seven/expire &> /dev/null
      rm -f -r /data/all/$i/o_contrib_seven/purge/.git
      rm -f -r /data/all/$i/o_contrib_seven/expire/.git
    fi
    if [ -d "/data/all/$i/o_contrib_seven/redis" ] ; then
      rm -f -r /data/all/$i/o_contrib_seven/redis
    fi
    if [ -e "/data/all/000/modules/redis" ] && [ ! -L "/data/all/$i/o_contrib_seven/redis" ] ; then
      ln -s /data/all/000/modules/redis /data/all/$i/o_contrib_seven/redis
    fi
    touch /data/all/$i/o_contrib_seven/update-010.info
    msg "UPGRADE A: New modules in /data/all/$i/o_contrib_seven: purge expire"
  fi
done
cd
}
#
# Sub Force advanced Nginx configuration.
sub_force_advanced_nginx_config () {
  if [ -d "$_THIS_NGX_PATH" ] ; then
    if [ "$_PHP_FPM_VERSION" = "5.3" ] && [ -e "/opt/local/etc/php53-fpm.conf" ] ; then
      sed -i "s/127.0.0.1:9000/127.0.0.1:9090/g" $_THIS_NGX_PATH/nginx_octopus_include.conf &> /dev/null
    fi
  fi
}
#
# Force advanced Nginx configuration.
force_advanced_nginx_config () {
  validate_local_ip &> /dev/null
  _THIS_NGX_PATH=/data/disk/$_USER/.drush/provision/http/Provision/Service/http
  sub_force_advanced_nginx_config
  _THIS_NGX_PATH=/data/disk/$_USER/config/includes
  sub_force_advanced_nginx_config
  if [ ! -L "/data/disk/$_USER/config/includes/nginx_advanced_include.conf" ] ; then
    rm -f /data/disk/$_USER/config/includes/nginx_advanced_include.conf
    ln -s /data/disk/$_USER/config/includes/nginx_octopus_include.conf /data/disk/$_USER/config/includes/nginx_advanced_include.conf
  fi
  if [ ! -L "/data/disk/$_USER/config/includes/nginx_simple_include.conf" ] ; then
    rm -f /data/disk/$_USER/config/includes/nginx_simple_include.conf
    ln -s /data/disk/$_USER/config/includes/nginx_legacy_include.conf /data/disk/$_USER/config/includes/nginx_simple_include.conf
  fi
}
#
# download_textile
download_textile () {
  cd textile
  svn export http://textpattern.googlecode.com/svn/development/4.x/textpattern/lib/classTextile.php &> /dev/null
  cp -af classTextile.php include/ &> /dev/null
  cd ../
}
#
# download_o_contrib_seven
download_o_contrib_seven () {
  touch update-010.info
  #msg "$_STATUS A: Downloading o_contrib_seven modules, please wait..."
  wget -q -U iCab http://ftp.drupal.org/files/projects/admin-7.x-2.0-beta3.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/backup_migrate-7.x-2.3.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/blockcache_alter-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/boost-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/config_perms-7.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/core_library-7.x-1.0-beta12.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/css_emimage-7.x-1.2.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/entitycache-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/esi-7.x-3.0-alpha1.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/filefield_nginx_progress-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/flood_control-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/fpa-7.x-2.2.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/httprl-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/nocurrent_pass-7.x-1.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/readonlymode-7.x-1.0-beta1.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/robotstxt-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/seckit-7.x-1.3.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/site_verify-7.x-1.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/speedy-7.x-1.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/taxonomy_edge-7.x-1.1.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/textile-7.x-2.0-rc11.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/variable_clean-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/vars-7.x-2.0-alpha10.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/views_content_cache-7.x-3.x-dev.tar.gz
  if [ "$_PURGE_MODE" = "ON" ] && [ "$_PURGE_FOR_SEVEN" = "YES" ] ; then
    rm -f -r expire*
    git clone --branch 7.x-1.x http://git.drupal.org/project/expire.git &> /dev/null
    rm -f -r expire/.git
    rm -f -r purge*
    git clone --branch 7.x-1.x http://git.drupal.org/project/purge.git &> /dev/null
    rm -f -r purge/.git
  else
    rm -f -r nginx_accel_redirect*
    rm -f -r purge*
    rm -f -r expire*
  fi
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  touch ctrl-$_INSTALLER_VERSION
  if [ ! -L "./redis" ] ; then
    ln -s /data/all/000/modules/redis redis
  fi
  download_textile
  if [ ! -e "/data/all/000/modules/redis/update-010.info" ] ; then
    mkdir -p /data/all/000/modules
    cd /data/all/000/modules
    rm -f -r /data/all/000/modules/redis
    wget -q -U iCab http://ftp.drupal.org/files/projects/redis-7.x-2.0-alpha9.tar.gz
    #git clone --branch 7.x-2.x git://github.com/omega8cc/redis.git &> /dev/null
    #rm -f -r redis/.git
    for archive in ./*.tar.gz; do
      tar -xzf "$archive" &> /dev/null
    done
    rm -f *.tar.gz
    rm -f redis/redis.info
    echo update > redis/update-010.info
  fi
}
#
# download_o_contrib_six
download_o_contrib_six () {
  touch update-010.info
  #msg "$_STATUS A: Downloading o_contrib modules, please wait..."
  wget -q -U iCab http://files.aegir.cc/dev/css_emimage-6.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/admin-6.x-2.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/backup_migrate-6.x-2.6.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/blockcache_alter-6.x-1.5.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/boost-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/config_perms-6.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/dbtuner-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/esi-6.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/filefield_nginx_progress-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/fpa-6.x-2.4.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/httprl-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/image-6.x-1.2.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/login_security-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/private_upload-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/readonlymode-6.x-1.1.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/robotstxt-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/seckit-6.x-1.3.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/securesite-6.x-2.4.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/site_verify-6.x-1.0.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/taxonomy_edge-6.x-1.3.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/textile-6.x-2.4.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/variable_clean-6.x-1.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/views_content_cache-6.x-2.x-dev.tar.gz
  wget -q -U iCab http://ftp.drupal.org/files/projects/views404-6.x-1.x-dev.tar.gz
  if [ "$_PURGE_MODE" = "ON" ] ; then
    rm -f -r expire*
    git clone --branch 6.x-1.x http://git.drupal.org/project/expire.git &> /dev/null
    rm -f -r expire/.git
    rm -f -r purge*
    git clone --branch 6.x-1.x-revert git://github.com/omega8cc/purge.git &> /dev/null
    rm -f -r purge/.git
  else
    rm -f -r nginx_accel_redirect*
    rm -f -r purge*
    rm -f -r expire*
  fi
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  touch ctrl-$_INSTALLER_VERSION
  if [ ! -L "./redis" ] ; then
    ln -s /data/all/000/modules/redis redis
  fi
  if [ ! -L "./cache_backport" ] ; then
    ln -s /data/all/000/modules/cache_backport cache_backport
  fi
  download_textile
  if [ ! -e "/data/all/000/modules/cache_backport/update-010.info" ] ; then
    mkdir -p /data/all/000/modules
    cd /data/all/000/modules
    rm -f -r /data/all/000/modules/cache_backport
    wget -q -U iCab http://ftp.drupal.org/files/projects/cache_backport-6.x-1.0-rc1.tar.gz
    for archive in ./*.tar.gz; do
      tar -xzf "$archive" &> /dev/null
    done
    rm -f *.tar.gz
    sed -i "s/Cache Backand/D7 Cache Backport for D6/g" cache_backport/cache_backport.info &> /dev/null
    echo update > cache_backport/update-010.info
  fi
  if [ ! -e "/data/all/000/modules/redis/update-010.info" ] ; then
    mkdir -p /data/all/000/modules
    cd /data/all/000/modules
    rm -f -r /data/all/000/modules/redis
    wget -q -U iCab http://ftp.drupal.org/files/projects/redis-7.x-2.0-alpha9.tar.gz
    #git clone --branch 7.x-2.x git://github.com/omega8cc/redis.git &> /dev/null
    #rm -f -r redis/.git
    for archive in ./*.tar.gz; do
      tar -xzf "$archive" &> /dev/null
    done
    rm -f *.tar.gz
    rm -f redis/redis.info
    echo update > redis/update-010.info
  fi
}
#
# upgrade_o_contrib
upgrade_o_contrib () {
if [ -e "$_CORE/o_contrib/ctrl-$_INSTALLER_VERSION" ] && [ -e "$_CORE/o_contrib_seven/ctrl-$_INSTALLER_VERSION" ] ; then
  _O_CONTRIB_UP=NO
fi
if [ -e "/data/all/$_LAST_ALL/o_contrib/ctrl-$_INSTALLER_VERSION" ] && [ -e "/data/all/$_LAST_ALL/o_contrib_seven/ctrl-$_INSTALLER_VERSION" ] ; then
  _O_CONTRIB_UP=NO
fi
if [ -d "$_CORE/o_contrib" ] ; then
  if [ ! -e "$_CORE/o_contrib/textile/include/classTextile.php" ] ; then
    _O_CONTRIB_UP=YES
  fi
fi
if [ -d "$_CORE/o_contrib_seven" ] ; then
  if [ ! -e "$_CORE/o_contrib_seven/textile/include/classTextile.php" ] ; then
    _O_CONTRIB_UP=YES
  fi
fi
if [ -d "/data/all/$_LAST_ALL/o_contrib" ] ; then
  if [ ! -e "/data/all/$_LAST_ALL/o_contrib/textile/include/classTextile.php" ] ; then
    _O_CONTRIB_UP=YES
  fi
fi
if [ -d "/data/all/$_LAST_ALL/o_contrib_seven" ] ; then
  if [ ! -e "/data/all/$_LAST_ALL/o_contrib_seven/textile/include/classTextile.php" ] ; then
    _O_CONTRIB_UP=YES
  fi
fi
if [ ! -e "$_THIS_CTRL" ] ; then
  _O_CONTRIB_UP=YES
fi
if [ ! -e "/data/all/000/modules/redis/update-010.info" ] ; then
  _O_CONTRIB_UP=YES
fi
if [ "$_PURGE_MODE" = "ON" ] ; then
  _TEST_MODULE=purge
else
  _TEST_MODULE=textile
fi
if [ -d "/data/all/$_LAST_ALL/o_contrib" ] ; then
 if [ ! -d "/data/all/$_LAST_ALL/o_contrib/$_TEST_MODULE" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
  #msg "$_STATUS A: Running o_contrib upgrade #1, please wait..."
  cd /data/all/$_LAST_ALL/o_contrib
  rm -f -r *
  download_o_contrib_six
  cd /data/all/$_LAST_ALL/o_contrib
 fi
fi
if [ -d "$_CORE/o_contrib" ] ; then
 if [ ! -d "$_CORE/o_contrib/$_TEST_MODULE" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
  #msg "$_STATUS A: Running o_contrib upgrade #2, please wait..."
  cd $_CORE/o_contrib
  rm -f -r *
  download_o_contrib_six
  cd $_CORE/o_contrib
 fi
fi
if [ -d "/data/all/$_LAST_ALL/o_contrib_seven" ] ; then
 if [ ! -d "/data/all/$_LAST_ALL/o_contrib_seven/robotstxt" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
  #msg "$_STATUS A: Running o_contrib_seven upgrade #1, please wait..."
  cd /data/all/$_LAST_ALL/o_contrib_seven
  rm -f -r *
  download_o_contrib_seven
  cd /data/all/$_LAST_ALL/o_contrib_seven
 fi
fi
if [ -d "$_CORE/o_contrib_seven" ] ; then
 if [ ! -d "$_CORE/o_contrib_seven/robotstxt" ] || [ "$_O_CONTRIB_UP" = "YES" ] ; then
  #msg "$_STATUS A: Running o_contrib_seven upgrade #2, please wait..."
  cd $_CORE/o_contrib_seven
  rm -f -r *
  download_o_contrib_seven
  cd $_CORE/o_contrib_seven
 fi
fi
}
#
# manage_o_contrib
manage_o_contrib () {
  if [ ! -e "$_CORE/o_contrib_seven" ] ; then
    mkdir -p $_CORE/o_contrib_seven
    cd $_CORE/o_contrib_seven
    download_o_contrib_seven
    cd $_CORE/o_contrib_seven
  fi
  if [ ! -e "$_CORE/o_contrib" ] ; then
    mkdir -p $_CORE/o_contrib
    cd $_CORE/o_contrib
    download_o_contrib_six
    cd $_CORE/o_contrib
  fi
  if [ $_STATUS != "INIT" ] ; then
    msg "$_STATUS A: Running o_contrib modules check and upgrade, please wait..."
    upgrade_o_contrib
  fi
  if [ ! -e "/data/all/000/translations/drupal-$_SMALLCORE_6_LANG.pl.po" ] ; then
    if [ ! -d "/data/all/000/translations" ] ; then
      mkdir -p /data/all/000/translations
    else
      rm -f /data/all/000/translations/* &> /dev/null
    fi
    cd /data/all/000/translations
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.zh-hant.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.zh-hans.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.ca.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.da.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.nl.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.fr.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.de.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.hu.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.ja.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.nb.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.pl.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.pt-pt.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.pt-br.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.es.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.sv.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.el.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.et.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.it.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.uk.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.sk.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.fi.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.tr.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.cs.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.lt.po
    wget -q -U iCab http://ftp.drupal.org/files/translations/6.x/drupal/drupal-$_SMALLCORE_6_LANG.ru.po
  fi
}


msg "$_STATUS A: Aegir automated install script part A"


###---### Checking version..
#
msg "INFO A: Checking OCTOPUS version, please wait..."
if [ "$_AEGIR_VERSION" = "HEAD" ] ; then
  _FILE_VERSION=release.txt
else
  _FILE_VERSION=version.txt
fi
if [ -e "/opt/tmp/$_BOA_REPO_NAME/aegir/conf/$_FILE_VERSION" ] ; then
  _VERSIONS_TEST=`cat /opt/tmp/$_BOA_REPO_NAME/aegir/conf/$_FILE_VERSION`
  if [[ "$_VERSIONS_TEST" =~ "-dev" ]] ; then
    if [[ "$_VERSIONS_TEST" =~ "$_INSTALLER_VERSION" ]] && [ "$_AEGIR_VERSION" = "HEAD" ] ; then
      _VERSIONS_TEST_RESULT=OK
      msg "INFO A: Version test result: OK"
    else
      _VERSIONS_TEST_RESULT=FAIL
    fi
  else
    if [[ "$_VERSIONS_TEST" =~ "$_INSTALLER_VERSION" ]] && [[ "$_AEGIR_VERSION" =~ "BOA" ]] ; then
      _VERSIONS_TEST_RESULT=OK
      msg "INFO: Version test result: OK"
    else
      _VERSIONS_TEST_RESULT=FAIL
    fi
  fi
  if [ "$_VERSIONS_TEST_RESULT" = "FAIL" ] ; then
    msg "ERROR: This OCTOPUS version is outdated and will not work correctly"
    msg "Please download and use new stable version:"
    msg "wget -q -U iCab http://files.aegir.cc/versions/OCTOPUS.sh.txt"
    msg "You can also use (for testing) latest dev version:"
    msg "wget -q -U iCab http://drupalcode.org/project/barracuda.git/blob_plain/HEAD:/OCTOPUS.sh.txt"
    msg "Bye"
    touch /opt/tmp/status-AegirSetupA-FAIL
    exit 1
  fi
fi


###---### Checking status..
#
if [ -d "$_ROOT" ] ; then
  _STATUS=UPGRADE
  cd $_ROOT
  msg "$_STATUS A: $_STATUS"
  mrun "sleep 1"
  rm -f $_ROOT/AegirSetupC.sh.txt
  rm -f $_ROOT/AegirSetupB.sh.txt
else
  msg "$_STATUS A: $_STATUS"
fi


###---### Hot Sauce check..
#
if [ "$_HOT_SAUCE" = "NO" ] ; then
  _CORE="/data/all/$_LAST_ALL"
  _THIS_CORE="$_LAST_ALL"
  if [ "$_USE_CURRENT" = "YES" ] && [ -e "/data/all/000/translations/drupal-$_SMALLCORE_6_LANG.pl.po" ] ; then
    msg "$_STATUS A: Shared platforms code v.$_LAST_ALL (latest available) will be used for this install"
  elif [ "$_USE_CURRENT" = "NO" ] || [ ! -e "/data/all/000/translations/drupal-$_SMALLCORE_6_LANG.pl.po" ] ; then
    _CORE="/data/all/$_ALL_DISTRO"
    _THIS_CORE="$_ALL_DISTRO"
    msg "$_STATUS A: Shared platforms code v.$_ALL_DISTRO (hot new) will be created"
    sed -i "s/^_USE_CURRENT=.*/_USE_CURRENT=NO/g" /opt/tmp/$_BOA_REPO_NAME/aegir/scripts/AegirSetupC.sh.txt &> /dev/null
  else
    msg "$_STATUS A: Shared platforms code v.$_LAST_ALL (latest available) will be used for this install"
  fi
else
  _CORE="/data/all/$_ALL_DISTRO"
  _THIS_CORE="$_ALL_DISTRO"
  msg "$_STATUS A: Shared platforms code v.$_ALL_DISTRO (hot new) will be created"
fi
_THIS_CTRL="$_CORE/o_contrib/ctrl-$_INSTALLER_VERSION"


###---### Add required users and create directories
#
msg "$_STATUS A: Creating directories with correct permissions, please wait..."
mrun "sleep 1"
mkdir -p /data/u
mkdir -p /data/disk
mkdir -p /data/conf
chown root:root /data &> /dev/null
chown root:root /data/disk &> /dev/null
if [ ! -d "$_ROOT" ] ; then
  msg "$_STATUS A: Adding user, please wait..."
  mrun "sleep 1"
  adduser --system --home $_ROOT --ingroup $_USRG $_USER &> /dev/null
  adduser $_USER $_WEBG &> /dev/null
fi
chown -R $_USER:$_USRG /opt/tmp &> /dev/null
chown -R $_USER:$_USRG /data/conf &> /dev/null


###---### Prepare scripts
#
chmod 0711 $_ROOT
cd $_ROOT
cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/scripts/AegirSetupB.sh.txt ./
cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/scripts/AegirSetupC.sh.txt ./
chown $_USER:$_USRG $_ROOT/AegirSetupB.sh.txt &> /dev/null
chown $_USER:$_USRG $_ROOT/AegirSetupC.sh.txt &> /dev/null


###---### Run standard pre-install
#
if [ ! -e "$_ROOT/.$_USER.pass.txt" ] ; then
  touch $_ROOT/.$_USER.pass.txt
  chmod 0600 $_ROOT/.$_USER.pass.txt
  _ESC_PASS=`pwgen -v -s -1`
  _ESC_PASS=`basic_single_escape "$_ESC_PASS"`
  echo "$_ESC_PASS" > $_ROOT/.$_USER.pass.txt
  chown $_USER:$_USRG $_ROOT/.$_USER.pass.txt &> /dev/null
  echo "$_USER ALL=NOPASSWD: /etc/init.d/nginx" >> /etc/sudoers
fi
AGRPXSWD=`cat $_ROOT/.$_USER.pass.txt`
AGRPASWD=`echo -n $AGRPXSWD | tr -d "\n"`
AEGIR_HOST=`uname -n`
_RESOLVEIP=`resolveip $AEGIR_HOST 2> /dev/null`
if [ -z "$_RESOLVEIP" ] ; then
  msg "$_STATUS A: FATAL ERROR: This server does not have a hostname that resolves to an IP address"
  msg "$_STATUS A: FATAL ERROR: Aborting AegirSetupA installer NOW!"
  touch /opt/tmp/status-AegirSetupA-FAIL
  exit 1
else
  AEGIR_HOST_IP=`echo $_RESOLVEIP | cut -d: -f2 | awk '{ print $6}'`
  true
fi
/usr/bin/mysql -h localhost --port=3306 -u root mysql<<EOFMYSQL
FLUSH PRIVILEGES;
GRANT ALL PRIVILEGES ON *.* TO '$_USER'@'$_DOMAIN' IDENTIFIED BY '$AGRPASWD' WITH GRANT OPTION;
GRANT ALL PRIVILEGES ON *.* TO '$_USER'@'$AEGIR_HOST' IDENTIFIED BY '$AGRPASWD' WITH GRANT OPTION;
GRANT ALL PRIVILEGES ON *.* TO '$_USER'@'$AEGIR_HOST_IP' IDENTIFIED BY '$AGRPASWD' WITH GRANT OPTION;
GRANT ALL PRIVILEGES ON *.* TO '$_USER'@'localhost' IDENTIFIED BY '$AGRPASWD' WITH GRANT OPTION;
FLUSH PRIVILEGES;
EOFMYSQL
mrun "sleep 1"
/usr/bin/mysqladmin -u root -h localhost --port=3306 reload
cd $_ROOT
mrun "sleep 1"


###---### Install or upgrade Aegir Satellite Instance [Y/n]
#
_LOCAL_STATUS="$_STATUS"
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _LOCAL_STATUS=INIT
fi
if [ "$_LOCAL_STATUS" = "INIT" ] ; then
  msg "$_STATUS A: Switching user and running AegirSetupB, please wait..."
  mrun "sleep 1"
  rm -f /opt/tmp/testecho*
  chown root:$_USRG /data/u &> /dev/null
  chmod 0771 /data/u &> /dev/null
  su -s /bin/bash $_USER -c "/bin/bash AegirSetupB.sh.txt"
  if [ -e "/opt/tmp/status-AegirSetupB-FAIL" ] ; then
    msg "$_STATUS A: FATAL ERROR: AegirSetupB installer failed"
    msg "$_STATUS A: FATAL ERROR: Aborting AegirSetupA installer NOW!"
    touch /opt/tmp/status-AegirSetupA-FAIL
    exit 1
  fi
  chmod 0700 /data/u &> /dev/null
  chown root:root /data/u &> /dev/null
  msg "$_STATUS A: Aegir Satellite Instance installation completed"
else
  echo " "
  if prompt_yes_no "Do you want to upgrade this Aegir Satellite Instance?" ; then
    true
    mrun "sleep 1"
    if [ "$_PLATFORMS_ONLY" = "YES" ] ; then
      msg "$_STATUS A: Aegir Satellite Instance upgrade skipped - platforms only"
      mrun "sleep 1"    
    else
      msg "$_STATUS A: Switching user and running AegirSetupB, please wait..."
      mrun "sleep 1"
      rm -f /opt/tmp/testecho*
      service cron stop &> /dev/null
      _THIS_HM_ROOT=`cat $_ROOT/.drush/hostmaster.alias.drushrc.php | grep "root'" | cut -d: -f2 | awk '{ print $3}' | sed "s/[\,']//g"`
      _THIS_HM_SITE=`cat $_ROOT/.drush/hostmaster.alias.drushrc.php | grep "site_path'" | cut -d: -f2 | awk '{ print $3}' | sed "s/[\,']//g"`
      chown -R $_USER:$_USRG $_ROOT/.drush
      chown -R $_USER:$_USRG $_ROOT/backups
      chown -R $_USER:$_USRG $_ROOT/clients
      chown -R $_USER:$_USRG $_ROOT/config
      chown -R $_USER:$_USRG $_ROOT/tools
      chown -R $_USER $_THIS_HM_ROOT
      chown -R $_USER:$_WEBG $_THIS_HM_SITE/files
      chmod -R 2770 $_THIS_HM_SITE/files
      chown root:$_USRG /data/u &> /dev/null
      chmod 0771 /data/u &> /dev/null
      su -s /bin/bash $_USER -c "/bin/bash AegirSetupB.sh.txt"
      if [ -e "/opt/tmp/status-AegirSetupB-FAIL" ] ; then
        msg "$_STATUS A: FATAL ERROR: AegirSetupB installer failed"
        msg "$_STATUS A: FATAL ERROR: Aborting AegirSetupA installer NOW!"
        touch /opt/tmp/status-AegirSetupA-FAIL
        exit 1
      fi
      chmod 0700 /data/u &> /dev/null
      chown root:root /data/u &> /dev/null
      msg "$_STATUS A: Aegir Satellite Instance upgrade completed"
    fi
  else
    msg "$_STATUS A: Aegir Satellite Instance not upgraded this time"
    mrun "sleep 1"
  fi
fi


###---### Create ~/bin dir if not exists
#
_L_BIN="$_ROOT/bin"
if [ ! -d "$_L_BIN" ] ; then
  mkdir -p $_L_BIN
  chown $_USER:$_USRG $_L_BIN
  chmod 700 $_L_BIN
fi
if [ ! -L "$_L_BIN/drush" ] ; then
  ln -s $_ROOT/tools/drush/drush $_L_BIN/drush
fi


###---### Run standard post-install
#
_LOCAL_STATUS="$_STATUS"
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _LOCAL_STATUS=INIT
fi
if [ "$_LOCAL_STATUS" = "INIT" ] ; then
  if [ ! -e "$_ROOT/config/$_USER.nginx.conf" ] ; then
    rm -f /var/aegir/config/server_master/nginx/platform.d/$_USER.conf
    echo "include $_ROOT/config/server_master/nginx/vhost.d/*;" > $_ROOT/config/$_USER.nginx.conf
    ln -s $_ROOT/config/$_USER.nginx.conf /var/aegir/config/server_master/nginx/platform.d/$_USER.conf
  fi
  chgrp -R $_WEBG $_AEGIR_ROOT/sites/$_DOMAIN/files
  chgrp $_WEBG $_AEGIR_ROOT/sites/$_DOMAIN/settings.php
  rm -f -r $_AEGIR_ROOT/themes/bluemarine
  rm -f -r $_AEGIR_ROOT/themes/chameleon
  rm -f -r $_AEGIR_ROOT/themes/pushbutton
  rm -f -r $_AEGIR_ROOT/scripts
  rm -f $_AEGIR_ROOT/themes/README.txt
  rm -f $_AEGIR_ROOT/*.txt
  service nginx reload &> /dev/null
  cd $_AEGIR_ROOT
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/robots.txt ./
  cd $_ROOT
fi


###---### Force advanced Nginx config
#
force_advanced_nginx_config


###---### Force global.inc update
#
mv -f /data/conf/global.inc /data/conf/global.inc-pre-$_INSTALLER_VERSION-$_NOW &> /dev/null
if [ -e "/var/aegir/config/server_master/nginx/pre.d/nginx_wild_ssl.conf" ] ; then
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/global.inc.ssl.aegir.txt /data/conf/global.inc
else
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/global.inc.aegir.txt /data/conf/global.inc
fi


###---### Forced SSL settings
#
if [ -e "/var/aegir/config/server_master/nginx/pre.d/nginx_wild_ssl.conf" ] ; then
  if [ -e "/opt/tmp/$_BOA_REPO_NAME/aegir/conf/global.inc.ssl.aegir.txt" ] ; then
    _SSL_TEST=`cat /data/conf/global.inc 2>&1`
    if [[ "$_SSL_TEST" =~ "HTTP_X_FORWARDED_PROTO" ]] ; then
      _SSL_TEST=OK
    else
      msg "$_STATUS A: Installing forced SSL settings for this Hostmaster site, please wait..."
      mrun "sleep 1"
      mv -f /data/conf/global.inc /data/conf/global.inc-pre-$_INSTALLER_VERSION-$_NOW &> /dev/null
      cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/global.inc.ssl.aegir.txt /data/conf/global.inc
      service nginx reload &> /dev/null
    fi
  fi
fi
cd $_ROOT


###---### Set or update Redis password
#
update_redis_password


###---### Set/rewrite _REMOTE_CACHE_IP if defined and disable local caches
#
if [ ! -z "$_REMOTE_CACHE_IP" ] ; then
  if [ "$_REMOTE_CACHE_IP" = "127.0.0.1" ] ; then
    _SKIP_THIS_IP=YES
  else
    msg "$_STATUS A: Set/rewrite remote cache IP address and disable local caches"
    mrun "sleep 1"
    sed -i "s/'127.0.0.1'/'$_REMOTE_CACHE_IP'/g" /data/conf/global.inc &> /dev/null
    sed -i "s/'127.0.0.1'/'$_REMOTE_CACHE_IP'/g" /var/aegir/config/includes/global.inc &> /dev/null
    service redis-server stop &> /dev/null
    update-rc.d -f redis-server remove &> /dev/null
    service redis stop &> /dev/null
    update-rc.d -f redis remove &> /dev/null
    mv -f /etc/init.d/redis /etc/init.d/redis-off &> /dev/null
    mv -f /etc/init.d/redis-server /etc/init.d/redis-server-off &> /dev/null
    killall -9 redis-server &> /dev/null
    rm -f /var/run/redis.pid
    mv -f /var/xdrago/memcache.sh /var/xdrago/memcache.sh-off &> /dev/null
    killall -9 memcached &> /dev/null
  fi
fi


###---### Add sudo for named if exists
#
if [ -e "/usr/sbin/named" ] ; then
  if [ ! -e "$_ROOT/log/named_sudo_exist.txt" ] ; then
    echo "$_USER ALL=NOPASSWD: /etc/init.d/bind9" >> /etc/sudoers
    echo "$_USER ALL=NOPASSWD: /etc/init.d/bind" >> /etc/sudoers
    touch $_ROOT/log/named_sudo_exist.txt
  fi
fi


###---### Set permissions for all
#
chmod 0755 $_AEGIR_ROOT &> /dev/null
chmod 0711 $_ROOT/config
chmod 0711 $_ROOT/config/includes
chmod 0750 $_ROOT/backups
chmod 0750 $_ROOT/clients
chmod 0711 $_ROOT/.drush


###---### Platforms [Y/n]
#
_LOCAL_STATUS="$_STATUS"
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _LOCAL_STATUS=INIT
fi
if [ "$_LOCAL_STATUS" = "INIT" ] ; then
  _DIST_INSTALL=YES
  rm -f /opt/tmp/testecho*
  create_shared_dirs
  manage_o_contrib
  msg "$_STATUS A: Switching user and running Platforms build"
  mrun "sleep 1"
  cd $_ROOT
  su -s /bin/bash $_USER -c "/bin/bash $_ROOT/AegirSetupC.sh.txt"
  if [ -e "/opt/tmp/status-AegirSetupC-FAIL" ] ; then
    msg "$_STATUS A: FATAL ERROR: AegirSetupC installer failed"
    msg "$_STATUS A: FATAL ERROR: Aborting AegirSetupA installer NOW!"
    touch /opt/tmp/status-AegirSetupA-FAIL
    exit 1
  fi
  msg "$_STATUS A: Platforms installation completed"
else
  if [ "$_HM_ONLY" = "YES" ] ; then
    _DIST_INSTALL=NO
  else
    echo " "
    if prompt_yes_no "Do you want to install some latest, ready to use platforms?" ; then
      true
      _DIST_INSTALL=YES
      service cron stop &> /dev/null
      rm -f /opt/tmp/testecho*
      create_shared_dirs
      manage_o_contrib
      msg "$_STATUS A: Switching user and running Platforms build"
      mrun "sleep 1"
      cd $_ROOT
      su -s /bin/bash $_USER -c "/bin/bash $_ROOT/AegirSetupC.sh.txt"
      if [ -e "/opt/tmp/status-AegirSetupC-FAIL" ] ; then
        msg "$_STATUS A: FATAL ERROR: AegirSetupC installer failed"
        msg "$_STATUS A: FATAL ERROR: Aborting AegirSetupA installer NOW!"
        touch /opt/tmp/status-AegirSetupA-FAIL
        exit 1
      fi
      msg "$_STATUS A: Platforms installation completed"
    else
      msg "$_STATUS A: No new platforms added this time"
      mrun "sleep 1"
    fi
  fi
fi
if [ ! -e "$_CORE/dot-files-ctrl-$_INSTALLER_VERSION" ] ; then
  msg "$_STATUS A: Cleaning up various dot files, please wait..."
  cd $_CORE
  st_runner "find . -name .svn -exec rm -rf {} \;" &> /dev/null
  st_runner "find . -name .bzr -exec rm -rf {} \;" &> /dev/null
  st_runner "find . -name .git -exec rm -rf {} \;" &> /dev/null
  st_runner "find . -name "._*" -type f | xargs rm -rf" &> /dev/null
  touch $_CORE/dot-files-ctrl-$_INSTALLER_VERSION
fi


###---### Fix files permissions
#
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _PLATF_IMP=$(ls -la /data/u | grep $_USER | cut -d'>' -f2 | sort | uniq | awk '{ print $1}')
  for _PLATF in $_PLATF_IMP ; do
    if [[ "$_PLATF" =~ "aegir" ]] ; then
	  _FOUND_HM=YES
    else
      chown -R $_USER:www-data $_PLATF/sites/*/files &> /dev/null
      chmod -R 2770 $_PLATF/sites/*/files &> /dev/null
    fi
  done
fi


###---### Clean up old and install files
#
rm -f $_ROOT/AegirSetupC.sh.txt
rm -f $_ROOT/AegirSetupB.sh.txt
rm -f $_ROOT/*.sh.txt


###---### Add cron task
#
_LOCAL_STATUS="$_STATUS"
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _LOCAL_STATUS=INIT
fi
rm -f /var/spool/cron/crontabs/$_USER
if [ ! -e "/var/log/cron_aegir_off.pid" ] ; then
  sed -i "s/\*\/1 \* \* \* \* bash \/var\/xdrago\/run/#*\/1 * * * * bash \/var\/xdrago\/run/g" /var/spool/cron/crontabs/root &> /dev/null
  echo -e "* * * * * bash /var/xdrago/runner.sh >/dev/null 2>&1" | tee -a /var/spool/cron/crontabs/root >/dev/null 2>&1
  touch /var/log/cron_aegir_off.pid
fi


###---### Add ftps/lshell access
#
_LOCAL_STATUS="$_STATUS"
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _LOCAL_STATUS=INIT
fi
if [ "$_LOCAL_STATUS" = "INIT" ] ; then
  _USERFTP="$_USER.ftp"
  _USERFTP_ROOT="/home/$_USERFTP"
  if [ "$_REL_VERSION" = "lenny" ] ; then
    _PATH_LSHELL="/usr/bin/lshell"
  else
    _PATH_LSHELL="/usr/local/bin/lshell"
  fi
  if [ ! -d "$_USERFTP_ROOT" ] ; then
    msg "$_STATUS A: Adding ftps/lshell user"
    mrun "sleep 1"
    # add user
    useradd -d /home/$_USERFTP -s $_PATH_LSHELL -m -N -r $_USERFTP &> /dev/null
    adduser $_USERFTP $_WEBG &> /dev/null
    # Make sure new file which contains password is private
    cd $_ROOT/log
    touch $_ROOT/log/pass.txt
    chmod 0600 $_ROOT/log/pass.txt
    # generate a nice secure password and put it in a file
    pwgen -v -s -1 > $_ROOT/log/pass.txt
    # get the password hash
    ph=$(makepasswd --clearfrom=$_ROOT/log/pass.txt --crypt-md5 |awk '{print $2}')
    # Set the password
    usermod -p $ph $_USERFTP &> /dev/null
    passwd -w 7 -x 90 $_USERFTP &> /dev/null
  fi
  usermod -aG lshellg $_USERFTP &> /dev/null
  chsh -s $_PATH_LSHELL $_USERFTP &> /dev/null
  echo >> /etc/lshell.conf
  echo "[$_USERFTP]" >> /etc/lshell.conf
  echo "path : ['/data/disk/$_USER/distro', '/data/disk/$_USER/static', '/data/disk/$_USER/backups', '/data/disk/$_USER/clients']" >> /etc/lshell.conf
  touch $_ROOT/log/backups.access.open
  touch $_ROOT/log/clients.access.open
fi


###---### Add access to backups for older installs
#
if [ ! -e "$_ROOT/log/backups.access.open" ] ; then
  sed -i "s/\/$_USER\/static'\]/\/$_USER\/static', '\/data\/disk\/$_USER\/backups'\]/g" /etc/lshell.conf &> /dev/null
  chmod 0750 $_ROOT/backups
  touch $_ROOT/log/backups.access.open
fi


###---### Add symlink to the sites backups
#
_USERFTP="$_USER.ftp"
_USER_HD="/home/$_USERFTP"
if [ ! -L "$_USER_HD/backups" ] ; then
  msg "$_STATUS A: Adding symlink to the sites backups"
  mrun "sleep 1"
  ln -s /data/disk/$_USER/backups $_USER_HD/backups
fi


###---### Add symlink to the system drush_make
#
_USERFTP="$_USER.ftp"
_USER_DM="/home/$_USERFTP/.drush"
if [ ! -L "$_USER_DM/drush_make" ] ; then
  msg "$_STATUS A: Adding symlink to the system drush_make"
  mrun "sleep 1"
  mkdir -p $_USER_DM
  chown $_USERFTP:$_USRG $_USER_DM
  chmod 700 $_USER_DM
  ln -s /var/aegir/.drush/drush_make $_USER_DM/drush_make
fi


###---### Add symlink to the system registry_rebuild
#
if [ ! -L "$_USER_DM/registry_rebuild" ] ; then
  msg "$_STATUS A: Adding symlink to the system registry_rebuild"
  mrun "sleep 1"
  mkdir -p $_USER_DM
  chown $_USERFTP:$_USRG $_USER_DM
  chmod 700 $_USER_DM
  ln -s /var/aegir/.drush/registry_rebuild $_USER_DM/registry_rebuild
fi


###---### Create .ssh dir if not exists
#
_USER_SSH="/home/$_USERFTP/.ssh"
if [ ! -d "$_USER_SSH" ] ; then
  mkdir -p $_USER_SSH
  chown $_USERFTP:$_USRG $_USER_SSH
  chmod 700 $_USER_SSH
fi


###---### Add access to the clients directory for older installs
#
if [ ! -e "$_ROOT/log/clients.access.open" ] ; then
  sed -i "s/\/$_USER\/backups'\]/\/$_USER\/backups', '\/data\/disk\/$_USER\/clients'\]/g" /etc/lshell.conf &> /dev/null
  chmod 0750 $_ROOT/clients
  touch $_ROOT/log/clients.access.open
fi


###---### Add symlink to the clients directory
#
_USERFTP="$_USER.ftp"
_USER_HD="/home/$_USERFTP"
if [ ! -L "$_USER_HD/clients" ] ; then
  msg "$_STATUS A: Adding symlink to the clients directory"
  mrun "sleep 1"
  ln -s /data/disk/$_USER/clients $_USER_HD/clients
fi
rm -f -r /data/disk/$_USER/clients/admin &> /dev/null
rm -f -r /data/disk/$_USER/clients/omega8ccgmailcom &> /dev/null
rm -f -r /data/disk/$_USER/clients/nocomega8cc &> /dev/null
rm -f -r /data/disk/$_USER/clients/*/backups &> /dev/null
symlinks -dr /data/disk/$_USER/clients &> /dev/null


###---### Remove not used dot files
#
rm -f $_USER_HD/{.profile,.bash_logout,.bashrc}


###---### Reading or creating pass.txt
#
if [ "$_HM_ONLY" = "YES" ] ; then
  true
else
if [ -e "$_ROOT/pass.txt" ] ; then
 _PASWD=`cat $_ROOT/pass.txt`
 _PASWD=`echo -n $_PASWD | tr -d "\n"`
 mv -f $_ROOT/pass.txt $_ROOT/log/pass.txt &> /dev/null
elif [ -e "$_ROOT/log/pass.txt" ] ; then
 _PASWD=`cat $_ROOT/log/pass.txt`
 _PASWD=`echo -n $_PASWD | tr -d "\n"`
 rm -f $_ROOT/pass.txt
else
 cd $_ROOT/log
 touch $_ROOT/log/pass.txt
 chmod 0600 $_ROOT/log/pass.txt
 pwgen -v -s -1 > $_ROOT/log/pass.txt
 ph=$(makepasswd --clearfrom=$_ROOT/log/pass.txt --crypt-md5 |awk '{print $2}')
 usermod -p $ph $_USERFTP &> /dev/null
 _PASWD=`cat $_ROOT/log/pass.txt`
 _PASWD=`echo -n $_PASWD | tr -d "\n"`
fi
fi


###---### Creating ftp symlinks
#
if [ "$_DIST_INSTALL" = "YES" ] ; then
msg "$_STATUS A: Creating ftp symlinks"
mrun "sleep 1"
  if [ ! -d "/home/$_USERFTP/platforms/$_THIS_CORE" ] ; then
    mkdir -p /home/$_USERFTP/platforms/$_THIS_CORE
  fi
  chown -R $_USER:$_USRG /home/$_USERFTP/platforms &> /dev/null
  chmod 700 /home/$_USERFTP &> /dev/null
  rm -f /home/$_USERFTP/platforms/$_THIS_CORE/{cod,commerce,commons,managingnews,nodestream,openatrium,openenterprise,openpublic,openscholar,prosepoint,drupal6,drupal7}
  if [ -d "$_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/acquia-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/acquia-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM6-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM6-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM6-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM6-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM7-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM7-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM7-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/civicrm-$_CIVICRM7-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/cod-$_COD-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/cod-$_COD-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/commons-$_COMMONS-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/commons-$_COMMONS-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/commons-$_COMMONS-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/commons-$_COMMONS-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_DRUPAL5/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_DRUPAL5" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/pressflow-$_DRUPAL5/sites /home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_DRUPAL5
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-dev" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev/sites /home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-dev
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-stage" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage/sites /home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-stage
    fi
  fi
  if [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow" ] ; then
    if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod/sites" ] ; then
      if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-prod" ] ; then
        ln -s $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod/sites /home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-prod
      fi
    fi
  elif [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod" ] ; then
    if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow/sites" ] ; then
      if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-prod" ] ; then
        ln -s $_ROOT/distro/$_THIS_CORE/pressflow/sites /home/$_USERFTP/platforms/$_THIS_CORE/pressflow-$_SMALLCORE6-prod
      fi
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7D/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-dev" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/$_DRUPAL7D/sites /home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-dev
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7S/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-stage" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/$_DRUPAL7S/sites /home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-stage
    fi
  fi
  if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7" ] ; then
    if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P/sites" ] ; then
      if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-prod" ] ; then
        ln -s $_ROOT/distro/$_THIS_CORE/$_DRUPAL7P/sites /home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-prod
      fi
    fi
  elif [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P" ] ; then
    if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7/sites" ] ; then
      if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-prod" ] ; then
        ln -s $_ROOT/distro/$_THIS_CORE/$_DRUPAL7/sites /home/$_USERFTP/platforms/$_THIS_CORE/$_DRUPAL7-prod
      fi
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/drupal-$_DRUPAL8" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8/sites /home/$_USERFTP/platforms/$_THIS_CORE/drupal-$_DRUPAL8
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/elms-$_ELMS-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/elms-$_ELMS-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/elms-$_ELMS-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/elms-$_ELMS-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/fserver-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/fserver-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/martplug-$_MART_PLUG-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/martplug-$_MART_PLUG-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/martplug-$_MART_PLUG-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/martplug-$_MART_PLUG-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM6-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/nodestream-$_NODESTREAM6-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM6-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/nodestream-$_NODESTREAM6-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/octopus_video-$_OCTOPUS_VIDEO-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/octopus_video-$_OCTOPUS_VIDEO-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/octopus_video-$_OCTOPUS_VIDEO-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/octopus_video-$_OCTOPUS_VIDEO-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openacademy-$_OPENACADEMY-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openacademy-$_OPENACADEMY-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openacademy-$_OPENACADEMY-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/openacademy-$_OPENACADEMY-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openatrium-$_OPENATRIUM-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/openatrium-$_OPENATRIUM-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/opendeals-$_OPEN_DEALS-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/opendeals-$_OPEN_DEALS-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/opendeals-$_OPEN_DEALS-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/opendeals-$_OPEN_DEALS-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openpublic-$_OPENPUBLIC-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openpublic-$_OPENPUBLIC-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openpublic-$_OPENPUBLIC-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/openpublic-$_OPENPUBLIC-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7/sites /home/$_USERFTP/platforms/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/videola-$_VIDEOLA-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/videola-$_VIDEOLA-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/videola-$_VIDEOLA-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/videola-$_VIDEOLA-$_SMALLCORE6
    fi
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/openenterprise-$_OPENENTERPRISE-$_SMALLCORE6/sites" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/openenterprise-$_OPENENTERPRISE-$_SMALLCORE6" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/openenterprise-$_OPENENTERPRISE-$_SMALLCORE6/sites /home/$_USERFTP/platforms/$_THIS_CORE/openenterprise-$_OPENENTERPRISE-$_SMALLCORE6
    fi
  fi
fi
if [ ! -d "$_ROOT/static" ] ; then
  mkdir -p $_ROOT/static
  ln -s $_ROOT/static /home/$_USERFTP/static
fi
chown $_USER:$_USRG $_ROOT/static &> /dev/null
chmod 02775 $_ROOT/static &> /dev/null
echo empty > $_ROOT/static/EMPTY.txt
if [ "$_HM_ONLY" = "YES" ] ; then
  true
else
  if [ ! -d "$_ROOT/distro/$_THIS_CORE/keys" ] ; then
    mkdir -p $_ROOT/distro/$_THIS_CORE/keys
    chown $_WEBG:$_WEBG $_ROOT/distro/$_THIS_CORE/keys &> /dev/null
    chmod 770 $_ROOT/distro/$_THIS_CORE/keys
  fi
  if [ -d "$_ROOT/distro/$_THIS_CORE/keys" ] ; then
    if [ ! -L "/home/$_USERFTP/platforms/$_THIS_CORE/keys" ] ; then
      ln -s $_ROOT/distro/$_THIS_CORE/keys /home/$_USERFTP/platforms/$_THIS_CORE/keys
    fi
  fi
  rm -f $_ROOT/distro/$_THIS_CORE/*/robots.txt &> /dev/null
  if [ ! -e "/data/all/$_LAST_ALL/javascript_aggregator.out.txt" ] ; then
    sed -i "s/, 'javascript_aggregator'//g" /data/all/$_LAST_ALL/*/profiles/*/*.profile &> /dev/null
    touch /data/all/$_LAST_ALL/javascript_aggregator.out.txt
  fi
  if [ ! -e "$_CORE/javascript_aggregator.out.txt" ] ; then
    sed -i "s/, 'javascript_aggregator'//g" $_CORE/*/profiles/*/*.profile &> /dev/null
    touch $_CORE/javascript_aggregator.out.txt
  fi
fi


###---### Remove not used cache module
#
if [ ! -e "/data/all/000/old_cache.out2.txt" ] && [ -e "/data/all/000" ] ; then
  sed -i "s/, 'cache'//g" /data/all/*/*/profiles/*/*.profile &> /dev/null
  sed -i "s/'cache', //g" /data/all/*/*/profiles/*/*.profile &> /dev/null
  rm -f -r /data/all/*/o_contrib/cache
  touch /data/all/000/old_cache.out2.txt
fi


###---### Preparing setupmail.txt
#
if [ "$_HM_ONLY" = "YES" ] ; then
  true
else
msg "$_STATUS A: Preparing setupmail.txt"
mrun "sleep 1"
_AT_CLIENT_EMAIL=${_CLIENT_EMAIL//\\\@/\@}
_A_DM_EMAIL=${_ADM_EMAIL//\\\@/\@}
# rm -f /opt/tmp/.admemail.txt
if [ -e "$_ROOT/log/setupmail.txt" ] ; then
  if [ "$_DIST_INSTALL" = "YES" ] ; then
    cd $_ROOT/log
    if [ -e "$_ROOT/log/upgrademail.txt" ] ; then
      mv -f $_ROOT/log/upgrademail.txt $_ROOT/log/upgrademail-pre-$_THIS_CORE.txt &> /dev/null
    fi
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/upgrademail.txt ./
    sed -i "s/aegir.dragon.ny.host8.biz/$_DOMAIN/g" $_ROOT/log/upgrademail.txt &> /dev/null
    sed -i "s/dragon/$_USER/g" $_ROOT/log/upgrademail.txt &> /dev/null
    sed -i "s/FN8rXcQn/$_PASWD/g" $_ROOT/log/upgrademail.txt &> /dev/null
    sed -i "s/166.84.6.231/$_THISHTIP/g" $_ROOT/log/upgrademail.txt &> /dev/null
  else
    _SEND_UPGRADE_EMAIL=NO
  fi
elif [ "$_STATUS" = "INIT" ] ; then
 cd $_ROOT/log
 cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/setupmail.txt ./
 sed -i "s/aegir.dragon.ny.host8.biz/$_DOMAIN/g" $_ROOT/log/setupmail.txt &> /dev/null
 sed -i "s/dragon/$_USER/g" $_ROOT/log/setupmail.txt &> /dev/null
 sed -i "s/FN8rXcQn/$_PASWD/g" $_ROOT/log/setupmail.txt &> /dev/null
 sed -i "s/166.84.6.231/$_THISHTIP/g" $_ROOT/log/setupmail.txt &> /dev/null
fi
fi


###---### Sending setup e-mail
#
_MAILX_TEST=`mail -V 2>&1`
if [ "$_STATUS" = "INIT" ] ; then
  msg "$_STATUS A: Sending setup e-mail on init, please wait..."
  mrun "sleep 1"
  TIME=`date`
  echo $TIME > $_ROOT/log/date-init.txt
  if [ -e "$_ROOT/log/setupmail.txt" ] ; then
    if [[ "$_MAILX_TEST" =~ "invalid" ]] ; then
      cat $_ROOT/log/setupmail.txt | mail -a "From: $_A_DM_EMAIL" -e -b $_A_DM_EMAIL -s "Your Aegir Install on $TIME [$_USER]" $_AT_CLIENT_EMAIL
    else
      cat $_ROOT/log/setupmail.txt | mail -r $_A_DM_EMAIL -e -b $_A_DM_EMAIL -s "Your Aegir Install on $TIME [$_USER]" $_AT_CLIENT_EMAIL
    fi
  fi
else
  if [ "$_DIST_INSTALL" = "YES" ] && [ "$_PLATFORMS_ONLY" = "NO" ] ; then
    msg "$_STATUS A: Resending setup e-mail on upgrade, please wait..."
    mrun "sleep 1"
    TIME=`date`
    echo $TIME > $_ROOT/log/date-upgrade-$_THIS_CORE.txt
    if [ -e "$_ROOT/log/upgrademail.txt" ] ; then
      if [[ "$_MAILX_TEST" =~ "invalid" ]] ; then
        cat $_ROOT/log/upgrademail.txt | mail -a "From: $_A_DM_EMAIL" -e -b $_A_DM_EMAIL -s "Your Aegir Upgrade on $TIME [$_USER]" $_AT_CLIENT_EMAIL
      else
        cat $_ROOT/log/upgrademail.txt | mail -r $_A_DM_EMAIL -e -b $_A_DM_EMAIL -s "Your Aegir Upgrade on $TIME [$_USER]" $_AT_CLIENT_EMAIL
      fi
    else
      if [[ "$_MAILX_TEST" =~ "invalid" ]] ; then
        cat $_ROOT/log/setupmail.txt | mail -a "From: $_A_DM_EMAIL" -e -b $_A_DM_EMAIL -s "Your Aegir Upgrade on $TIME [$_USER]" $_AT_CLIENT_EMAIL
      else
        cat $_ROOT/log/setupmail.txt | mail -r $_A_DM_EMAIL -e -b $_A_DM_EMAIL -s "Your Aegir Upgrade on $TIME [$_USER]" $_AT_CLIENT_EMAIL
      fi
    fi
  else
    _SEND_UPGRADE_EMAIL=NO
  fi
fi


###---### Touch install logs
#
TIME=`date`
if [ "$_STATUS" = "INIT" ] ; then
 echo $TIME > $_ROOT/log/date-init.txt
else
 echo $TIME > $_ROOT/log/date-upgrade-$_THIS_CORE.txt
fi
echo "`date` / `lsb_release -si`.`lsb_release -sc` `uname -m` / Aegir $_AEGIR_VERSION / Octopus $_INSTALLER_VERSION / FPM $_PHP_FPM_VERSION / CLI $_PHP_CLI_VERSION" >> $_ROOT/log/octopus_log.txt
msg "$_STATUS A: New entry added to $_ROOT/log/octopus_log.txt"


###---### Final cleaning
#
msg "$_STATUS A: Final cleaning, please wait a moment..."
mrun "sleep 1"
cd /
chmod 711 bin boot data dev emul etc home lib media mnt opt sbin selinux srv sys usr var &> /dev/null
chmod 700 root &> /dev/null
chown root:root /data/all &> /dev/null
chown -R root:root /data/src &> /dev/null
chown -R root:root /data/conf &> /dev/null
chown root:root $_CORE &> /dev/null
chown -R root:root $_CORE/o_contrib &> /dev/null
chown -R root:root $_CORE/o_contrib_seven &> /dev/null
chown -R root:root /data/all/$_LAST_ALL/o_contrib &> /dev/null
chown -R root:root /data/all/$_LAST_ALL/o_contrib_seven &> /dev/null
chown -R root:root /data/all/000 &> /dev/null
chown root:root /opt/tmp &> /dev/null
chmod 0711 $_CORE /data/all /data/all/000 /data/src /data /data/disk /data/conf &> /dev/null
chmod 0700 /data/u &> /dev/null
chown root:root /data/u &> /dev/null
rm -f /data/u/*host8* &> /dev/null
mv -f $_ROOT/backups/drush-pre* $_ROOT/backups/system/ &> /dev/null
mv -f $_ROOT/backups/provision-pre* $_ROOT/backups/system/ &> /dev/null
mv -f $_ROOT/backups/drush_make-pre* $_ROOT/backups/system/ &> /dev/null
mv -f $_ROOT/backups/provision_boost-pre* $_ROOT/backups/system/ &> /dev/null
mv -f $_ROOT/backups/provision_civicrm-pre* $_ROOT/backups/system/ &> /dev/null
mv -f $_ROOT/backups/provision_cdn-pre* $_ROOT/backups/system/ &> /dev/null
mv -f $_ROOT/backups/registry_rebuild-pre* $_ROOT/backups/system/ &> /dev/null
mkdir -p /data/conf/arch
mv -f /data/conf/global.inc-pre* /data/conf/arch/ &> /dev/null
mv -f /data/conf/global.inc-before* /data/conf/arch/ &> /dev/null
mv -f /data/conf/global.inc-missing* /data/conf/arch/ &> /dev/null
if [ -d "$_CORE/$_DRUPAL7" ] ; then
  mkdir -p /var/backups/trash
  rm -f -r /var/backups/trash/*
  mv -f $_CORE/$_DRUPAL7 /var/backups/trash/ &> /dev/null
fi
if [ "$_STATUS" = "INIT" ] ; then
  if [ "$_DEBUG_MODE" = "YES" ] ; then
    true
  else
    _AEGIR_LOGIN_URL=`grep "^http://$_DOMAIN" $_ROOT/log/install.log 2> /dev/null`
    if [ ! -z "$_AEGIR_LOGIN_URL" ] ; then
      echo " "
      msg "INFO: Congratulations, Aegir backend and frontend have been installed successfully"
      msg "NOTE! Please wait 1 minute before opening the following link in your web browser:"
      echo " "
      msg "LINK: $_AEGIR_LOGIN_URL"
      echo " "
    else
      msg "ALRT: Something went wrong"
      msg "ALRT: Please check the install log for details:"
      msg "ALRT: $_ROOT/log/install.log"
    fi
  fi
else
  feature_server_fix_002
  o_contrib_update_global
  o_contrib_seven_update_global
fi
msg "$_STATUS A: Starting the cron now"
service cron start &> /dev/null
msg "$_STATUS A: All done!"
msg "BYE!"

touch /opt/tmp/status-AegirSetupA-OK

###----------------------------------------###
###
###  Octopus Aegir Installer
###  Copyright (C) 2010-2012 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###----------------------------------------###
