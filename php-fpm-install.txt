#
# we need some useful stuff if not installed before
#
# to get newer mysql add to your /etc/apt/sources.list 2 lines:
#
# deb http://dotdeb.mirror.cambrium.nl/ stable all
# deb-src http://dotdeb.mirror.cambrium.nl/ stable all
#
sudo aptitude update
sudo aptitude safe-upgrade
sudo aptitude install build-essential
sudo aptitude install mc rsync libtool autoconf dnsutils libmcrypt-dev mcrypt sysvconfig libxml2-dev libc-client-dev libpng-dev libjpeg-dev xml2 libpcre3 libpcre3-dev memcached zlibc libmemcache-dev libcurl4-gnutls-dev libcurl4-openssl-dev ncurses-dev ntpdate graphicsmagick-imagemagick-compat munin bzr munin-plugins-extra curl dstat ifstat sysstat htop devscripts git-core xml-core bc php5-xsl libxslt-dev php5-cli mysql-client-5.1 mysql-server-5.1 libmysqlclient16 libmysqlclient-dev cvs libevent-dev


#
# we need libevent-1.4.12
#
cd /var/opt
wget http://www.monkey.org/~provos/libevent-1.4.12-stable.tar.gz
tar -xzf libevent-1.4.12-stable.tar.gz &&
cd libevent-1.4.12-stable &&
./configure --prefix=/usr &&
make &&
make install
cd /var/opt


#
# newer memcached is better
#
cd /var/opt
wget http://memcached.googlecode.com/files/memcached-1.4.4.tar.gz
tar -xzf memcached-1.4.4.tar.gz &&
cd memcached-1.4.4 &&
./configure --prefix=/usr/local &&
make &&
make install
cd /var/opt
mv -f /usr/bin/memcached /usr/bin/memcached-old
ln -s /usr/local/bin/memcached /usr/bin/memcached
/etc/init.d/memcached restart


#
# now prepare and install patched php
#

#
# step 1
#
cd /var/opt
wget http://www.php.net/distributions/php-5.2.11.tar.gz
wget http://download.suhosin.org/suhosin-patch-5.2.11-0.9.7.patch.gz
wget http://launchpad.net/php-fpm/master/0.6/+download/php-fpm-0.6~5.2.11.tar.gz
tar -xzf php-fpm-0.6~5.2.11.tar.gz &&
tar -xzf php-5.2.11.tar.gz &&
sh php-fpm-0.6-5.2.11/generate-fpm-patch &&
gzip -d suhosin-patch-5.2.11-0.9.7.patch.gz
cd /var/opt/php-5.2.11
patch -p 1 -i ../suhosin-patch-5.2.11-0.9.7.patch
patch -p1 < ../fpm.patch

#
# step 2
#
./buildconf --force
mkdir fpm-build && cd fpm-build
cp -f /etc/init.d/php-fpm /etc/init.d/php-fpm.bak

#
# step 3
#
../configure --with-fpm \
--enable-fastcgi \
--with-mysql \
--with-mysqli \
--enable-force-cgi-redirect \
--enable-discard-path \
--with-zlib \
--with-curl \
--with-curlwrappers \
--with-gd \
--with-jpeg-dir=/usr/lib \
--with-pear \
--with-imap \
--with-imap-ssl \
--with-openssl \
--with-pdo-mysql \
--enable-soap \
--enable-ftp \
--enable-mbstring \
--enable-pcntl \
--enable-bcmath \
--with-kerberos \
--with-xsl \
--with-libevent=shared \
--with-mcrypt &&
make &&
make install
cp -f /etc/init.d/php-fpm.bak /etc/init.d/php-fpm
cd /var/opt


#
# add suhosin
#
cd /var/opt
wget http://download.suhosin.org/suhosin-0.9.29.tgz
tar -xzf suhosin-0.9.29.tgz &&
cd suhosin-0.9.29 &&
/usr/local/bin/phpize &&
./configure --with-php-config=/usr/local/bin/php-config &&
make &&
make install
cd /var/opt


#
# add memcache
#
cd /var/opt
wget http://pecl.php.net/get/memcache-2.2.5.tgz
tar -xzf memcache-2.2.5.tgz &&
cd memcache-2.2.5 &&
/usr/local/bin/phpize &&
./configure --with-php-config=/usr/local/bin/php-config &&
make &&
make install
cd /var/opt


#
# add apc
#
cd /var/opt
wget http://pecl.php.net/get/APC-3.1.3p1.tgz
tar -xzf APC-3.1.3p1.tgz &&
cd APC-3.1.3p1 &&
/usr/local/bin/phpize &&
./configure --with-php-config=/usr/local/bin/php-config &&
make &&
make install
cd ./../
cd /var/opt


#
# add this to your php.ini
#
#-- php.ini --#
; Enable APC
extension="apc.so"
apc.shm_size = 128
apc.stat = 0

; Enable Memcache
extension="memcache.so"
memcache.hash_strategy="consistent"

; Enable Suhosin
extension="suhosin.so"
suhosin.request.max_vars = 8000
suhosin.post.max_vars = 8000
#-- php.ini --#


#
# start php-fpm
#
/etc/init.d/php-fpm start


