#!/bin/bash


###----------------------------------------###
###
###  Octopus Aegir Installer
###
###  Copyright (C) 2010-2013 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: http://code.aegir.cc/aegir
###
###----------------------------------------###


###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###

_INSTALLER_VERSION=EDIT_INSTALLER_VERSION


###---### Distro config.
#
_CIVICRM_M6=EDIT_CIVICRM_M6
_CIVICRM_M7=EDIT_CIVICRM_M7
_COD=EDIT_COD
_COM_MERCE=EDIT_COM_MERCE
_COMMERCE=EDIT_COMMERCE
_D6COMMONS=EDIT_D6COMMONS
_D7COMMONS=EDIT_D7COMMONS
_DRUPAL7=EDIT_DRUPAL7
_DRUPAL7D="EDIT_DRUPAL7-dev"
_DRUPAL7P="EDIT_DRUPAL7-prod"
_DRUPAL7S="EDIT_DRUPAL7-stage"
_DRUPAL8=EDIT_DRUPAL8
_DRUPAL_EDGE_8=EDIT_DRUPAL_EDGE_8
_MANAGINGNEWS=EDIT_MANAGINGNEWS
_NODESTREAM7=EDIT_NODESTREAM7
_OPEN_DEALS=EDIT_OPEN_DEALS
_OPENACADEMY=EDIT_OPENACADEMY
_OPENATRIUM6=EDIT_OPENATRIUM6
_OPENATRIUM7=EDIT_OPENATRIUM7
_OPENCHURCH=EDIT_OPENCHURCH
_OPENDEALS=EDIT_OPENDEALS
_OPENOUTREACH=EDIT_OPENOUTREACH
_OPENPUBLISH=EDIT_OPENPUBLISH
_OPENSCHOLAR=EDIT_OPENSCHOLAR
_PANOPOLY=EDIT_PANOPOLY
_PROSEPOINT=EDIT_PROSEPOINT
_SMALLCORE6=EDIT_SMALLCORE6
_SMALLCORE7=EDIT_SMALLCORE7
_SMALLCORE8=EDIT_SMALLCORE8
_UBER_CART_SEVEN=EDIT_UBER_CART_SEVEN
_UBERCART=EDIT_UBERCART


###---### Main config.
#
_AEGIR_VERSION=EDIT_AEGIR_VERSION
_ALL_DISTRO=EDIT_ALL_DISTRO
_ALLOW_UNSUPPORTED=EDIT_ALLOW_UNSUPPORTED
_AUTOPILOT=EDIT_AUTOPILOT
_BOA_REPO_GIT_URL=EDIT_BOA_REPO_GIT_URL
_BOA_REPO_NAME=EDIT_BOA_REPO_NAME
_CLIENT_CORES=EDIT_CLIENT_CORES
_CLIENT_OPTION=EDIT_CLIENT_OPTION
_DEBUG_MODE=EDIT_DEBUG_MODE
_DISTRO=EDIT_DISTRO
_DOMAIN=EDIT_DOMAIN
_DRUSH_VERSION=EDIT_DRUSH_VERSION
_HM_DISTRO=EDIT_HM_DISTRO
_HM_ONLY=EDIT_HM_ONLY
_HOT_SAUCE=EDIT_HOT_SAUCE
_LAST_ALL=EDIT_LAST_ALL
_LAST_HMR=EDIT_LAST_HMR
_LASTNUM=EDIT_LASTNUM
_NOW=EDIT_NOW
_O_CONTRIB_UP=EDIT_O_CONTRIB_UP
_PHP_CLI_VERSION=EDIT_PHP_CLI_VERSION
_PHP_FPM_VERSION=EDIT_PHP_FPM_VERSION
_PLATFORMS_LIST="EDIT_PLATFORMS_LIST"
_PURGE_FOR_SEVEN=EDIT_PURGE_FOR_SEVEN
_PURGE_MODE=EDIT_PURGE_MODE
_SPINNER=EDIT_SPINNER
_SRCDIR=/opt/tmp/files
_STATUS=INIT
_T_BUILD=EDIT_T_BUILD
_THIS_DB_HOST=EDIT_THIS_DB_HOST
_TODAY=`date +%y%m%d`
_USE_CURRENT=EDIT_USE_CURRENT
_USE_STOCK=EDIT_USE_STOCK
_WEBG=EDIT_WEBG
#
_USER=EDIT_USER
_ROOT="/data/disk/$_USER"
_AEGIR_ROOT="$_ROOT/aegir/distro/$_HM_DISTRO"
_PREV_AEGIR_ROOT="$_ROOT/aegir/distro/$_LAST_HMR"
_LOG=/var/backups/octopus-$_USER-$_NOW.log
#
if [ "$_PHP_CLI_VERSION" != "5.2" ] && [ -x "/opt/local/bin/php" ] ; then
  _L_PHP_CLI=/opt/local/bin
else
  _L_PHP_CLI=/usr/local/bin
fi
if [ "$_PHP_FPM_VERSION" != "5.2" ] || [ "$_PHP_CLI_VERSION" != "5.2" ] ; then
  _D_5_ALLOW=NO
else
  _D_5_ALLOW=YES
fi
if [ "$_PHP_FPM_VERSION" != "5.2" ] && [ "$_PHP_CLI_VERSION" != "5.2" ] ; then
  _D_8_ALLOW=YES
else
  _D_8_ALLOW=NO
fi
_DRUSHCMD="$_L_PHP_CLI/php $_ROOT/tools/drush/drush.php"
_DRUSH5CMD="$_L_PHP_CLI/php /opt/tools/drush/5/drush/drush.php"
if [ "$_PHP_CLI_VERSION" = "5.2" ] && [ -x "/usr/local/bin/php52" ] ; then
  _DRUSHCMD="/usr/local/bin/php52 $_ROOT/tools/drush/drush.php"
fi
#
SHELL=/bin/bash
PATH=$_L_PHP_CLI:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin


###---### Functions.
#
# Noticeable messages.
msg () {
  echo "Octopus [`date`] ==> $*"
}
#
# Simple prompt.
prompt_yes_no () {
if [ "$_AUTOPILOT" = "YES" ]; then
  return 0
else
  while true ; do
    printf "$* [Y/n] "
    read answer
    if [ -z "$answer" ] ; then
      return 0
    fi
    case $answer in
      [Yy]|[Yy][Ee][Ss])
        return 0
        ;;
      [Nn]|[Nn][Oo])
        return 1
        ;;
      *)
        echo "Please answer yes or no"
        ;;
    esac
 done
fi
}
#
# Small spinner.
mrun () {
  CMD="$1"
  touch busy
  if [ "$_SPINNER" = "YES" ] ; then
    bash $_SRCDIR/spinner busy &
  fi
  if $CMD >> $_LOG; then
    rm busy
    sleep 1
    return 0
  fi
}
#
# Download and extract from dev/distro, then delete.
get_distro_ext () {
  if [ ! -z $1 ] ; then
    wget -q -U iCab http://files.aegir.cc/distro/$1
    tar -xzf $1
    rm -f $1
  fi
}
#
# Create standard directories.
fix_dirs_files () {
  rm -f ./*.txt
  rm -f ./modules/*.txt
  rm -f ./themes/*.txt
  rm -f -r ./modules/cookie_cache_bypass
  mkdir -p ./sites/default/files
  mkdir -p ./cache/{normal,perm}
  chmod -R 777 ./cache
  if [ -e "./sites/default/default.settings.php" ] ; then
    cp -af ./sites/default/default.settings.php ./sites/default/settings.php
  fi
  chmod a+rw ./sites/default/settings.php
  chmod a+rwx ./sites/default/files
  mkdir -p ./profiles
  mkdir -p ./sites/all/{modules,libraries,themes}
  rm -f ./core/modules/*.txt
  rm -f ./core/themes/*.txt
  rm -f ./modules/*.txt
  rm -f ./themes/*.txt
  rm -f ./sites/all/*.txt
  echo empty > ./profiles/EMPTY.txt
  echo empty > ./sites/all/EMPTY.txt
  echo empty > ./sites/all/modules/EMPTY.txt
  echo empty > ./sites/all/libraries/EMPTY.txt
  echo empty > ./sites/all/themes/EMPTY.txt
  chmod 02775 ./profiles &> /dev/null
  chmod 0751 ./sites
  chmod 0751 ./sites/all
  chmod 02775 ./sites/all/{modules,libraries,themes}
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/get.htaccess.txt ./.htaccess
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/conf/crossdomain.xml ./
}
#
# Create D6 symlinks.
create_d6_symlinks () {
  if [ ! -L "includes" ] ; then
    ln -sf $_D6_CORE_DIR/.htaccess .htaccess
    ln -sf $_D6_CORE_DIR/boost_stats.php boost_stats.php
    ln -sf $_D6_CORE_DIR/cron.php cron.php
    ln -sf $_D6_CORE_DIR/crossdomain.xml crossdomain.xml
    ln -sf $_D6_CORE_DIR/includes includes
    ln -sf $_D6_CORE_DIR/index.php index.php
    ln -sf $_D6_CORE_DIR/install.php install.php
    ln -sf $_D6_CORE_DIR/misc misc
    ln -sf $_D6_CORE_DIR/modules modules
    ln -sf $_D6_CORE_DIR/themes themes
    ln -sf $_D6_CORE_DIR/update.php update.php
    ln -sf $_D6_CORE_DIR/xmlrpc.php xmlrpc.php
    cp -af $_D6_CORE_DIR/sites ./
  fi
  if [ ! -L "$_OCTO_PLPATH/profiles" ] && [ -d "$_SHRD_PLPATH/profiles" ] ; then
    rm -f -r $_OCTO_PLPATH/profiles
    ln -s $_SHRD_PLPATH/profiles $_OCTO_PLPATH/profiles
  fi
}
#
# Create D7 symlinks.
create_d7_symlinks () {
  if [ ! -L "web.config" ] ; then
    ln -sf $_D7_CORE_DIR/.htaccess .htaccess
    ln -sf $_D7_CORE_DIR/authorize.php authorize.php
    ln -sf $_D7_CORE_DIR/cron.php cron.php
    ln -sf $_D7_CORE_DIR/crossdomain.xml crossdomain.xml
    ln -sf $_D7_CORE_DIR/includes includes
    ln -sf $_D7_CORE_DIR/index.php index.php
    ln -sf $_D7_CORE_DIR/install.php install.php
    ln -sf $_D7_CORE_DIR/misc misc
    ln -sf $_D7_CORE_DIR/modules modules
    ln -sf $_D7_CORE_DIR/themes themes
    ln -sf $_D7_CORE_DIR/update.php update.php
    ln -sf $_D7_CORE_DIR/web.config web.config
    ln -sf $_D7_CORE_DIR/xmlrpc.php xmlrpc.php
    cp -af $_D7_CORE_DIR/sites ./
  fi
  if [ ! -L "$_OCTO_PLPATH/profiles" ] && [ -d "$_SHRD_PLPATH/profiles" ] ; then
    rm -f -r $_OCTO_PLPATH/profiles
    ln -s $_SHRD_PLPATH/profiles $_OCTO_PLPATH/profiles
  fi
}
#
# Create D8 symlinks.
create_d8_symlinks () {
  if [ ! -L "core" ] ; then
    ln -sf $_D8_CORE_DIR/.htaccess .htaccess
    ln -sf $_D8_CORE_DIR/core core
    ln -sf $_D8_CORE_DIR/crossdomain.xml crossdomain.xml
    ln -sf $_D8_CORE_DIR/index.php index.php
    ln -sf $_D8_CORE_DIR/web.config web.config
    cp -af $_D8_CORE_DIR/sites ./
  fi
  if [ ! -L "$_OCTO_PLPATH/profiles" ] && [ -d "$_SHRD_PLPATH/profiles" ] ; then
    rm -f -r $_OCTO_PLPATH/profiles
    ln -s $_SHRD_PLPATH/profiles $_OCTO_PLPATH/profiles
  fi
}
#
# Rename D7 profiles.
rename_drupal7_profiles () {
  for Files in `find ./profiles -type f`
  do
    sed -i "s/name = Minimal/name = Vanilla Minimal/g"   $Files &> /dev/null
    sed -i "s/name = Standard/name = Vanilla Standard/g" $Files &> /dev/null
  done
  sed -i "s/Vanilla Minimal/Vanilla Minimal\nold_short_name = testing/g" ./profiles/minimal/minimal.info
  sed -i "s/Vanilla Standard/Vanilla Standard\nold_short_name = minimal/g" ./profiles/standard/standard.info
  rm -f -r ./profiles/testing
}
#
# Rename D8 profiles.
rename_drupal8_profiles () {
  for Files in `find ./core/profiles -type f`
  do
    sed -i "s/name = Minimal/name = Vanilla Minimal/g"   $Files &> /dev/null
    sed -i "s/name = Standard/name = Vanilla Standard/g" $Files &> /dev/null
  done
  sed -i "s/Vanilla Minimal/Vanilla Minimal\nold_short_name = testing/g" ./core/profiles/minimal/minimal.info
  sed -i "s/Vanilla Standard/Vanilla Standard\nold_short_name = minimal/g" ./core/profiles/standard/standard.info
  rm -f -r ./core/profiles/testing
}
#
# Prepare D6 core.
prepare_drupal6_core () {
  if [ ! -e "$_D6_CORE_DIR" ] ; then
    mkdir -p /data/all/000/core
    rm -f -r $_D6_CORE_DIR
    cd /data/all/000/core
    curl -s -A iCab "http://files.aegir.cc/dev/pressflow-$_SMALLCORE6.tar.gz" | tar -xzf -
    cd $_D6_CORE_DIR/
    fix_dirs_files
    patch -p0 < /opt/tmp/$_BOA_REPO_NAME/aegir/patches/taxonomy-6.26.patch &> /dev/null
    rm -f $_D6_CORE_DIR/modules/taxonomy/taxonomy.module.orig
    rm -f modules/o_contrib
    ln -s $_CORE/o_contrib modules/o_contrib
    cp -af $_CORE/o_contrib/image/image.imagemagick.inc includes/
    cp -af $_CORE/o_contrib/boost/stats/boost_stats.php ./ &> /dev/null
    cd $_D6_CORE_DIR/themes
    curl -s -A iCab "http://ftp.drupal.org/files/projects/rubik-6.x-3.0-beta5.tar.gz" | tar -xzf -
    curl -s -A iCab "http://ftp.drupal.org/files/projects/tao-6.x-3.3.tar.gz" | tar -xzf -
    rm -f $_D6_CORE_DIR/sites/all/*.txt
    cd $_CORE
  fi
}
#
# Prepare D7 core.
prepare_drupal7_core () {
  if [ ! -e "$_D7_CORE_DIR" ] ; then
    mkdir -p /data/all/000/core
    rm -f -r $_D7_CORE_DIR
    cd /data/all/000/core
    curl -s -A iCab "http://files.aegir.cc/dev/drupal-$_SMALLCORE7.tar.gz" | tar -xzf -
    cd $_D7_CORE_DIR/
    fix_dirs_files
    rename_drupal7_profiles
    patch -p0 < /opt/tmp/$_BOA_REPO_NAME/aegir/patches/taxonomy-7.12.patch &> /dev/null
    rm -f $_D7_CORE_DIR/modules/taxonomy/taxonomy.module.orig
    rm -f modules/o_contrib_seven
    ln -s $_CORE/o_contrib_seven modules/o_contrib_seven
    cd $_D7_CORE_DIR/themes
    curl -s -A iCab "http://ftp.drupal.org/files/projects/rubik-7.x-4.0-beta9.tar.gz" | tar -xzf -
    curl -s -A iCab "http://ftp.drupal.org/files/projects/tao-7.x-3.0-beta4.tar.gz" | tar -xzf -
    cd $_CORE
  fi
}
#
# Prepare D8 core.
prepare_drupal8_core () {
  if [ ! -e "$_D8_CORE_DIR" ] ; then
    mkdir -p /data/all/000/core
    rm -f -r $_D8_CORE_DIR
    cd /data/all/000/core
    curl -s -A iCab "http://files.aegir.cc/dev/drupal-$_SMALLCORE8.tar.gz" | tar -xzf -
    cd $_D8_CORE_DIR/
    fix_dirs_files
    rename_drupal8_profiles
    rm -f modules/o_contrib_eight
    ln -s $_CORE/o_contrib_eight modules/o_contrib_eight
    cd $_CORE
  fi
}
#
# Remove D6 core from distro directory.
nocore_d6_dist_clean () {
  rm -f $_SHRD_PLPATH/.gitignore
  rm -f $_SHRD_PLPATH/.htaccess
  rm -f $_SHRD_PLPATH/*.php
  rm -f $_SHRD_PLPATH/*.txt
  rm -f $_SHRD_PLPATH/*.xml
  rm -f -r $_SHRD_PLPATH/cache
  rm -f -r $_SHRD_PLPATH/includes
  rm -f -r $_SHRD_PLPATH/misc
  rm -f -r $_SHRD_PLPATH/modules
  rm -f -r $_SHRD_PLPATH/sites
  rm -f -r $_SHRD_PLPATH/scripts
  rm -f -r $_SHRD_PLPATH/themes
  if [ ! -d "$_SHRD_PLPATH/profiles" ] && [ -d "$_D6_CORE_DIR/profiles" ] ; then
    rm -f -r $_SHRD_PLPATH/profiles
    cp -af $_D6_CORE_DIR/profiles $_SHRD_PLPATH/
  fi
  sed -i "s/'dblog'/'robotstxt', 'path_alias_cache'/g" $_SHRD_PRPATH/$_REAL_PRNAME.profile &> /dev/null
}
#
# Remove D7 core from distro directory.
nocore_d7_dist_clean () {
  rm -f $_SHRD_PLPATH/.gitignore
  rm -f $_SHRD_PLPATH/.htaccess
  rm -f $_SHRD_PLPATH/*.php
  rm -f $_SHRD_PLPATH/*.txt
  rm -f $_SHRD_PLPATH/*.xml
  rm -f $_SHRD_PLPATH/web.config
  rm -f -r $_SHRD_PLPATH/cache
  rm -f -r $_SHRD_PLPATH/includes
  rm -f -r $_SHRD_PLPATH/misc
  rm -f -r $_SHRD_PLPATH/modules
  rm -f -r $_SHRD_PLPATH/sites
  rm -f -r $_SHRD_PLPATH/scripts
  rm -f -r $_SHRD_PLPATH/themes
  _REVISIONS="10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26"
  for i in $_REVISIONS; do
    if [ -d "$_CORE/drupal-7.$i" ] && [ ! -e "$_SHRD_PLPATH" ] ; then
      mv $_CORE/drupal-7.$i $_SHRD_PLPATH
    fi
  done
  if [ ! -d "$_SHRD_PLPATH/profiles" ] && [ -d "$_D7_CORE_DIR/profiles" ] ; then
    rm -f -r $_SHRD_PLPATH/profiles
    cp -af $_D7_CORE_DIR/profiles $_SHRD_PLPATH/
  fi
}
#
# Remove D8 core from distro directory.
nocore_d8_dist_clean () {
  rm -f $_SHRD_PLPATH/.gitignore
  rm -f $_SHRD_PLPATH/.htaccess
  rm -f $_SHRD_PLPATH/*.php
  rm -f $_SHRD_PLPATH/*.txt
  rm -f $_SHRD_PLPATH/*.xml
  rm -f $_SHRD_PLPATH/web.config
  rm -f -r $_SHRD_PLPATH/cache
  rm -f -r $_SHRD_PLPATH/core
  rm -f -r $_SHRD_PLPATH/includes
  rm -f -r $_SHRD_PLPATH/misc
  rm -f -r $_SHRD_PLPATH/modules
  rm -f -r $_SHRD_PLPATH/scripts
  rm -f -r $_SHRD_PLPATH/sites
  rm -f -r $_SHRD_PLPATH/themes
  if [ ! -d "$_SHRD_PLPATH/profiles" ] && [ -d "$_D8_CORE_DIR/profiles" ] ; then
    rm -f -r $_SHRD_PLPATH/profiles
    cp -af $_D8_CORE_DIR/profiles $_SHRD_PLPATH/
  fi
}
#
# Enable D6 admin.
enable_drupal6_admin () {
  sed -i "s/'path_alias_cache'/'path_alias_cache', 'admin'/g" $_SHRD_PRPATH/$_REAL_PRNAME.profile &> /dev/null
}
#
# Remove default core seven profiles.
remove_default_core_seven_profiles () {
  rm -f -r $_SHRD_PLPATH/profiles/minimal
  rm -f -r $_SHRD_PLPATH/profiles/standard
  rm -f -r $_SHRD_PLPATH/profiles/testing
}
#
# Add old short name seven.
add_old_short_name_seven () {
  sed -i "s/Drupal Minimal/Drupal Minimal\nold_short_name = testing/g" $_SHRD_PLPATH/profiles/minimal/minimal.info &> /dev/null
  sed -i "s/Drupal Standard/Drupal Standard\nold_short_name = minimal/g" $_SHRD_PLPATH/profiles/standard/standard.info &> /dev/null
}
#
# Init this distro root.
init_this_distro_root () {
  mkdir -p $_OCTO_PLPATH
  cd $_OCTO_PLPATH
  if [[ "$_SHRD_PLNAME" =~ "-$_SMALLCORE6" ]] ; then
    create_d6_symlinks
  elif [[ "$_SHRD_PLNAME" =~ "-$_SMALLCORE7" ]] ; then
    create_d7_symlinks
  else
    create_d8_symlinks
  fi
}
#
# Add old short name acquia.
add_old_short_name_acquia () {
  sed -i "s/=> 'Pressflow',/=> 'Pressflow',\n    'old_short_name' => 'acquia',/g" $_SHRD_PRPATH/$_REAL_PRNAME.profile &> /dev/null
}
#
# Upgrade contrib less.
upgrade_contrib_less () {
  rm -f -r {ctools,entity,rules,views}
  wget -q -U iCab http://files.aegir.cc/dev/contrib/ctools-7.x-1.3.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/entity-7.x-1.2.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/rules-7.x-2.3.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/views-7.x-3.7.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  cd views
  # http://drupal.org/node/1766338#comment-6445882
  curl -s -O -A iCab https://drupal.org/files/views-revert-broken-filter-or-groups-1766338-7.patch
  patch -p1 < views-revert-broken-filter-or-groups-1766338-7.patch &> /dev/null
  if [ -e "../apps" ] ; then
    cd ../apps
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/apps_msg.patch ./
    patch -p1 < apps_msg.patch &> /dev/null
  fi
  cd ../
}
#
# Upgrade contrib more.
upgrade_contrib_more () {
  rm -f -r {apps,calendar,ctools,date,email,entity,facetapi,features,fontyourface,libraries,module_filter,panels_breadcrumbs,pathauto,rules,search_api,simple_gmap,taxonomy_menu,token,views,views_bulk_operations}
  wget -q -U iCab http://files.aegir.cc/dev/contrib/apps-7.x-1.0-beta7.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/calendar-7.x-3.4.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/ctools-7.x-1.3.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/date-7.x-2.6.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/email-7.x-1.2.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/entity-7.x-1.2.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/facetapi-7.x-1.2.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/features-7.x-2.0-rc3.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/fontyourface-7.x-2.7.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/libraries-7.x-2.1.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/module_filter-7.x-1.7.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/panels_breadcrumbs-7.x-2.0.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/pathauto-7.x-1.2.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/rules-7.x-2.3.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/search_api-7.x-1.4.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/simple_gmap-7.x-1.0.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/taxonomy_menu-7.x-1.4.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/token-7.x-1.5.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/views_bulk_operations-7.x-3.1.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/views-7.x-3.7.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  cd views
  # http://drupal.org/node/1766338#comment-6445882
  curl -s -O -A iCab https://drupal.org/files/views-revert-broken-filter-or-groups-1766338-7.patch
  patch -p1 < views-revert-broken-filter-or-groups-1766338-7.patch &> /dev/null
  cd ../apps
  cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/apps_msg.patch ./
  patch -p1 < apps_msg.patch &> /dev/null
  cd ../
}
#
# Upgrade contrib some.
upgrade_contrib_some () {
  rm -f -r {breakpoints,libraries,link,linkit,navbar,rules,token,views}
  wget -q -U iCab http://files.aegir.cc/dev/contrib/breakpoints-7.x-1.x-dev.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/libraries-7.x-2.1.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/link-7.x-1.1.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/linkit-7.x-2.6.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/navbar-7.x-1.0-alpha5.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/rules-7.x-2.3.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/token-7.x-1.5.tar.gz
  wget -q -U iCab http://files.aegir.cc/dev/contrib/views-7.x-3.7.tar.gz
  for archive in ./*.tar.gz; do
    tar -xzf "$archive" &> /dev/null
  done
  rm -f *.tar.gz
  cd views
  # http://drupal.org/node/1766338#comment-6445882
  curl -s -O -A iCab https://drupal.org/files/views-revert-broken-filter-or-groups-1766338-7.patch
  patch -p1 < views-revert-broken-filter-or-groups-1766338-7.patch &> /dev/null
  if [ -e "../apps" ] ; then
    cd ../apps
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/apps_msg.patch ./
    patch -p1 < apps_msg.patch &> /dev/null
  fi
  cd ../
}
#
# Create D7 basic platform.
create_drupal7_basic () {
  if [ ! -d "$_SHRD_PLPATH" ] ; then
    mkdir -p $_SHRD_PLPATH
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    nocore_d7_dist_clean
    add_old_short_name_seven
  fi
  init_this_distro_root
}


###---### Checking status.
#
if [ -e "$_ROOT/log/setupmail.txt" ] ; then
  _STATUS=UPGRADE
  cd $_ROOT
fi


###---### User check.
#
msg "$_STATUS C: Aegir automated install script part C"
if [ `whoami` = "root" ] ; then
  msg "$_STATUS C: FATAL ERROR: This script should be ran as a non-root user"
  msg "$_STATUS C: FATAL ERROR: Aborting AegirSetupC installer NOW!"
  touch /opt/tmp/status-AegirSetupC-FAIL
  exit 1
fi


###---### Hot Sauce check.
#
if [ "$_HOT_SAUCE" = "NO" ] ; then
  _CORE="/data/all/$_LAST_ALL"
  _THIS_CORE="$_LAST_ALL"
  if [ "$_USE_CURRENT" = "YES" ] && [ -e "/data/all/000/core-v-$_SMALLCORE6.txt" ] && [ -e "/data/all/000/core-v-$_SMALLCORE7.txt" ] ; then
    msg "$_STATUS C: Shared platforms code v.$_LAST_ALL (latest available) will be used for this install"
  elif [ "$_USE_CURRENT" = "NO" ] || [ ! -e "/data/all/000/core-v-$_SMALLCORE6.txt" ] || [ ! -e "/data/all/000/core-v-$_SMALLCORE7.txt" ] ; then
    _CORE="/data/all/$_ALL_DISTRO"
    _THIS_CORE="$_ALL_DISTRO"
    msg "$_STATUS C: Shared platforms code v.$_ALL_DISTRO (hot new) will be created"
  else
    msg "$_STATUS C: Shared platforms code v.$_LAST_ALL (latest available) will be used for this install"
  fi
else
  _CORE="/data/all/$_ALL_DISTRO"
  _THIS_CORE="$_ALL_DISTRO"
  msg "$_STATUS C: Shared platforms code v.$_ALL_DISTRO (hot new) will be created"
fi
_D6_CORE_DIR="/data/all/000/core/pressflow-$_SMALLCORE6"
_D7_CORE_DIR="/data/all/000/core/drupal-$_SMALLCORE7"
_D8_CORE_DIR="/data/all/000/core/drupal-$_SMALLCORE8"


###---### Distributions full names.
#
_F_ACQUIA="Acquia $_SMALLCORE6 P.$_THIS_CORE"
_F_CIVICRM_M6="CiviCRM $_CIVICRM_M6 $_SMALLCORE6 P.$_THIS_CORE"
_F_CIVICRM_M7="CiviCRM $_CIVICRM_M7 $_SMALLCORE7 P.$_THIS_CORE"
_F_COD="Conference 1.0-rc2 $_SMALLCORE6 P.$_THIS_CORE"
_F_COM_MERCE="Commerce 2.9 $_SMALLCORE7 P.$_THIS_CORE"
_F_COMMERCE="Commerce 1.19 $_SMALLCORE7 P.$_THIS_CORE"
_F_D6COMMONS="Commons 2.13 $_SMALLCORE6 P.$_THIS_CORE"
_F_D7COMMONS="Commons 3.4-rc1 $_SMALLCORE7 P.$_THIS_CORE"
_F_DRUPAL_EDGE_8="Drupal $_DRUPAL_EDGE_8"
_F_DRUPAL6="Drupal $_SMALLCORE6 P.$_THIS_CORE"
_F_DRUPAL7="Drupal $_SMALLCORE7 P.$_THIS_CORE"
_F_DRUPAL8="Drupal $_SMALLCORE8 P.$_THIS_CORE"
_F_FSERVER="Feature Server 1.2 $_SMALLCORE6 P.$_THIS_CORE"
_F_MANAGINGNEWS="MNews $_MANAGINGNEWS $_SMALLCORE6 P.$_THIS_CORE"
_F_NODESTREAM7="NodeStream 2.0-rc5 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENACADEMY="Open Academy 1.0-rc2 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENATRIUM6="Open Atrium 1.7.1 $_SMALLCORE6 P.$_THIS_CORE"
_F_OPENATRIUM7="Open Atrium 2.0-b4 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENCHURCH="OpenChurch 1.11-b13 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENDEALS="Open Deals $_OPEN_DEALS $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENOUTREACH="Open Outreach 1.1 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENPUBLISH="OpenPublish 3.0-b7 $_SMALLCORE7 P.$_THIS_CORE"
_F_OPENSCHOLAR="OpenScholar 3.8.1 $_SMALLCORE7 P.$_THIS_CORE"
_F_PANOPOLY="Panopoly 1.0-rc5 $_SMALLCORE7 P.$_THIS_CORE"
_F_PROSEPOINT="Prosepoint $_PROSEPOINT $_SMALLCORE6 P.$_THIS_CORE"
_F_UBER_CART_SEVEN="Ubercart $_UBER_CART_SEVEN $_SMALLCORE7 P.$_THIS_CORE"
_F_UBERCART="Ubercart $_UBERCART $_SMALLCORE6 P.$_THIS_CORE"
#
_F_DRUPAL6_D="Drupal $_SMALLCORE6 D.$_THIS_CORE"
_F_DRUPAL6_S="Drupal $_SMALLCORE6 S.$_THIS_CORE"
_F_DRUPAL6_P="Drupal $_SMALLCORE6 P.$_THIS_CORE"
_F_DRUPAL7_D="Drupal $_SMALLCORE7 D.$_THIS_CORE"
_F_DRUPAL7_S="Drupal $_SMALLCORE7 S.$_THIS_CORE"
_F_DRUPAL7_P="Drupal $_SMALLCORE7 P.$_THIS_CORE"


###---### Create directories.
#
mkdir -p $_ROOT/distro/$_THIS_CORE
chmod 0711 $_ROOT/distro &> /dev/null
chmod 0711 $_ROOT/distro/$_THIS_CORE &> /dev/null


###---###
_ALLOW_ALL=YES
_ALLOW_CIVICRM=YES
if [ "$_CLIENT_CORES" -lt "1" ] ; then
  _ALLOW_ALL=NO
  _ALLOW_CIVICRM=NO
  _D_8_ALLOW=NO
fi
if [[ "$_DOMAIN" =~ ".host8." ]] ; then
  _D_8_ALLOW=NO
fi
if [[ "$_DOMAIN" =~ "v182q.nyc.host8.biz" ]] ; then
  _D_8_ALLOW=YES
fi


acquia_install () {
###---### Acquia
#
_REAL_PRNAME="acquia"
_SHRD_PLNAME="$_REAL_PRNAME-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ AQ6 ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_ACQUIA - http://bit.ly/acquiadrupal" ; then
true
msg "DISTRO: $_F_ACQUIA installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    get_distro_ext "vanilla-$_SHRD_PLNAME.tar.gz" &> /dev/null
    nocore_d6_dist_clean
    sed -i "s/=> 'Acquia Drupal',/=> 'Acquia Drupal',\n    'old_short_name' => 'default',/g" $_SHRD_PRPATH/$_REAL_PRNAME.profile &> /dev/null
    rm -f -r $_SHRD_PLPATH/profiles/default
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_ACQUIA installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_ACQUIA installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


civicrm_m6_install () {
###---### CiviCRM Modern D6
#
_REAL_PRNAME="default"
_SHRD_PLNAME="civicrm-$_CIVICRM_M6-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_CIVICRM" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CM6 ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_CIVICRM_M6 - http://civicrm.org" ; then
true
msg "DISTRO: $_F_CIVICRM_M6 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/civicrm-4.1-d6.make ./
    $_DRUSHCMD make civicrm-4.1-d6.make $_SHRD_PLNAME &> /dev/null
    rm -f civicrm-4.1-d6.make
    _CIVI_ENGAGE="$_SHRD_PLPATH/sites/all/modules/civicrm/drupal/modules/civicrm_engage"
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/civicrm_engage.install $_CIVI_ENGAGE/civicrm_engage.install &> /dev/null
    if [ ! -d "$_SHRD_PLPATH/sites/all/modules/civicrm/l10n" ] && [ -d "$_SHRD_PLPATH/sites/all/modules/civicrm/civicrm_l10n/l10n" ] ; then
      mv $_SHRD_PLPATH/sites/all/modules/civicrm/civicrm_l10n/l10n $_SHRD_PLPATH/sites/all/modules/civicrm/ &> /dev/null
    fi
    mkdir -p $_SHRD_PRPATH/modules
    mv $_SHRD_PLPATH/sites/all/modules/civicrm $_SHRD_PRPATH/modules/ &> /dev/null
    nocore_d6_dist_clean
    add_old_short_name_acquia
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_CIVICRM_M6 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_CIVICRM_M6 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


civicrm_m7_install () {
###---### CiviCRM Modern D7
#
_REAL_PRNAME="standard"
_SHRD_PLNAME="civicrm-$_CIVICRM_M7-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_CIVICRM" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CM7 ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_CIVICRM_M7 - http://civicrm.org" ; then
true
msg "DISTRO: $_F_CIVICRM_M7 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/makefiles/civicrm-4.3-d7.make ./
    $_DRUSHCMD make civicrm-4.3-d7.make $_SHRD_PLNAME &> /dev/null
    rm -f civicrm-4.3-d7.make
    if [ ! -d "$_SHRD_PLPATH/sites/all/modules/civicrm/l10n" ] && [ -d "$_SHRD_PLPATH/sites/all/modules/civicrm/civicrml10n/l10n" ] ; then
      mv $_SHRD_PLPATH/sites/all/modules/civicrm/civicrml10n/l10n $_SHRD_PLPATH/sites/all/modules/civicrm/ &> /dev/null
    fi
    mkdir -p $_SHRD_PRPATH/modules
    mv $_SHRD_PLPATH/sites/all/modules/civicrm $_SHRD_PRPATH/modules/ &> /dev/null
    rm -f -r $_SHRD_PLPATH/profiles/testing
    rm -f -r $_SHRD_PLPATH/profiles/minimal
    nocore_d7_dist_clean
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_CIVICRM_M7 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_CIVICRM_M7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


cod_install () {
###---### Conference Organizing Distribution
#
_REAL_PRNAME="cod"
_SHRD_PLNAME="$_REAL_PRNAME-$_COD-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ COD ]] ; then
if [ ! -L "$_OCTO_PLPATH/sites/all/libraries/jquery.ui" ] ; then
echo " "
if prompt_yes_no "$_F_COD - http://usecod.com" ; then
true
msg "DISTRO: $_F_COD installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    if [ -d "$_CORE/$_REAL_PRNAME-$_COD" ] ; then
      mv $_CORE/$_REAL_PRNAME-$_COD $_CORE/$_REAL_PRNAME-$_COD-old
    fi
    wget -q -U iCab http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_COD-core.tar.gz
    tar -xzf $_REAL_PRNAME-$_COD-core.tar.gz
    rm -f $_REAL_PRNAME-$_COD-core.tar.gz
    if [ -d "$_CORE/$_REAL_PRNAME" ] ; then
      mv $_CORE/$_REAL_PRNAME $_SHRD_PLPATH
    else
      mv $_CORE/$_REAL_PRNAME-$_COD $_SHRD_PLPATH
    fi
    if [ -d "$_CORE/$_REAL_PRNAME-$_COD-old" ] ; then
      mv $_CORE/$_REAL_PRNAME-$_COD-old $_CORE/$_REAL_PRNAME-$_COD
    fi
    nocore_d6_dist_clean
    sed -i "s/Conference Organizing Distribution/Conference/g" $_SHRD_PRPATH/$_REAL_PRNAME.profile &> /dev/null
    rm -f -r $_SHRD_PLPATH/profiles/default
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
if [ ! -L "$_OCTO_PLPATH/sites/all/libraries/jquery.ui" ] ; then
  mkdir -p $_OCTO_PLPATH/sites/all/libraries
  ln -sf $_SHRD_PLPATH/profiles/$_REAL_PRNAME/modules/contrib/jquery_ui/jquery.ui $_OCTO_PLPATH/sites/all/libraries/jquery.ui
fi
msg "DISTRO: $_F_COD installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_COD installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


commerce_7_1_install () {
###---### Commerce 7.x-1.x
#
_REAL_PRNAME="commerce_kickstart"
_SHRD_PLNAME="commerce-$_COMMERCE-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ DCE ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_COMMERCE - http://drupalcommerce.org" ; then
true
msg "DISTRO: $_F_COMMERCE installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_COMMERCE-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/commerce-$_COMMERCE" ] ; then
      mv commerce-$_COMMERCE $_SHRD_PLNAME
    elif [ -d "$_CORE/$_REAL_PRNAME-$_COMMERCE" ] ; then
      mv $_REAL_PRNAME-$_COMMERCE $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    cd $_SHRD_PRPATH
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_REAL_PRNAME.patch ./
    patch -p1 < $_REAL_PRNAME.patch &> /dev/null
    if [ $_COMMERCE = "7.x-1.18" ] ; then
      cd $_SHRD_PRPATH/modules
      rm -f -r {addressfield,entity}
      wget -q -U iCab http://files.aegir.cc/dev/contrib/entity-7.x-1.2.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/addressfield-7.x-1.0-beta4.tar.gz
      for archive in ./*.tar.gz; do
        tar -xzf "$archive" &> /dev/null
      done
      rm -f *.tar.gz
    fi
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_COMMERCE installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_COMMERCE installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


commerce_7_2_install () {
###---### Commerce 7.x-2.x
#
_REAL_PRNAME="commerce_kickstart"
_SHRD_PLNAME="commerce-$_COM_MERCE-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CME ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_COM_MERCE - http://drupalcommerce.org" ; then
true
msg "DISTRO: $_F_COM_MERCE installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_COM_MERCE-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/commerce-$_COM_MERCE" ] ; then
      mv commerce-$_COM_MERCE $_SHRD_PLNAME
    elif [ -d "$_CORE/$_REAL_PRNAME-$_COM_MERCE" ] ; then
      mv $_REAL_PRNAME-$_COM_MERCE $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    if [ $_COM_MERCE = "7.x-2.5" ] ; then
      cd $_SHRD_PRPATH/modules/contrib
      rm -f -r {message_notify}
      wget -q -U iCab http://files.aegir.cc/dev/contrib/message_notify-7.x-2.4.tar.gz
      for archive in ./*.tar.gz; do
        tar -xzf "$archive" &> /dev/null
      done
      rm -f *.tar.gz
      upgrade_contrib_less
    elif [ $_COM_MERCE = "7.x-2.6" ] ; then
      cd $_SHRD_PRPATH/modules/contrib
      rm -f -r {message_notify}
      wget -q -U iCab http://files.aegir.cc/dev/contrib/message_notify-7.x-2.4.tar.gz
      for archive in ./*.tar.gz; do
        tar -xzf "$archive" &> /dev/null
      done
      rm -f *.tar.gz
      cd views
      # http://drupal.org/node/1766338#comment-6445882
      curl -s -O -A iCab https://drupal.org/files/views-revert-broken-filter-or-groups-1766338-7.patch
      patch -p1 < views-revert-broken-filter-or-groups-1766338-7.patch &> /dev/null
      cd ../
    fi
    remove_default_core_seven_profiles
    cd $_SHRD_PRPATH
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_REAL_PRNAME.patch ./
    patch -p1 < $_REAL_PRNAME.patch &> /dev/null
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_COM_MERCE installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_COM_MERCE installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


commons_6_install () {
###---### Commons 6.x
#
_REAL_PRNAME="drupal_commons"
_SHRD_PLNAME="commons-$_D6COMMONS-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ DCS ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_D6COMMONS - http://acquia.com/drupalcommons" ; then
true
msg "DISTRO: $_F_D6COMMONS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    get_distro_ext "commons-$_D6COMMONS.tar.gz" &> /dev/null
    if [ -d "$_CORE/acquia_commons" ] ; then
      mv $_CORE/acquia_commons $_SHRD_PLPATH
    elif [ -d "$_CORE/commons-$_D6COMMONS" ] ; then
      mv $_CORE/commons-$_D6COMMONS $_SHRD_PLPATH
    else
      mv $_CORE/commons $_SHRD_PLPATH
    fi
    if [ $_D6COMMONS = "6.x-2.13" ] ; then
      cd $_SHRD_PRPATH/modules/contrib/og
      cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/og_update_6205_commons_fix.patch ./
      patch -p1 < og_update_6205_commons_fix.patch &> /dev/null
    fi
    rm -f -r $_SHRD_PLPATH/profiles/default
    nocore_d6_dist_clean
    sed -i "s/'Commons'/'Commons 2'/g" $_SHRD_PRPATH/$_REAL_PRNAME.profile &> /dev/null
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
if [ ! -L "$_OCTO_PLPATH/sites/all/libraries/getid3" ] ; then
  mkdir -p $_OCTO_PLPATH/sites/all/libraries
  ln -sf $_SHRD_PRPATH/libraries/getid3 $_OCTO_PLPATH/sites/all/libraries/getid3
fi
msg "DISTRO: $_F_D6COMMONS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_D6COMMONS installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


commons_7_install () {
###---### Commons 7.x
#
_REAL_PRNAME="commons"
_SHRD_PLNAME="commons-$_D7COMMONS-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ CS7 ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_D7COMMONS - http://acquia.com/drupalcommons" ; then
true
msg "DISTRO: $_F_D7COMMONS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_D7COMMONS-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_D7COMMONS" ] ; then
      mv $_REAL_PRNAME-$_D7COMMONS $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    cd $_SHRD_PRPATH
    sed -i "s/name = Commons/name = Commons 3/g" $_SHRD_PRPATH/$_REAL_PRNAME.info &> /dev/null
    rm -f -r $_SHRD_PRPATH/modules/contrib/entitycache
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_D7COMMONS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_D7COMMONS installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


drupal6_install () {
###---### Drupal 6 Pressflow
#
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6D ]] || [[ $_PLATFORMS_LIST =~ D6S ]] || [[ $_PLATFORMS_LIST =~ D6P ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL6 - http://pressflow.org" ; then
true

###---### Drupal 6 Pressflow Development
#
_REAL_PRNAME="default"
_SHRD_PLNAME="pressflow-$_SMALLCORE6-dev"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6D ]] ; then
msg "DISTRO: $_F_DRUPAL6_D installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    mkdir -p $_SHRD_PLPATH
    nocore_d6_dist_clean
    enable_drupal6_admin
    add_old_short_name_acquia
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_DRUPAL6_D installation completed"
mrun "sleep 1"
echo " "
fi

###---### Drupal 6 Pressflow Staging
#
_REAL_PRNAME="default"
_SHRD_PLNAME="pressflow-$_SMALLCORE6-stage"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6S ]] ; then
msg "DISTRO: $_F_DRUPAL6_S installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    mkdir -p $_SHRD_PLPATH
    nocore_d6_dist_clean
    enable_drupal6_admin
    add_old_short_name_acquia
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_DRUPAL6_S installation completed"
mrun "sleep 1"
echo " "
fi

###---### Drupal 6 Pressflow Production
#
_REAL_PRNAME="default"
_SHRD_PLNAME="pressflow-$_SMALLCORE6-prod"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D6P ]] ; then
msg "DISTRO: $_F_DRUPAL6 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    mkdir -p $_SHRD_PLPATH
    nocore_d6_dist_clean
    enable_drupal6_admin
    add_old_short_name_acquia
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_DRUPAL6 installation completed"
mrun "sleep 1"
fi

else
  msg "DISTRO: $_F_DRUPAL6 installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


drupal7_install () {
###---### Drupal 7
#
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7D ]] || [[ $_PLATFORMS_LIST =~ D7S ]] || [[ $_PLATFORMS_LIST =~ D7P ]] ; then
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL7 - http://drupal.org/drupal-7.22" ; then
true

###---### Drupal 7 Development
#
_REAL_PRNAME="standard"
_SHRD_PLNAME="$_DRUPAL7D"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7D ]] ; then
  msg "DISTRO: $_F_DRUPAL7_D installation in progress..."
  mrun "sleep 1"
  create_drupal7_basic
  msg "DISTRO: $_F_DRUPAL7_D installation completed"
  mrun "sleep 1"
  echo " "
fi

###---### Drupal 7 Staging
#
_REAL_PRNAME="standard"
_SHRD_PLNAME="$_DRUPAL7S"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7S ]] ; then
  msg "DISTRO: $_F_DRUPAL7_S installation in progress..."
  mrun "sleep 1"
  create_drupal7_basic
  msg "DISTRO: $_F_DRUPAL7_S installation completed"
  mrun "sleep 1"
  echo " "
fi

###---### Drupal 7 Production
#
_REAL_PRNAME="standard"
_SHRD_PLNAME="$_DRUPAL7P"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D7P ]] ; then
  msg "DISTRO: $_F_DRUPAL7_P installation in progress..."
  mrun "sleep 1"
  create_drupal7_basic
  msg "DISTRO: $_F_DRUPAL7_P installation completed"
  mrun "sleep 1"
fi

else
  msg "DISTRO: $_F_DRUPAL7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


drupal8_install () {
###---### Drupal 8
#
_REAL_PRNAME="standard"
_SHRD_PLNAME="drupal-$_SMALLCORE8"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_D_8_ALLOW" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D8D ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL8 - http://drupal.org" ; then
true
msg "DISTRO: $_F_DRUPAL8 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ ! -e "$_D8_CORE_DIR" ] ; then
    prepare_drupal8_core
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_DRUPAL8 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_DRUPAL8 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


drupal_edge_8_install () {
###---### Drupal Edge 8
#
#_DRUPAL_EDGE_8="8.0-dev-$_TODAY"
#
_REAL_PRNAME="standard"
_SHRD_PLNAME="drupal-$_DRUPAL_EDGE_8"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_D_8_ALLOW" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ D8E ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_DRUPAL_EDGE_8 - http://drupal.org" ; then
true
msg "DISTRO: $_F_DRUPAL_EDGE_8 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  wget -q -U iCab http://files.aegir.cc/dev/contrib/drupal-8.x-dev.tar.gz
  tar -xzf drupal-8.x-dev.tar.gz
  rm -f drupal-8.x-dev.tar.gz
  mv drupal-8.x-dev $_SHRD_PLNAME
  rm -f -r $_SHRD_PLPATH/.git
  rm -f $_SHRD_PLPATH/*.txt
  rm -f $_SHRD_PLPATH/core/*.txt
  cd $_SHRD_PLPATH
fi
init_this_distro_root
msg "DISTRO: $_F_DRUPAL_EDGE_8 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_DRUPAL_EDGE_8 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


fserver_install () {
###---### Feature Server Make
#
_REAL_PRNAME="feature_server"
_SHRD_PLNAME="fserver-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ FSR ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_FSERVER - http://bit.ly/fservermore" ; then
true
msg "DISTRO: $_F_FSERVER installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [[ $_BOA_REPO_GIT_URL =~ drupal ]] ; then
      _BOA_REPO_GIT_URL_LOCAL="git://github.com/omega8cc"
    else
      _BOA_REPO_GIT_URL_LOCAL="$_BOA_REPO_GIT_URL"
    fi
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    echo "api = 2" > fserver.make
    echo "core = 6.x" >> fserver.make
    echo "projects[drupal][type] = \"core\"" >> fserver.make
    echo "projects[$_REAL_PRNAME][type] = \"profile\"" >> fserver.make
    echo "projects[$_REAL_PRNAME][download][type] = \"git\"" >> fserver.make
    echo "projects[$_REAL_PRNAME][download][url] = \"$_BOA_REPO_GIT_URL_LOCAL/$_REAL_PRNAME.git\"" >> fserver.make
    $_DRUSHCMD make fserver.make $_SHRD_PLNAME &> /dev/null
    nocore_d6_dist_clean
    rm -f fserver.make
    rm -f -r $_SHRD_PLPATH/profiles/default
    cd $_SHRD_PLPATH/profiles/$_REAL_PRNAME/themes
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/singular.patch ./
    patch -p0 <./singular.patch &> /dev/null
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/singular.mft.patch ./
    patch -p0 <./singular.mft.patch &> /dev/null
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_FSERVER installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_FSERVER installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


managingnews_install () {
###---### ManagingNews
#
_REAL_PRNAME="managingnews"
_SHRD_PLNAME="$_REAL_PRNAME-$_MANAGINGNEWS-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ MNS ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_MANAGINGNEWS - http://managingnews.com" ; then
true
msg "DISTRO: $_F_MANAGINGNEWS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    _MANAGINGNEWS_DL=1.2
    if [ -d "$_CORE/$_REAL_PRNAME-$_MANAGINGNEWS_DL" ] ; then
      mv $_CORE/$_REAL_PRNAME-$_MANAGINGNEWS_DL $_CORE/$_REAL_PRNAME-$_MANAGINGNEWS_DL-old
    fi
    get_distro_ext "$_REAL_PRNAME-$_MANAGINGNEWS_DL.tar.gz" &> /dev/null
    mv $_REAL_PRNAME-$_MANAGINGNEWS_DL $_SHRD_PLNAME
    if [ -d "$_CORE/$_REAL_PRNAME-$_MANAGINGNEWS_DL-old" ] ; then
      mv $_CORE/$_REAL_PRNAME-$_MANAGINGNEWS_DL-old $_CORE/$_REAL_PRNAME-$_MANAGINGNEWS_DL
    fi
    cd $_SHRD_PRPATH/modules/contrib
    rm -f -r context boxes data ctools features feeds imageapi imagecache libraries mapbox openlayers spaces views views_rss
    $_DRUSHCMD dl --destination=$_SHRD_PRPATH/modules/contrib context-6.x-3.1 boxes-6.x-1.1 data-6.x-1.1 ctools-6.x-1.10 features-6.x-1.2 feeds-6.x-1.0-beta13 imageapi-6.x-1.10 imagecache-6.x-2.x-dev libraries-6.x-1.0 mapbox-6.x-2.0-alpha1 openlayers-6.x-2.0-beta1 spaces-6.x-3.6 views-6.x-2.13 views_rss-6.x-2.0-rc3 -y &> /dev/null
    cd views
    # http://drupal.org/node/853864#comment-3898996
    curl -s -O -A iCab https://drupal.org/files/issues/views-853864_2.patch
    patch -p0 < views-853864_2.patch &> /dev/null
    # http://drupal.org/node/402944#comment-5370400
    curl -s -O -A iCab https://drupal.org/files/views-unpack_options-cache-6.2-51.patch
    patch -p1 < views-unpack_options-cache-6.2-51.patch &> /dev/null
    cd ../imagecache
    # http://drupal.org/node/1243258#comment-4850634
    curl -s -O -A iCab https://drupal.org/files/issues/imagecache-1243258-5.patch
    patch -p1 < imagecache-1243258-5.patch &> /dev/null
    cd $_SHRD_PRPATH/themes
    rm -f -r $_SHRD_PRPATH/themes/{rubik,tao}
    $_DRUSHCMD dl --destination=$_SHRD_PRPATH/themes rubik-6.x-3.0-beta3 tao-6.x-3.3 -y &> /dev/null
    nocore_d6_dist_clean
    enable_drupal6_admin
    rm -f -r $_SHRD_PLPATH/profiles/default
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_MANAGINGNEWS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_MANAGINGNEWS installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


nodestream7_install () {
###---### NodeStream7 Make
#
_REAL_PRNAME="nodestream"
_SHRD_PLNAME="$_REAL_PRNAME-$_NODESTREAM7-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ NS7 ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_NODESTREAM7 - http://nodestream.org" ; then
true
msg "DISTRO: $_F_NODESTREAM7 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_NODESTREAM7-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_NODESTREAM7" ] ; then
      mv $_REAL_PRNAME-$_NODESTREAM7 $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    rm -f -r $_SHRD_PRPATH/modules/contrib/speedy
    if [ $_NODESTREAM7 = "7.x-2.0-rc5" ] ; then
      cd $_SHRD_PRPATH/modules/contrib
      upgrade_contrib_less
    fi
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_NODESTREAM7 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_NODESTREAM7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openacademy_install () {
###---### Open Academy
#
_REAL_PRNAME="openacademy"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPENACADEMY-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OAY ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_OPENACADEMY - http://drupal.org/project/openacademy" ; then
true
msg "DISTRO: $_F_OPENACADEMY installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_OPENACADEMY-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENACADEMY" ] ; then
      mv $_REAL_PRNAME-$_OPENACADEMY $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENACADEMY installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENACADEMY installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openatrium6_install () {
###---### Open Atrium D6
#
_REAL_PRNAME="openatrium"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPENATRIUM6-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OAM ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_OPENATRIUM6 - http://openatrium.com" ; then
true
msg "DISTRO: $_F_OPENATRIUM6 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    wget -q -U iCab http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_OPENATRIUM6-core.tar.gz
    tar -xzf $_REAL_PRNAME-$_OPENATRIUM6-core.tar.gz
    rm -f $_REAL_PRNAME-$_OPENATRIUM6-core.tar.gz
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENATRIUM6" ] ; then
      mv $_REAL_PRNAME-$_OPENATRIUM6 $_SHRD_PLNAME
    fi
    cd $_SHRD_PRPATH/modules/contrib/imagecache
    # http://drupal.org/node/1243258#comment-4850634
    curl -s -O -A iCab https://drupal.org/files/issues/imagecache-1243258-5.patch
    patch -p1 < imagecache-1243258-5.patch &> /dev/null
    nocore_d6_dist_clean
    rm -f -r $_SHRD_PLPATH/profiles/default
    cd $_SHRD_PRPATH/modules/atrium_features/
    git clone git://github.com/nuvoleweb/atrium_folders.git &> /dev/null
    rm -f -r atrium_folders/.git
    $_DRUSHCMD dl --destination=$_SHRD_PRPATH/modules/atrium_features ideation-6.x-1.0-rc1 -y &> /dev/null
    $_DRUSHCMD dl --destination=$_SHRD_PRPATH/modules/contrib better_exposed_filters-6.x-1.0 fivestar-6.x-1.19 -y &> /dev/null
    $_DRUSHCMD dl --destination=$_SHRD_PRPATH/modules/contrib votingapi-6.x-2.3 data-6.x-1.0 -y &> /dev/null
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENATRIUM6 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENATRIUM6 installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


openatrium7_install () {
###---### Open Atrium D7
#
_REAL_PRNAME="openatrium"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPENATRIUM7-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OA7 ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_OPENATRIUM7 - http://openatrium.com" ; then
true
msg "DISTRO: $_F_OPENATRIUM7 installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_OPENATRIUM7-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENATRIUM7" ] ; then
      mv $_REAL_PRNAME-$_OPENATRIUM7 $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENATRIUM7 installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENATRIUM7 installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openchurch_install () {
###---### Open Church
#
_REAL_PRNAME="openchurch"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPENCHURCH-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OCH ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_OPENCHURCH - http://openchurchsite.com" ; then
true
msg "DISTRO: $_F_OPENCHURCH installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_OPENCHURCH-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENCHURCH" ] ; then
      mv $_REAL_PRNAME-$_OPENCHURCH $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    if [ $_OPENCHURCH = "7.x-1.11-beta9" ] ; then
      cd $_SHRD_PRPATH/modules/contrib
      upgrade_contrib_less
    fi
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENCHURCH installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENCHURCH installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


opendeals_install () {
###---### Open Deals
#
_REAL_PRNAME="opendeals"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPEN_DEALS-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ ODS ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_OPENDEALS - http://opendealsapp.com" ; then
true
msg "DISTRO: $_F_OPENDEALS installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_OPENDEALS-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENDEALS" ] ; then
      mv $_REAL_PRNAME-$_OPENDEALS $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    if [ $_OPENDEALS = "7.x-1.26" ] ; then
      cd $_SHRD_PRPATH/modules
      rm -f -r {diff}
      wget -q -U iCab http://files.aegir.cc/dev/contrib/diff-7.x-3.2.tar.gz
      for archive in ./*.tar.gz; do
        tar -xzf "$archive" &> /dev/null
      done
      rm -f *.tar.gz
    fi
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENDEALS installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENDEALS installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openoutreach_install () {
###---### Open Outreach
#
_REAL_PRNAME="openoutreach"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPENOUTREACH-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OOH ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_OPENOUTREACH - http://openoutreach.org" ; then
true
msg "DISTRO: $_F_OPENOUTREACH installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_OPENOUTREACH-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENOUTREACH" ] ; then
      mv $_REAL_PRNAME-$_OPENOUTREACH $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    if [ $_OPENOUTREACH = "7.x-1.0-rc10" ] ; then
      cd $_SHRD_PRPATH/modules/contrib
      rm -f -r {comment_notify,libraries}
      wget -q -U iCab http://files.aegir.cc/dev/contrib/comment_notify-7.x-1.2.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/libraries-7.x-2.1.tar.gz
      for archive in ./*.tar.gz; do
        tar -xzf "$archive" &> /dev/null
      done
      rm -f *.tar.gz
      upgrade_contrib_less
    fi
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENOUTREACH installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENOUTREACH installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openpublish_install () {
###---### OpenPublish
#
_REAL_PRNAME="openpublish"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPENPUBLISH-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OPH ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_OPENPUBLISH - http://openpublishapp.com" ; then
true
msg "DISTRO: $_F_OPENPUBLISH installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_OPENPUBLISH-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENPUBLISH" ] ; then
      mv $_REAL_PRNAME-$_OPENPUBLISH $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    if [ $_OPENPUBLISH = "7.x-1.0-beta7" ] ; then
      cd $_SHRD_PRPATH/modules/contrib
      rm -f -r $_SHRD_PRPATH/modules/contrib/{boxes,context,diff,entity_autocomplete,features_override,filefield_sources,google_analytics,imce,link,plupload,recaptcha,references,token,xmlsitemap}
      cd $_SHRD_PRPATH/modules/contrib
      wget -q -U iCab http://files.aegir.cc/dev/contrib/boxes-7.x-1.1.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/context-7.x-3.0-beta6.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/diff-7.x-3.2.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/entity_autocomplete-7.x-1.0-beta3.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/features_override-7.x-2.0-beta2.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/filefield_sources-7.x-1.7.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/google_analytics-7.x-1.3.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/imce-7.x-1.7.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/link-7.x-1.1.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/plupload-7.x-1.1.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/recaptcha-7.x-1.9.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/references-7.x-2.1.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/token-7.x-1.5.tar.gz
      wget -q -U iCab http://files.aegir.cc/dev/contrib/xmlsitemap-7.x-2.0-rc2.tar.gz
      for archive in ./*.tar.gz; do
        tar -xzf "$archive" &> /dev/null
      done
      rm -f *.tar.gz
      upgrade_contrib_less
    fi
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENPUBLISH installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENPUBLISH installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


openscholar_install () {
###---### OpenScholar
#
_REAL_PRNAME="openscholar"
_SHRD_PLNAME="$_REAL_PRNAME-$_OPENSCHOLAR-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ OSR ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_OPENSCHOLAR - http://openscholar.harvard.edu" ; then
true
msg "DISTRO: $_F_OPENSCHOLAR installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    get_distro_ext "$_REAL_PRNAME-$_OPENSCHOLAR.tar.gz" &> /dev/null
    if [ -d "$_CORE/$_REAL_PRNAME-$_OPENSCHOLAR" ] ; then
      mv $_REAL_PRNAME-$_OPENSCHOLAR $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_OPENSCHOLAR installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_OPENSCHOLAR installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


panopoly_install () {
###---### Panopoly
#
_REAL_PRNAME="panopoly"
_SHRD_PLNAME="$_REAL_PRNAME-$_PANOPOLY-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ PPY ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_PANOPOLY - http://drupal.org/project/panopoly" ; then
true
msg "DISTRO: $_F_PANOPOLY installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    curl -s -A iCab "http://ftp.drupal.org/files/projects/$_REAL_PRNAME-$_PANOPOLY-core.tar.gz" | tar -xzf -
    if [ -d "$_CORE/$_REAL_PRNAME-$_PANOPOLY" ] ; then
      mv $_REAL_PRNAME-$_PANOPOLY $_SHRD_PLNAME
    fi
    nocore_d7_dist_clean
    remove_default_core_seven_profiles
    if [ $_PANOPOLY = "7.x-1.0-rc5" ] ; then
      cd $_SHRD_PRPATH/modules/contrib
      rm -f -r {entity}
      wget -q -U iCab http://files.aegir.cc/dev/contrib/entity-7.x-1.2.tar.gz
      for archive in ./*.tar.gz; do
        tar -xzf "$archive" &> /dev/null
      done
      rm -f *.tar.gz
      cd $_CORE
    fi
    if [ -d "$_SHRD_PLPATH/sites/all/modules/panopoly_demo" ] && [ ! -d "$_SHRD_PRPATH/modules/panopoly/panopoly_demo" ] ; then
      mv -f $_SHRD_PLPATH/sites/all/modules/panopoly_demo $_SHRD_PRPATH/modules/panopoly/ &> /dev/null
    fi
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_PANOPOLY installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_PANOPOLY installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


prosepoint_install () {
###---### Prosepoint
#
_REAL_PRNAME="prosepoint"
_SHRD_PLNAME="$_REAL_PRNAME-$_PROSEPOINT-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_CLIENT_CORES" -ge "1" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ PPT ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_PROSEPOINT - http://prosepoint.org" ; then
true
msg "DISTRO: $_F_PROSEPOINT installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    if [ -d "$_CORE/$_REAL_PRNAME-$_PROSEPOINT" ] ; then
      mv $_CORE/$_REAL_PRNAME-$_PROSEPOINT $_CORE/$_REAL_PRNAME-$_PROSEPOINT-old
    fi
    get_distro_ext "$_REAL_PRNAME-$_PROSEPOINT.tar.gz" &> /dev/null
    mv $_CORE/$_REAL_PRNAME-$_PROSEPOINT $_SHRD_PLPATH
    if [ -d "$_CORE/$_REAL_PRNAME-$_PROSEPOINT-old" ] ; then
      mv $_CORE/$_REAL_PRNAME-$_PROSEPOINT-old $_CORE/$_REAL_PRNAME-$_PROSEPOINT
    fi
    rm -f -r $_SHRD_PLPATH/profiles/default
    nocore_d6_dist_clean
    sed -i "s/'robotstxt', 'path_alias_cache'/'path_alias_cache'/g" $_SHRD_PRPATH/$_REAL_PRNAME.profile &> /dev/null
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_PROSEPOINT installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_PROSEPOINT installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


ubercart6_install () {
###---### Ubercart 2
#
_REAL_PRNAME="uberdrupal"
_VIRT_PRNAME="ubercart"
_SHRD_PLNAME="$_VIRT_PRNAME-$_UBERCART-$_SMALLCORE6"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ UCT ]] ; then
if [ ! -d "$_OCTO_PLPATH/modules/path_alias_cache" ] ; then
echo " "
if prompt_yes_no "$_F_UBERCART - http://ubercart.org" ; then
true
msg "DISTRO: $_F_UBERCART installation in progress..."
mrun "sleep 1"
if [ -d "$_SHRD_PLPATH" ] && [ ! -e "$_SHRD_PLPATH/fixed_1.log" ] ; then
  rm -f -r $_SHRD_PLPATH
fi
if [ ! -d "$_SHRD_PLPATH" ] ; then
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D6_CORE_DIR" ] ; then
      prepare_drupal6_core
    fi
    cd $_CORE
    if [ -d "$_CORE/$_VIRT_PRNAME-$_UBERCART" ] ; then
      mv $_CORE/$_VIRT_PRNAME-$_UBERCART $_CORE/$_VIRT_PRNAME-$_UBERCART-old
    fi
    get_distro_ext "$_VIRT_PRNAME-$_UBERCART.tar.gz" &> /dev/null
    mv $_VIRT_PRNAME-$_UBERCART $_SHRD_PLNAME
    if [ -d "$_CORE/$_VIRT_PRNAME-$_UBERCART-old" ] ; then
      mv $_CORE/$_VIRT_PRNAME-$_UBERCART-old $_CORE/$_VIRT_PRNAME-$_UBERCART
    fi
    nocore_d6_dist_clean
    rm -f -r $_SHRD_PLPATH/profiles/default
    mkdir -p $_SHRD_PRPATH/libraries
    cd $_SHRD_PRPATH/libraries
    wget -q -U iCab https://github.com/jackmoore/colorbox/archive/master.zip
    unzip -qq master.zip &> /dev/null
    rm -f master.zip
    mv -f colorbox-master colorbox
    cd $_SHRD_PRPATH/modules
    rm -f -r $_SHRD_PRPATH/modules/{date,webform}
    wget -q -U iCab http://files.aegir.cc/dev/contrib/admin_menu-6.x-3.x-dev.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/cck-6.x-2.9.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/colorbox-6.x-1.2.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/date-6.x-2.9.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/filefield-6.x-3.10.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/google_analytics-6.x-3.4.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/imageapi-6.x-1.10.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/imagecache-6.x-2.x-dev.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/imagefield-6.x-3.10.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/libraries-6.x-1.0.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/lightbox2-6.x-1.x-dev.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/rules-6.x-1.5.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/skinr-6.x-1.6.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/token-6.x-1.19.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/ubercart-6.x-2.12.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/views-6.x-3.0.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/webform-6.x-3.18.tar.gz
    for archive in ./*.tar.gz; do
      tar -xzf "$archive" &> /dev/null
    done
    rm -f *.tar.gz
    ### http://drupal.org/node/1167276#comment-5138248
    cd $_SHRD_PRPATH/modules/$_VIRT_PRNAME
    cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/patches/$_VIRT_PRNAME-1167276-reroll.patch ./
    patch -p1 < $_VIRT_PRNAME-1167276-reroll.patch &> /dev/null
    cd $_SHRD_PRPATH/modules/imagecache
    # http://drupal.org/node/1243258#comment-4850634
    curl -s -O -A iCab https://drupal.org/files/issues/imagecache-1243258-5.patch
    patch -p1 < imagecache-1243258-5.patch &> /dev/null
    cd $_SHRD_PRPATH/themes
    wget -q -U iCab http://files.aegir.cc/dev/contrib/fusion-6.x-1.x-dev.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/acquia_prosper-6.x-1.1.tar.gz
    for archive in ./*.tar.gz; do
      tar -xzf "$archive" &> /dev/null
    done
    rm -f *.tar.gz
    touch $_SHRD_PLPATH/fixed_1.log
  else
    cd $_CORE
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_UBERCART installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_UBERCART installation skipped"
  mrun "sleep 1"
fi
fi
fi
}


ubercart7_install () {
###---### Ubercart 3
#
_REAL_PRNAME="acquia"
_VIRT_PRNAME="ubercart"
_SHRD_PLNAME="$_VIRT_PRNAME-$_UBER_CART_SEVEN-$_SMALLCORE7"
_SHRD_PLPATH="$_CORE/$_SHRD_PLNAME"
_SHRD_PRPATH="$_SHRD_PLPATH/profiles/$_REAL_PRNAME"
_OCTO_PLPATH="$_ROOT/distro/$_THIS_CORE/$_SHRD_PLNAME"
if [ "$_ALLOW_ALL" = "YES" ] ; then
if [ "$_PLATFORMS_LIST" = "ALL" ] || [[ $_PLATFORMS_LIST =~ UC7 ]] ; then
if [ ! -d "$_OCTO_PLPATH" ] ; then
echo " "
if prompt_yes_no "$_F_UBER_CART_SEVEN - http://ubercart.org" ; then
true
msg "DISTRO: $_F_UBER_CART_SEVEN installation in progress..."
mrun "sleep 1"
if [ ! -d "$_SHRD_PLPATH" ] ; then
  cd $_CORE
  if [ "$_AEGIR_VERSION" = "HEAD" ] && [ "$_T_BUILD" = "HEAD" ] ; then
    if [ ! -e "$_D7_CORE_DIR" ] ; then
      prepare_drupal7_core
    fi
    get_distro_ext "ubercart-$_UBER_CART_SEVEN.tar.gz" &> /dev/null
    mv -f ubercart-$_UBER_CART_SEVEN $_SHRD_PLNAME
    nocore_d7_dist_clean
    sed -i "s/Acquia Drupal/UberCart 3 Acquia\nold_short_name = uberdrupal/g" $_SHRD_PRPATH/acquia.info &> /dev/null
    sed -i "s/Acquia enchanced Drupal/Acquia with UberCart 3/g" $_SHRD_PRPATH/acquia.info &> /dev/null
    rm -f -r $_SHRD_PLPATH/profiles/minimal
    rm -f -r $_SHRD_PLPATH/profiles/testing
    sed -i "s/name = Standard/name = Vanilla Standard/g" $_SHRD_PLPATH/profiles/standard/standard.info &> /dev/null
    sed -i "s/Vanilla Standard/Vanilla Standard\nold_short_name = minimal/g" $_SHRD_PLPATH/profiles/standard/standard.info &> /dev/null
    mkdir -p $_SHRD_PRPATH/libraries
    cd $_SHRD_PRPATH/libraries
    wget -q -U iCab https://github.com/jackmoore/colorbox/archive/master.zip
    unzip -qq master.zip &> /dev/null
    rm -f master.zip
    mv -f colorbox-master colorbox
    rm -f -r $_SHRD_PRPATH/modules/{ctools,sqlsrv,token,pathauto}
    cd $_SHRD_PRPATH/modules
    wget -q -U iCab http://files.aegir.cc/dev/contrib/colorbox-7.x-2.3.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/ctools-7.x-1.3.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/entity-7.x-1.2.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/google_analytics-7.x-1.3.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/libraries-7.x-2.x-dev.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/pathauto-7.x-1.2.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/rules-7.x-2.3.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/token-7.x-1.5.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/ubercart-7.x-3.5.tar.gz
    wget -q -U iCab http://files.aegir.cc/dev/contrib/views-7.x-3.7.tar.gz
    for archive in ./*.tar.gz; do
      tar -xzf "$archive" &> /dev/null
    done
    rm -f *.tar.gz
    cd $_SHRD_PRPATH/modules/views
    # http://drupal.org/node/1766338#comment-6445882
    curl -s -O -A iCab https://drupal.org/files/views-revert-broken-filter-or-groups-1766338-7.patch
    patch -p1 < views-revert-broken-filter-or-groups-1766338-7.patch &> /dev/null
  else
    get_distro_ext "$_SHRD_PLNAME.tar.gz" &> /dev/null
  fi
fi
init_this_distro_root
msg "DISTRO: $_F_UBER_CART_SEVEN installation completed"
mrun "sleep 1"
else
  msg "DISTRO: $_F_UBER_CART_SEVEN installation skipped"
  mrun "sleep 1"
fi
fi
fi
fi
}


cod_install
commerce_7_1_install
commerce_7_2_install
commons_6_install
commons_7_install
drupal6_install
drupal7_install
fserver_install
managingnews_install
openacademy_install
openatrium6_install
openatrium7_install
openchurch_install
opendeals_install
openoutreach_install
openscholar_install
panopoly_install
prosepoint_install
ubercart6_install
ubercart7_install


if [ "$_ALLOW_UNSUPPORTED" = "YES" ] ; then
  acquia_install
  civicrm_m6_install
  civicrm_m7_install
  drupal_edge_8_install
  drupal8_install
  nodestream7_install
  openpublish_install
fi


###---### Remove some module and themes for all.
#
echo " "
msg "$_STATUS C: Removing some old core themes..."
rm -f -r $_CORE/*/themes/bluemarine
rm -f -r $_CORE/*/themes/chameleon
rm -f -r $_CORE/*/themes/pushbutton
rm -f -r $_CORE/*/scripts
rm -f $_CORE/*/themes/README.txt
rm -f $_CORE/*.make
rm -f $_CORE/*.tar.gz
cd $_CORE


###---### Save & verify platforms.
#
msg "$_STATUS C: Running Platforms Save & Verify tasks, please wait..."
_LOCAL_STATUS="NOT_SET"
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _LOCAL_STATUS=INIT
fi
if [ "$_LOCAL_STATUS" = "INIT" ] ; then
  _THIS_HOSTMASTER="$_AEGIR_ROOT/sites/$_DOMAIN"
  #msg "_THIS_HOSTMASTER is read static $_THIS_HOSTMASTER because _LOCAL_STATUS is $_LOCAL_STATUS"
else
  if [ -e "$_ROOT/.drush/hostmaster.alias.drushrc.php" ] ; then
    _THIS_HOSTMASTER=`cat $_ROOT/.drush/hostmaster.alias.drushrc.php | grep 'site_path' | cut -d: -f2 | awk '{ print $3}'`
    _THIS_HOSTMASTER=`echo $_THIS_HOSTMASTER | sed "s/[\,']//g"`
    #msg "_THIS_HOSTMASTER is $_THIS_HOSTMASTER - read from $_ROOT/.drush/hostmaster.alias.drushrc.php"
  else
    _THIS_HOSTMASTER="$_AEGIR_ROOT/sites/$_DOMAIN"
    #msg "_THIS_HOSTMASTER is read static $_THIS_HOSTMASTER"
  fi
fi
if [ -d "$_THIS_HOSTMASTER" ] ; then
  #msg "_THIS_HOSTMASTER is $_THIS_HOSTMASTER (1)"
  cd $_THIS_HOSTMASTER
else
  _THIS_HOSTMASTER="$_PREV_AEGIR_ROOT/sites/$_DOMAIN"
  #msg "_THIS_HOSTMASTER is $_THIS_HOSTMASTER (2)"
  cd $_THIS_HOSTMASTER
fi
cp -af /opt/tmp/$_BOA_REPO_NAME/aegir/helpers/make_platform.php.txt ./
mv -f make_platform.php.txt make_platform.php &> /dev/null
if [ -d "$_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_ACQUIA" acquia $_ROOT/distro/$_THIS_CORE/acquia-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_CIVICRM_M6" default $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M6-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_CIVICRM_M7" default $_ROOT/distro/$_THIS_CORE/civicrm-$_CIVICRM_M7-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_COD" cod $_ROOT/distro/$_THIS_CORE/cod-$_COD-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_COMMERCE" commerce $_ROOT/distro/$_THIS_CORE/commerce-$_COMMERCE-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/commerce-$_COM_MERCE-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/commerce-$_COM_MERCE-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_COM_MERCE" commerce $_ROOT/distro/$_THIS_CORE/commerce-$_COM_MERCE-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/commons-$_D6COMMONS-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/commons-$_D6COMMONS-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_D6COMMONS" drupal_commons $_ROOT/distro/$_THIS_CORE/commons-$_D6COMMONS-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/commons-$_D7COMMONS-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/commons-$_D7COMMONS-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_D7COMMONS" commons $_ROOT/distro/$_THIS_CORE/commons-$_D7COMMONS-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_D" default $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-dev &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_S" default $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-stage &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_P" default $_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod &> /dev/null
      mrun "sleep 3"
    fi
  fi
elif [ ! -d "$_ROOT/distro/$_THIS_CORE/pressflow-$_SMALLCORE6-prod" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/pressflow" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/pressflow/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL6_P" default $_ROOT/distro/$_THIS_CORE/pressflow &> /dev/null
      mrun "sleep 3"
    fi
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7D" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7D/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_D" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7D &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7S" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7S/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_S" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7S &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_P" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7P &> /dev/null
      mrun "sleep 3"
    fi
  fi
elif [ ! -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7P" ] ; then
  if [ -d "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7" ] ; then
    if [ ! -e "$_ROOT/distro/$_THIS_CORE/$_DRUPAL7/drushrc.php" ] ; then
      $_DRUSHCMD php-script make_platform "$_F_DRUPAL7_P" standard $_ROOT/distro/$_THIS_CORE/$_DRUPAL7 &> /dev/null
      mrun "sleep 3"
    fi
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL8" standard $_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL8 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL_EDGE_8" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL_EDGE_8/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_DRUPAL_EDGE_8" standard $_ROOT/distro/$_THIS_CORE/drupal-$_DRUPAL_EDGE_8 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_FSERVER" feature_server $_ROOT/distro/$_THIS_CORE/fserver-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_MANAGINGNEWS" managingnews $_ROOT/distro/$_THIS_CORE/managingnews-$_MANAGINGNEWS-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_NODESTREAM7" nodestream $_ROOT/distro/$_THIS_CORE/nodestream-$_NODESTREAM7-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openacademy-$_OPENACADEMY-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openacademy-$_OPENACADEMY-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENACADEMY" openacademy $_ROOT/distro/$_THIS_CORE/openacademy-$_OPENACADEMY-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM6-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM6-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENATRIUM6" openatrium $_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM6-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM7-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM7-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENATRIUM7" openatrium $_ROOT/distro/$_THIS_CORE/openatrium-$_OPENATRIUM7-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENCHURCH" openchurch $_ROOT/distro/$_THIS_CORE/openchurch-$_OPENCHURCH-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/opendeals-$_OPEN_DEALS-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/opendeals-$_OPEN_DEALS-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENDEALS" opendeals $_ROOT/distro/$_THIS_CORE/opendeals-$_OPEN_DEALS-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENOUTREACH" openoutreach $_ROOT/distro/$_THIS_CORE/openoutreach-$_OPENOUTREACH-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENPUBLISH" openpublish $_ROOT/distro/$_THIS_CORE/openpublish-$_OPENPUBLISH-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_OPENSCHOLAR" openscholar $_ROOT/distro/$_THIS_CORE/openscholar-$_OPENSCHOLAR-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_PANOPOLY" panopoly $_ROOT/distro/$_THIS_CORE/panopoly-$_PANOPOLY-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_PROSEPOINT" prosepoint $_ROOT/distro/$_THIS_CORE/prosepoint-$_PROSEPOINT-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_UBERCART" uberdrupal $_ROOT/distro/$_THIS_CORE/ubercart-$_UBERCART-$_SMALLCORE6 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -d "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7" ] ; then
  if [ ! -e "$_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7/drushrc.php" ] ; then
    $_DRUSHCMD php-script make_platform "$_F_UBER_CART_SEVEN" acquia $_ROOT/distro/$_THIS_CORE/ubercart-$_UBER_CART_SEVEN-$_SMALLCORE7 &> /dev/null
    mrun "sleep 3"
  fi
fi
if [ -e "/var/run/aegir_upgrade.pid" ] ; then
  _PLATF_IMP=$(ls -la /data/u | grep $_USER | cut -d'>' -f2 | sort | uniq | awk '{ print $1}')
  for _PLATF in $_PLATF_IMP ; do
    if [[ $_PLATF =~ aegir ]] ; then
	  _FOUND_HM=YES
    else
      _PLATF_NAME=${_PLATF##*/}
      $_DRUSHCMD php-script make_platform "$_PLATF_NAME ($RANDOM)" default $_PLATF
      mrun "sleep 1"
    fi
  done
fi
rm -f make_platform.php

touch /opt/tmp/status-AegirSetupC-OK

###----------------------------------------###
###
###  Octopus Aegir Installer
###  Copyright (C) 2010-2013 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###----------------------------------------###
