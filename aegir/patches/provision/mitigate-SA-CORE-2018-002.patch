From 463624cb17a4130796f7271e9d4638a2c031c759 Mon Sep 17 00:00:00 2001
From: Adam Andrzej Jaworski <mem@tkm.cc>
Date: Sat, 14 Apr 2018 20:16:26 +0200
Subject: [PATCH] Issue #2960825 Add apache/nginx config to mitigate
 SA-CORE-2018-002

---
 http/Provision/Config/Apache/server.tpl.php |  8 ++++++++
 http/Provision/Config/Nginx/server.tpl.php  | 14 ++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/http/Provision/Config/Apache/server.tpl.php b/http/Provision/Config/Apache/server.tpl.php
index e6ea28ab..366a4d89 100644
--- a/http/Provision/Config/Apache/server.tpl.php
+++ b/http/Provision/Config/Apache/server.tpl.php
@@ -21,6 +21,14 @@ NameVirtualHost *:<?php print $http_port; ?>
   LoadModule rewrite_module modules/mod_rewrite.so
 </IfModule>
 
+# Mitigation for https://www.drupal.org/SA-CORE-2018-002
+<IfModule mod_rewrite.c>
+    RewriteEngine On
+    RewriteCond %{QUERY_STRING} (.*)(23value|23default_value|element_parents=%23)(.*) [NC]
+    RewriteCond %{REQUEST_METHOD} POST [NC]
+    RewriteRule ^.*$  - [R=403,L]
+</IfModule>
+
 <?php
 if (drush_get_option('provision_apache_conf_suffix', FALSE)) {
   $include_statement = 'IncludeOptional ';
diff --git a/http/Provision/Config/Nginx/server.tpl.php b/http/Provision/Config/Nginx/server.tpl.php
index dfefe8d1..7508d8ba 100644
--- a/http/Provision/Config/Nginx/server.tpl.php
+++ b/http/Provision/Config/Nginx/server.tpl.php
@@ -326,6 +326,20 @@ server {
 }
 <?php endif; ?>
 
+# Mitigation for https://www.drupal.org/SA-CORE-2018-002
+set $rce "ZZ";
+if ( $query_string ~* (23value|23default_value|element_parents=%23) ) {
+  set $rce "A";
+}
+
+if ( $request_method = POST ) {
+  set $rce "${rce}B";
+}
+
+if ( $rce = "AB" ) {
+  return 403;
+}
+
 #######################################################
 ###  nginx virtual domains
 #######################################################
-- 
2.15.1 (Apple Git-101)

